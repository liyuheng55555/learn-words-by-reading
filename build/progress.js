import{f as H,e as d}from"./chunks/html.js";const M=localStorage.getItem("score-api-url")||"http://localhost:4000",L=document.getElementById("progress-status"),N=document.getElementById("progress-body"),V=document.getElementById("progress-search"),X=document.getElementById("score-filter"),Y=document.getElementById("status-filter"),W=document.getElementById("refresh-progress"),S=document.querySelector(".progress-table thead"),B=document.getElementById("context-panel"),q=document.getElementById("context-title"),I=document.getElementById("context-list"),C=document.getElementById("context-empty"),j=document.getElementById("context-close"),G=document.getElementById("progress-summary"),y=document.getElementById("toggle-meaning"),U=document.querySelector(".progress-table"),_=document.querySelector(".progress-table table"),z=document.getElementById("add-word-form"),h=document.getElementById("new-term"),T=document.getElementById("new-meaning"),f=document.getElementById("add-word-status");let l=[],k="order",x=!0;const v=new Map;let $="",E=!0,R=!1;function u(t,e="info"){L&&(L.classList.remove("ok","warn"),e==="ok"&&L.classList.add("ok"),e==="warn"&&L.classList.add("warn"),L.textContent=t||"")}function m(t,e="info"){f&&(f.textContent=t||"",f.classList.remove("ok","error","warn"),t&&(e==="ok"&&f.classList.add("ok"),e==="error"&&f.classList.add("error"),e==="warn"&&f.classList.add("warn")))}function se(t){const e=Number(t);return Number.isFinite(e)?e===999?"999 (已掌握)":e.toFixed(2):"0.00"}function K(t){if(!t)return"-";const e=new Date(t);return Number.isNaN(e.getTime())?t:e.toLocaleString()}function F(t){const e=V.value.trim().toLowerCase(),s=Number(X.value),n=Number.isFinite(s),r=Y.value,o=t.filter(a=>{const i=a.term||"",c=typeof a.meaning=="string"?a.meaning:"",p=Number(a.score)||0,b=Number(a.submissions)||0;return!(e&&!`${i} ${c}`.toLowerCase().includes(e)||n&&p>s||r==="fresh"&&b>0||r==="mastered"&&p!==999||r==="learning"&&(b===0||p>=999))});return re(o)}function re(t){const e=[...t],s=k,n=x?1:-1;return e.sort((r,o)=>{switch(s){case"term":return r.term.localeCompare(o.term,"en",{sensitivity:"base"})*n;case"meaning":{const a=typeof r.meaning=="string"?r.meaning:"",i=typeof o.meaning=="string"?o.meaning:"";return a.localeCompare(i,"zh",{sensitivity:"base"})*n}case"score":{const a=(Number(r.score)||0)-(Number(o.score)||0);return a===0?r.term.localeCompare(o.term)*n:a*n}case"submissions":{const a=(Number(r.submissions)||0)-(Number(o.submissions)||0);return a===0?r.term.localeCompare(o.term)*n:a*n}case"last_submission":{const a=J(r.last_submission),i=J(o.last_submission),c=a-i;return c===0?r.term.localeCompare(o.term)*n:c*n}case"order":default:{const a=(Number(r._order)||0)-(Number(o._order)||0);return a===0?r.term.localeCompare(o.term)*n:a*n}}}),e}function J(t){if(!t)return Number.NEGATIVE_INFINITY;const s=new Date(t).getTime();return Number.isNaN(s)?Number.NEGATIVE_INFINITY:s}function Q(t){if(!t||typeof t.term!="string")return;const e=t.term,s=Array.isArray(t.recent_contexts)?t.recent_contexts.slice(0,3):[],n=l.findIndex(r=>r.term===e);if(n>=0){const r=Number.isFinite(l[n]._order)?l[n]._order:n;l[n]={...t,_order:r}}else{const r=Number.isFinite(t._order)?t._order:l.length;l.push({...t,_order:r})}v.set(e,s)}function oe(t){if(!t||typeof t!="string")return;const e=t.trim();if(!e)return;const s=l.filter(n=>n&&n.term!==e);s.length!==l.length&&(l=s,v.delete(e),$===e&&te())}function A(){const t=!E;if(U&&U.classList.toggle("hide-meaning",t),_){_.classList.toggle("hide-meaning",t);const e=_.querySelector("th.meaning-col");e instanceof HTMLElement&&(e.style.display=t?"none":""),_.querySelectorAll("td.meaning-cell").forEach(n=>{n instanceof HTMLElement&&(n.style.display=t?"none":"")})}y&&y.checked!==E&&(y.checked=E)}function Z(t){if(N){if(!t.length){N.innerHTML='<tr><td class="empty" colspan="7">未找到匹配的词汇。</td></tr>',A();return}N.innerHTML=t.map(e=>{const s=e.term||"",n=Number(e.score)||0,r=Number(e.submissions)||0,o=e.last_submission,a=Number(e._order),i=typeof e.meaning=="string"&&e.meaning.trim()?e.meaning.trim():"",b=(v.get(s)||[]).length>0?' <span class="context-indicator" title="查看最近语境">语境</span>':"",D=`<button type="button" class="term-context-btn" data-term="${d(s)}">${d(s)}${b}</button>`,ne=E?d(i||"—"):"";return`
      <tr class="${n>=999?"status-mastered":r===0?"status-fresh":""}">
        <td>${Number.isFinite(a)?a+1:""}</td>
        <td>${D}</td>
        <td class="meaning-cell"${E?"":' style="display:none"'}>${ne}</td>
        <td>${se(n)}</td>
        <td>${r}</td>
        <td>${d(K(o))}</td>
        <td class="actions">
          <button data-term="${d(s)}" data-action="mastered" class="mark-btn mastered">标记已掌握</button>
          <button data-term="${d(s)}" data-action="reset" class="mark-btn reset">重置未练习</button>
          <button data-term="${d(s)}" data-action="delete" class="mark-btn delete">删除词汇</button>
        </td>
      </tr>
    `}).join(""),A()}}function ee(t){if(!G)return;const e=t.filter(i=>Number(i.submissions)>0),s=e.length,n=e.filter(i=>Number(i.score)<0).length,r=e.filter(i=>{const c=Number(i.score)||0;return c>=0&&c<2}).length,o=e.filter(i=>{const c=Number(i.score)||0;return c>=2&&c<999}).length,a=e.filter(i=>Number(i.score)>=999).length;G.innerHTML=`
    <div class="summary-item">
      <span class="summary-label">练习总数</span>
      <span class="summary-value">${s}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">分数 &lt; 0</span>
      <span class="summary-value">${n}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">0–2 分</span>
      <span class="summary-value">${r}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">≥ 2 分</span>
      <span class="summary-value">${o}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">已掌握</span>
      <span class="summary-value">${a}</span>
    </div>
  `}function O(t){const e=typeof t=="string"?t.trim():"";if(!e)return;const s=v.get(e)||[];if(!B||!q||!I){const r=s.length?s.map((o,a)=>`${a+1}. ${o.sentence}`).join(`
`):"暂无语境记录";alert(`「${e}」的最近语境：
${r}`);return}$=e,q.textContent=`「${e}」最近语境`,I.innerHTML="",C&&C.classList.add("hidden");const n=s.slice(0,3);if(!n.length)C?C.classList.remove("hidden"):I.innerHTML='<li class="empty">暂无语境记录</li>';else{const r=n.map((o,a)=>{const i=typeof o?.sentence=="string"?o.sentence:"",c=typeof o?.created_at=="string"?o.created_at:"",p=c?K(c):"",b=p?`<div class="context-meta">${d(p)}</div>`:"";return`
        <li>
          <div class="context-order">${a+1}.</div>
          <div class="context-sentence">${d(i)}</div>
          ${b}
        </li>
      `}).join("");I.innerHTML=r}B.classList.remove("hidden")}function te(){B&&(B.classList.add("hidden"),$="")}async function w(){try{u("正在加载词汇数据…","info");const t=`${M.replace(/\/$/,"")}/api/word-scores`,e=await H(t),s=Array.isArray(e?.scores)?e.scores:[];v.clear(),s.forEach(n=>{if(!n||typeof n.term!="string")return;const r=n.term,o=Array.isArray(n.recent_contexts)?n.recent_contexts.slice(0,3):[];v.set(r,o)}),l=s.map((n,r)=>({...n,_order:r})),P(),Z(F(l)),$&&O($),u(`已加载 ${l.length} 个词汇`,"ok"),ee(F(l))}catch(t){console.error("[Progress] 获取词汇失败",t),u(`加载失败：${t.message}`,"warn"),N.innerHTML='<tr><td class="empty" colspan="7">无法加载词汇数据。</td></tr>'}}async function ae(t,e){try{u(`正在更新「${t}」…`,"info");const s=`${M.replace(/\/$/,"")}/api/word-status`,n=await H(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({term:t,action:e})});n?.record?(Q(n.record),g(),$===n.record.term&&O(n.record.term),u(`已更新「${t}」`,"ok")):await w()}catch(s){console.error("[Progress] 更新词汇失败",s),u(`更新失败：${s.message}`,"warn")}}async function ie(t){const e=typeof t=="string"?t.trim():"";if(!(!e||!(!(typeof window<"u")||window.confirm(`确定要删除「${e}」吗？删除后该词汇的分数和语境记录将被移除。`))))try{u(`正在删除「${e}」…`,"info");const n=`${M.replace(/\/$/,"")}/api/words/${encodeURIComponent(e)}`;(await H(n,{method:"DELETE"}))?.deleted?(oe(e),g(),u(`已删除「${e}」`,"ok")):await w()}catch(n){console.error("[Progress] 删除词汇失败",n),u(`删除失败：${n.message}`,"warn")}}async function ce(t,e){if(!h||!T)return;const s=typeof t=="string"?t.trim():"",n=typeof e=="string"?e.trim():"";if(!s){m("请输入英文词汇","error"),h.focus();return}if(!n){m("请输入对应的中文释义","error"),T.focus();return}if(R){m("正在添加，请稍候…");return}try{R=!0,m(`正在添加「${s}」…`);const r=`${M.replace(/\/$/,"")}/api/words`,o=await H(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({term:s,meaning:n})});o?.record?(Q(o.record),g(),m(`已添加「${s}」`,"ok"),h.value="",T.value="",h.focus()):(m("添加成功，但未返回词汇记录","warn"),await w())}catch(r){const o=r?.message||"添加失败";o.includes("UNIQUE")||o.includes("已存在")||o.includes("409")?m("该词汇已存在，无需重复添加","error"):m(`添加失败：${o}`,"error"),console.error("[Progress] 添加词汇失败",r)}finally{R=!1}}function g(){const t=F(l);Z(t),ee(t)}y&&(E=!!y.checked,A(),y.addEventListener("change",()=>{E=y.checked,A(),g()}));z&&(z.addEventListener("submit",t=>{t.preventDefault(),ce(h?.value??"",T?.value??"")}),[h,T].forEach(t=>{t&&t.addEventListener("input",()=>{f&&f.textContent&&m("")})}));V.addEventListener("input",g);X.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),g())});Y.addEventListener("change",g);S&&S.addEventListener("click",t=>{const e=t.target;if(!(e instanceof HTMLElement))return;const s=e.closest("th");if(!s)return;const n=s.dataset.sort;n&&(k===n?x=!x:(k=n,x=!0),P(),g())});function P(){if(!S)return;S.querySelectorAll("th").forEach(e=>{const s=e.dataset.sort;if(!s){e.classList.remove("sortable","active"),e.removeAttribute("data-indicator");return}e.classList.add("sortable"),s===k?(e.classList.add("active"),e.dataset.indicator=x?"↑":"↓"):(e.classList.remove("active"),e.dataset.indicator="")})}N.addEventListener("click",t=>{const e=t.target;if(!(e instanceof HTMLElement))return;const s=e.closest(".term-context-btn");if(s){const a=s.dataset.term;a&&O(a);return}const n=e.closest(".mark-btn");if(!n)return;const r=n.dataset.term,o=n.dataset.action;r&&o&&(o==="delete"?ie(r):ae(r,o))});W&&W.addEventListener("click",()=>{w()});j&&j.addEventListener("click",te);w();P();
