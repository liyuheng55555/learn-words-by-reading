import{f as H,e as C}from"./chunks/html.js";function V(e){if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}const $=document.getElementById("history-status"),g=document.getElementById("history-session-list"),P=document.getElementById("history-refresh"),p=document.getElementById("history-score-api"),A=document.getElementById("history-detail-empty"),B=document.getElementById("history-detail-content"),Q=document.getElementById("history-detail-title"),X=document.getElementById("history-detail-meta"),O=document.getElementById("history-article"),R=document.getElementById("history-results-body"),z=document.getElementById("history-open-session"),d=document.getElementById("history-copy-low"),I=document.getElementById("history-results-head"),E=document.getElementById("history-chart"),w=document.getElementById("history-chart-empty"),T=new Map;let m=[],M=[],L="term",v=!0,x=[];function f(e,t="info"){$&&($.textContent=e||"",$.classList.remove("ok","warn"),t==="ok"&&$.classList.add("ok"),t==="warn"&&$.classList.add("warn"))}function k(){const e=p?.value?.trim();if(e)return localStorage.setItem("score-api-url",e),e;const t=localStorage.getItem("score-api-url");if(t)return p&&(p.value=t),t;const s="http://localhost:4000";return p&&(p.value=s),s}function Z(e){return Number.isFinite(e)?e>=.85?"correct":e>=.6?"partial":"incorrect":"unknown"}function tt(e){if(!g)return;if(!Array.isArray(e)||!e.length){g.innerHTML='<li class="history-session-item empty">暂无历史记录，请先同步一次判题结果。</li>';return}const t=e.map(s=>{const r=V(s.submitted_at),n=Number(s.incorrect_terms)||0,o=Number(s.partial_terms)||0,c=Number(s.total_terms)||0,a=Number(s.avg_similarity),i=Number.isFinite(a)?a.toFixed(2):"—",y=n>0?"warn":"ok";return`
      <li class="history-session-item" data-id="${s.id}">
        <button type="button" class="history-session-button">
          <div class="history-session-row">
            <span class="history-session-id">#${s.id}</span>
            <span class="history-session-date">${C(r)}</span>
          </div>
          <div class="history-session-row small ${y}">
            <span>词数：${c}</span>
            <span>错误：${n}</span>
            <span>部分正确：${o}</span>
            <span>平均：${i}</span>
          </div>
        </button>
      </li>
    `}).join("");g.innerHTML=t}async function q({autoSelect:e=!1}={}){try{f("正在载入历史记录…","info");const s=`${k().replace(/\/$/,"")}/api/sessions?limit=100`,r=await H(s),n=Array.isArray(r?.sessions)?r.sessions:[];tt(n),f(`已载入 ${n.length} 条历史记录`,"ok"),e&&n.length&&G(Number(n[0].id))}catch(t){console.error("[History] 获取历史记录失败:",t),f(`加载失败：${t.message}`,"warn"),g.innerHTML='<li class="history-session-item empty warn">无法加载历史记录。</li>'}}async function J(e=7){try{const s=`${k().replace(/\/$/,"")}/api/stats/daily?days=${encodeURIComponent(e)}`,r=await H(s),n=Array.isArray(r?.stats)?r.stats:[];x=nt(n,e),w&&w.classList.toggle("hidden",x.some(o=>o.practiced||o.below_zero||o.above_two)),Y(x)}catch(t){console.error("[History] 获取每日统计失败:",t),w&&(w.classList.remove("hidden"),w.textContent=`无法加载趋势数据：${t.message}`)}}function et(e=""){return typeof e!="string"||!e.trim()?"<p>（无文章内容记录）</p>":e.split(/\n\n+/).map(r=>`<p>${r.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function st(e){const t=Array.isArray(e)?[...e]:[],s=v?1:-1;return t.sort((r,n)=>{switch(L){case"similarity":{const o=Number(r?.similarity),c=Number(n?.similarity),a=Number.isFinite(o),i=Number.isFinite(c);return!a&&!i?0:a?i?o===c?(r.term||"").localeCompare(n.term||"")*s:(o-c)*s:-1*s:1*s}case"standard":{const o=(r?.standard_answer||r?.standardAnswer||"").toString(),c=(n?.standard_answer||n?.standardAnswer||"").toString(),a=o.localeCompare(c,"zh",{sensitivity:"base"});return a===0?(r.term||"").localeCompare(n.term||"")*s:a*s}case"explanation":{const o=(r?.explanation||"").toString(),c=(n?.explanation||"").toString(),a=o.localeCompare(c,"zh",{sensitivity:"base"});return a===0?(r.term||"").localeCompare(n.term||"")*s:a*s}case"term":default:return(r?.term||"").localeCompare(n?.term||"","en",{sensitivity:"base"})*s}}),t}function U(){if(!I)return;I.querySelectorAll("th[data-sort]").forEach(t=>{const s=t.dataset.sort;s&&(t.classList.add("sortable"),s===L?(t.classList.add("active"),t.dataset.indicator=v?"↑":"↓"):(t.classList.remove("active"),t.dataset.indicator=""))})}function K(){if(!R)return;const e=st(M);if(!e.length){R.innerHTML='<tr><td colspan="4" class="empty">未记录判题结果。</td></tr>',m=[],d&&(d.disabled=!0,d.textContent="复制 ≤0.5 词"),U();return}const t=e.map(s=>{const r=C(s.term),n=typeof s.similarity=="number"?s.similarity:Number(s.similarity),o=Number.isFinite(n)?n.toFixed(2):"—",c=Z(Number.isFinite(n)?n:NaN),a=C(s.standard_answer||s.standardAnswer||""),i=C(s.explanation||"");return`
      <tr class="history-result-${c}">
        <td>${r||"—"}</td>
        <td>${o}</td>
        <td>${a||"—"}</td>
        <td>${i||"—"}</td>
      </tr>
    `}).join("");R.innerHTML=t,m=e.filter(s=>{if(!s||typeof s.term!="string")return!1;const r=typeof s.similarity=="number"?s.similarity:Number(s.similarity);return Number.isFinite(r)&&r<=.5}).map(s=>s.term.trim()).filter(Boolean),d&&(m.length?(d.disabled=!1,d.textContent=`复制 ≤0.5 词 (${m.length})`):(d.disabled=!0,d.textContent="暂无低分词")),U()}function rt(e){if(!e)return null;const t=window.devicePixelRatio||1,s=e.getBoundingClientRect();e.width=s.width*t,e.height=s.height*t;const r=e.getContext("2d");return r&&r.scale(t,t),r}function Y(e){if(!E)return;const t=rt(E);if(!t)return;if(!e||!e.length){t.clearRect(0,0,E.width,E.height),w&&w.classList.remove("hidden");return}const s=E.getBoundingClientRect().width,r=E.getBoundingClientRect().height;t.clearRect(0,0,s,r);const n=e.map(l=>l.day),o=e.map(l=>Number(l.below_zero)||0),c=e.map(l=>Number(l.above_two)||0),a=Math.max(5,...o,...c),i={top:16,right:24,bottom:32,left:40},y=s-i.left-i.right,u=r-i.top-i.bottom;t.strokeStyle="rgba(147, 161, 161, 0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(i.left,i.top),t.lineTo(i.left,i.top+u),t.lineTo(i.left+y,i.top+u),t.stroke();const D=Math.min(4,a);t.fillStyle="var(--muted)",t.font="12px sans-serif";for(let l=0;l<=D;l++){const b=Math.round(a/D*l),h=i.top+u-u*(b/a);t.fillText(String(b),6,h+4),t.strokeStyle="rgba(147, 161, 161, 0.15)",t.beginPath(),t.moveTo(i.left,h),t.lineTo(i.left+y,h),t.stroke()}n.forEach((l,b)=>{const h=i.left+y/Math.max(1,n.length-1)*b,S=i.top+u+16;t.fillStyle="var(--muted)",t.fillText(l.slice(5),h-18,S)});function F(l,b){t.strokeStyle=b,t.lineWidth=2,t.beginPath(),l.forEach((h,S)=>{const N=i.left+y/Math.max(1,l.length-1)*S,_=i.top+u-u*(h/a);S===0?t.moveTo(N,_):t.lineTo(N,_)}),t.stroke(),l.forEach((h,S)=>{const N=i.left+y/Math.max(1,l.length-1)*S,_=i.top+u-u*(h/a);t.fillStyle=b,t.beginPath(),t.arc(N,_,3,0,Math.PI*2),t.fill()})}F(o,"#dc322f"),F(c,"#859900")}function nt(e,t=7){const s=new Date,r=[];for(let n=t-1;n>=0;n--){const o=new Date(s);o.setDate(s.getDate()-n);const c=o.toISOString().slice(0,10),a=e.find(i=>i.day===c);a?r.push(a):r.push({day:c,practiced:0,below_zero:0,above_two:0})}return r}function W(e){if(!B||!A)return;if(!e||!e.session){m=[],d&&(d.disabled=!0,d.textContent="复制 ≤0.5 词"),B.classList.add("hidden"),A.classList.remove("hidden");return}A.classList.add("hidden"),B.classList.remove("hidden");const{session:t,results:s}=e,r=V(t.submitted_at),n=Number(t.total_terms)||(Array.isArray(s)?s.length:0),o=Number(t.avg_similarity),c=Number.isFinite(o)?o.toFixed(2):"—",a=Number(t.correct_terms)||0,i=Number(t.partial_terms)||0,y=Number(t.incorrect_terms)||0;if(Q.textContent=`历史记录 #${t.id}`,X.textContent=`提交时间：${r} ｜ 总词数：${n} ｜ 平均相似度：${c} ｜ 正确/部分/错误：${a}/${i}/${y}`,z&&(z.href=`geo_vocab_fill_in_webpage_english→chinese.html?session=${t.id}`),O){const u=et(t.article||"");O.innerHTML=u}L="term",v=!0,M=Array.isArray(s)?[...s]:[],K()}async function G(e){if(!Number.isInteger(e)||e<=0)return;Array.from(g?.querySelectorAll(".history-session-item.active")||[]).forEach(s=>{s.classList.remove("active")});const t=g?.querySelector(`.history-session-item[data-id="${e}"]`);if(t&&t.classList.add("active"),T.has(e)){W(T.get(e));return}try{f(`正在加载记录 #${e}…`,"info");const r=`${k().replace(/\/$/,"")}/api/sessions/${e}`,n=await H(r);T.set(e,n),W(n),f(`已加载记录 #${e}`,"ok")}catch(s){console.error("[History] 加载详情失败:",s),f(`加载记录 #${e} 失败：${s.message}`,"warn")}}p&&p.addEventListener("change",()=>{const e=p.value.trim();e&&localStorage.setItem("score-api-url",e),J(7)});P&&P.addEventListener("click",()=>{T.clear(),q({autoSelect:!1})});g&&g.addEventListener("click",e=>{const t=e.target.closest(".history-session-item");if(!t)return;const s=Number(t.dataset.id);Number.isInteger(s)&&G(s)});I&&I.addEventListener("click",e=>{const t=e.target.closest("th[data-sort]");if(!t)return;const s=t.dataset.sort;s&&M.length&&(L===s?v=!v:(L=s,v=!0),K())});window.addEventListener("resize",()=>{x.length&&Y(x)});function j(e){const t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="fixed",t.style.top="-9999px",document.body.appendChild(t),t.select();let s=!1;try{s=document.execCommand("copy")}catch{s=!1}return document.body.removeChild(t),s}async function it(){if(!Array.isArray(m)||!m.length){f("当前记录没有相似度 ≤0.5 的词汇","warn");return}const e=m.join(", ");try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(e);else if(!j(e))throw new Error("无法访问剪贴板");f(`已复制 ${m.length} 个词汇到剪贴板`,"ok")}catch(t){j(e)?f(`已复制 ${m.length} 个词汇到剪贴板`,"ok"):f(`复制失败：${t.message}`,"warn")}}d&&d.addEventListener("click",it);k();J(7);q({autoSelect:!0});
