const f="grading-history-records";function c(){return typeof window<"u"&&typeof window.localStorage<"u"}function N(t){try{const n=JSON.parse(t);return Array.isArray(n)?n:[]}catch(n){return console.warn("[HistoryStorage] Failed to parse stored value:",n),[]}}function a(){if(!c())return[];const t=window.localStorage.getItem(f);return t?N(t).map(y).filter(Boolean):[]}function g(t){if(!c())return;const n=Array.isArray(t)?t.map(y).filter(Boolean):[];window.localStorage.setItem(f,JSON.stringify(n.slice(0,50))),p()}function p(){typeof window>"u"||typeof window.dispatchEvent!="function"||window.dispatchEvent(new CustomEvent("grading-history-updated"))}function y(t){if(!t||typeof t!="object")return null;const n=typeof t.id=="string"&&t.id.trim()?t.id.trim():null;if(!n)return null;const r=typeof t.createdAt=="string"&&t.createdAt?t.createdAt:new Date().toISOString(),e=typeof t.article=="string"?t.article:"",i=d(t.summary),u=m(t.results),s=t.status==="submitted"?"submitted":"pending",o=Number.isInteger(t.sessionId)?t.sessionId:null,l=typeof t.submittedAt=="string"&&t.submittedAt?t.submittedAt:null,A=t.scored===!0;return{id:n,createdAt:r,article:e,summary:i,results:u,status:s,sessionId:o,submittedAt:l,scored:A}}function d(t){if(!t||typeof t!="object")return{total:0,correct:0,partial:0,incorrect:0,avg:null};const n=l=>Number.isFinite(l)?l:Number(l),r=Number.isFinite(t.total)?t.total:Math.max(0,Number(t.total)||0),e=Number.isFinite(t.correct)?t.correct:Math.max(0,Number(t.correct)||0),i=Number.isFinite(t.partial)?t.partial:Math.max(0,Number(t.partial)||0),u=Number.isFinite(t.incorrect)?t.incorrect:Math.max(0,Number(t.incorrect)||0),s=n(t.avg),o=Number.isFinite(s)?s:null;return{total:r,correct:e,partial:i,incorrect:u,avg:o}}function m(t){return Array.isArray(t)?t.map(n=>{if(!n||typeof n!="object")return null;const r=typeof n.term=="string"?n.term.trim():"";if(!r)return null;const e=Number(n.similarity),i=Number.isFinite(e)?e:null,u=typeof n.standard_answer=="string"?n.standard_answer:typeof n.standardAnswer=="string"?n.standardAnswer:null,s=typeof n.explanation=="string"?n.explanation:null,o=typeof n.context=="string"?n.context:null;return{term:r,similarity:i,standard_answer:u,explanation:s,context:o}}).filter(Boolean):[]}function I(){const t=Math.random().toString(36).slice(2,10);return`gh_${Date.now()}_${t}`}function R(){return a().sort((n,r)=>{const e=new Date(n.submittedAt||n.createdAt).getTime(),i=new Date(r.submittedAt||r.createdAt).getTime();return Number.isFinite(i)?i-e:0}).slice(0,50)}function h({article:t="",summary:n={},results:r=[]}={}){if(!c())return null;const e=d(n),i=m(r);if(!i.length)return null;const u=a(),s={id:I(),createdAt:new Date().toISOString(),article:typeof t=="string"?t:"",summary:e,results:i,status:"pending",sessionId:null,submittedAt:null,scored:!1},o=[s,...u].slice(0,50);return g(o),s}function b(t,n={}){if(!c()||!t)return null;const r=a();let e=!1;const i=r.map(u=>{if(u.id!==t)return u;const s={...u};if("article"in n&&typeof n.article=="string"&&(s.article=n.article),"summary"in n&&n.summary&&(s.summary=d(n.summary)),"results"in n&&Array.isArray(n.results)){const o=m(n.results);o.length&&(s.results=o)}if(typeof n.status=="string"&&(n.status==="pending"||n.status==="submitted")&&(s.status=n.status),"sessionId"in n){const o=Number(n.sessionId);s.sessionId=Number.isInteger(o)&&o>0?o:null}return"submittedAt"in n&&(s.submittedAt=typeof n.submittedAt=="string"&&n.submittedAt?n.submittedAt:null),"scored"in n&&(s.scored=!!n.scored),e=!0,s});return e&&g(i),e?S(t):null}function x(t,n={}){if(!c()||!t)return null;const{sessionId:r=null,submittedAt:e=new Date().toISOString()}=n,i=Number(r);return b(t,{status:"submitted",sessionId:Number.isInteger(i)&&i>0?i:null,submittedAt:e})}function D(t,n={}){if(!c()||!t)return null;const{sessionId:r=null}=n,e=Number(r);return b(t,{scored:!0,sessionId:Number.isInteger(e)&&e>0?e:null})}function S(t){return!c()||!t?null:a().find(r=>r.id===t)||null}export{D as a,h as b,R as l,x as m};
