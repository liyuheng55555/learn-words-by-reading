import{f as D,e as T}from"./chunks/html.js";function J(e){if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}const x=document.getElementById("history-status"),g=document.getElementById("history-session-list"),z=document.getElementById("history-refresh"),p=document.getElementById("history-score-api"),R=document.getElementById("history-detail-empty"),M=document.getElementById("history-detail-content"),Z=document.getElementById("history-detail-title"),tt=document.getElementById("history-detail-meta"),U=document.getElementById("history-article"),H=document.getElementById("history-results-body"),j=document.getElementById("history-open-session"),u=document.getElementById("history-copy-low"),A=document.getElementById("history-results-head"),E=document.getElementById("history-chart"),w=document.getElementById("history-chart-empty"),I=document.getElementById("history-toggle-meaning"),k=new Map;let f=[],F=[],N="term",v=!0,$=[],L=!0;function y(e,t="info"){x&&(x.textContent=e||"",x.classList.remove("ok","warn"),t==="ok"&&x.classList.add("ok"),t==="warn"&&x.classList.add("warn"))}function B(){const e=p?.value?.trim();if(e)return localStorage.setItem("score-api-url",e),e;const t=localStorage.getItem("score-api-url");if(t)return p&&(p.value=t),t;const s="http://localhost:4000";return p&&(p.value=s),s}function et(e){return Number.isFinite(e)?e>=.85?"correct":e>=.6?"partial":"incorrect":"unknown"}function st(e){if(!g)return;if(!Array.isArray(e)||!e.length){g.innerHTML='<li class="history-session-item empty">暂无历史记录，请先同步一次判题结果。</li>';return}const t=e.map(s=>{const n=J(s.submitted_at),r=Number(s.incorrect_terms)||0,i=Number(s.partial_terms)||0,c=Number(s.total_terms)||0,a=Number(s.avg_similarity),o=Number.isFinite(a)?a.toFixed(2):"—",m=r>0?"warn":"ok";return`
      <li class="history-session-item" data-id="${s.id}">
        <button type="button" class="history-session-button">
          <div class="history-session-row">
            <span class="history-session-id">#${s.id}</span>
            <span class="history-session-date">${T(n)}</span>
          </div>
          <div class="history-session-row small ${m}">
            <span>词数：${c}</span>
            <span>错误：${r}</span>
            <span>部分正确：${i}</span>
            <span>平均：${o}</span>
          </div>
        </button>
      </li>
    `}).join("");g.innerHTML=t}async function K({autoSelect:e=!1}={}){try{y("正在载入历史记录…","info");const s=`${B().replace(/\/$/,"")}/api/sessions?limit=100`,n=await D(s),r=Array.isArray(n?.sessions)?n.sessions:[];st(r),y(`已载入 ${r.length} 条历史记录`,"ok"),e&&r.length&&X(Number(r[0].id))}catch(t){console.error("[History] 获取历史记录失败:",t),y(`加载失败：${t.message}`,"warn"),g.innerHTML='<li class="history-session-item empty warn">无法加载历史记录。</li>'}}async function Y(e=7){try{const s=`${B().replace(/\/$/,"")}/api/stats/daily?days=${encodeURIComponent(e)}`,n=await D(s),r=Array.isArray(n?.stats)?n.stats:[];$=it(r,e),w&&w.classList.toggle("hidden",$.some(i=>i.practiced||i.below_zero||i.above_two)),Q($)}catch(t){console.error("[History] 获取每日统计失败:",t),w&&(w.classList.remove("hidden"),w.textContent=`无法加载趋势数据：${t.message}`)}}function nt(e=""){return typeof e!="string"||!e.trim()?"<p>（无文章内容记录）</p>":e.split(/\n\n+/).map(n=>`<p>${n.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function rt(e){const t=Array.isArray(e)?[...e]:[],s=v?1:-1;return t.sort((n,r)=>{switch(N){case"similarity":{const i=Number(n?.similarity),c=Number(r?.similarity),a=Number.isFinite(i),o=Number.isFinite(c);return!a&&!o?0:a?o?i===c?(n.term||"").localeCompare(r.term||"")*s:(i-c)*s:-1*s:1*s}case"standard":{const i=(n?.standard_answer||n?.standardAnswer||"").toString(),c=(r?.standard_answer||r?.standardAnswer||"").toString(),a=i.localeCompare(c,"zh",{sensitivity:"base"});return a===0?(n.term||"").localeCompare(r.term||"")*s:a*s}case"explanation":{const i=(n?.explanation||"").toString(),c=(r?.explanation||"").toString(),a=i.localeCompare(c,"zh",{sensitivity:"base"});return a===0?(n.term||"").localeCompare(r.term||"")*s:a*s}case"term":default:return(n?.term||"").localeCompare(r?.term||"","en",{sensitivity:"base"})*s}}),t}function V(){if(!A)return;A.querySelectorAll("th[data-sort]").forEach(t=>{const s=t.dataset.sort;s&&(t.classList.add("sortable"),s===N?(t.classList.add("active"),t.dataset.indicator=v?"↑":"↓"):(t.classList.remove("active"),t.dataset.indicator=""))})}function O(){if(!H)return;const e=rt(F);if(!e.length){H.innerHTML='<tr><td colspan="4" class="empty">未记录判题结果。</td></tr>',f=[],u&&(u.disabled=!0,u.textContent="复制 ≤0.5 词"),V();return}const t=e.map(s=>{const n=T(s.term),r=typeof s.similarity=="number"?s.similarity:Number(s.similarity),i=Number.isFinite(r)?r.toFixed(2):"—",c=et(Number.isFinite(r)?r:NaN),a=s.standard_answer||s.standardAnswer||"",o=s.explanation||"",m=L?T(a):"—",d=L?T(o):"—";return`
      <tr class="history-result-${c}">
        <td>${n||"—"}</td>
        <td>${i}</td>
        <td>${m||"—"}</td>
        <td>${d||"—"}</td>
      </tr>
    `}).join("");H.innerHTML=t,f=e.filter(s=>{if(!s||typeof s.term!="string")return!1;const n=typeof s.similarity=="number"?s.similarity:Number(s.similarity);return Number.isFinite(n)&&n<=.5}).map(s=>s.term.trim()).filter(Boolean),u&&(f.length?(u.disabled=!1,u.textContent=`复制 ≤0.5 词 (${f.length})`):(u.disabled=!0,u.textContent="暂无低分词")),V()}function ot(e){if(!e)return null;const t=window.devicePixelRatio||1,s=e.getBoundingClientRect();e.width=s.width*t,e.height=s.height*t;const n=e.getContext("2d");return n&&n.scale(t,t),n}function Q(e){if(!E)return;const t=ot(E);if(!t)return;if(!e||!e.length){t.clearRect(0,0,E.width,E.height),w&&w.classList.remove("hidden");return}const s=E.getBoundingClientRect().width,n=E.getBoundingClientRect().height;t.clearRect(0,0,s,n);const r=e.map(l=>l.day),i=e.map(l=>Number(l.below_zero)||0),c=e.map(l=>Number(l.above_two)||0),a=Math.max(5,...i,...c),o={top:16,right:24,bottom:32,left:40},m=s-o.left-o.right,d=n-o.top-o.bottom;t.strokeStyle="rgba(147, 161, 161, 0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(o.left,o.top),t.lineTo(o.left,o.top+d),t.lineTo(o.left+m,o.top+d),t.stroke();const P=Math.min(4,a);t.fillStyle="var(--muted)",t.font="12px sans-serif";for(let l=0;l<=P;l++){const b=Math.round(a/P*l),h=o.top+d-d*(b/a);t.fillText(String(b),6,h+4),t.strokeStyle="rgba(147, 161, 161, 0.15)",t.beginPath(),t.moveTo(o.left,h),t.lineTo(o.left+m,h),t.stroke()}r.forEach((l,b)=>{const h=o.left+m/Math.max(1,r.length-1)*b,S=o.top+d+16;t.fillStyle="var(--muted)",t.fillText(l.slice(5),h-18,S)});function W(l,b){t.strokeStyle=b,t.lineWidth=2,t.beginPath(),l.forEach((h,S)=>{const _=o.left+m/Math.max(1,l.length-1)*S,C=o.top+d-d*(h/a);S===0?t.moveTo(_,C):t.lineTo(_,C)}),t.stroke(),l.forEach((h,S)=>{const _=o.left+m/Math.max(1,l.length-1)*S,C=o.top+d-d*(h/a);t.fillStyle=b,t.beginPath(),t.arc(_,C,3,0,Math.PI*2),t.fill()})}W(i,"#dc322f"),W(c,"#859900")}function it(e,t=7){const s=new Date,n=[];for(let r=t-1;r>=0;r--){const i=new Date(s);i.setDate(s.getDate()-r);const c=i.toISOString().slice(0,10),a=e.find(o=>o.day===c);a?n.push(a):n.push({day:c,practiced:0,below_zero:0,above_two:0})}return n}function q(e){if(!M||!R)return;if(!e||!e.session){f=[],u&&(u.disabled=!0,u.textContent="复制 ≤0.5 词"),M.classList.add("hidden"),R.classList.remove("hidden");return}R.classList.add("hidden"),M.classList.remove("hidden");const{session:t,results:s}=e,n=J(t.submitted_at),r=Number(t.total_terms)||(Array.isArray(s)?s.length:0),i=Number(t.avg_similarity),c=Number.isFinite(i)?i.toFixed(2):"—",a=Number(t.correct_terms)||0,o=Number(t.partial_terms)||0,m=Number(t.incorrect_terms)||0;if(Z.textContent=`历史记录 #${t.id}`,tt.textContent=`提交时间：${n} ｜ 总词数：${r} ｜ 平均相似度：${c} ｜ 正确/部分/错误：${a}/${o}/${m}`,j&&(j.href=`geo_vocab_fill_in_webpage_english→chinese.html?session=${t.id}`),U){const d=nt(t.article||"");U.innerHTML=d}N="term",v=!0,F=Array.isArray(s)?[...s]:[],O()}async function X(e){if(!Number.isInteger(e)||e<=0)return;Array.from(g?.querySelectorAll(".history-session-item.active")||[]).forEach(s=>{s.classList.remove("active")});const t=g?.querySelector(`.history-session-item[data-id="${e}"]`);if(t&&t.classList.add("active"),k.has(e)){q(k.get(e));return}try{y(`正在加载记录 #${e}…`,"info");const n=`${B().replace(/\/$/,"")}/api/sessions/${e}`,r=await D(n);k.set(e,r),q(r),y(`已加载记录 #${e}`,"ok")}catch(s){console.error("[History] 加载详情失败:",s),y(`加载记录 #${e} 失败：${s.message}`,"warn")}}p&&p.addEventListener("change",()=>{const e=p.value.trim();e&&localStorage.setItem("score-api-url",e),Y(7)});z&&z.addEventListener("click",()=>{k.clear(),K({autoSelect:!1})});I&&(localStorage.getItem("history-show-meaning")==="false"&&(L=!1,I.checked=!1),I.addEventListener("change",()=>{L=!!I.checked,localStorage.setItem("history-show-meaning",L?"true":"false"),O()}));g&&g.addEventListener("click",e=>{const t=e.target.closest(".history-session-item");if(!t)return;const s=Number(t.dataset.id);Number.isInteger(s)&&X(s)});A&&A.addEventListener("click",e=>{const t=e.target.closest("th[data-sort]");if(!t)return;const s=t.dataset.sort;s&&F.length&&(N===s?v=!v:(N=s,v=!0),O())});window.addEventListener("resize",()=>{$.length&&Q($)});function G(e){const t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="fixed",t.style.top="-9999px",document.body.appendChild(t),t.select();let s=!1;try{s=document.execCommand("copy")}catch{s=!1}return document.body.removeChild(t),s}async function at(){if(!Array.isArray(f)||!f.length){y("当前记录没有相似度 ≤0.5 的词汇","warn");return}const e=f.join(", ");try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(e);else if(!G(e))throw new Error("无法访问剪贴板");y(`已复制 ${f.length} 个词汇到剪贴板`,"ok")}catch(t){G(e)?y(`已复制 ${f.length} 个词汇到剪贴板`,"ok"):y(`复制失败：${t.message}`,"warn")}}u&&u.addEventListener("click",at);B();Y(7);K({autoSelect:!0});
