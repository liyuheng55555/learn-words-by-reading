import{e as Z,f as ct}from"./chunks/http.js";let S=[];const V=new Map,dt=new Map,L=new Map;let N="";const M=document.getElementById("list"),xt=document.getElementById("filter"),ut=document.getElementById("edit-mode-btn"),gt=document.getElementById("view-mode-btn"),At=document.getElementById("edit-section"),bt=document.getElementById("view-section"),R=document.getElementById("article-editor"),Nt=document.getElementById("save-article-btn"),B=document.getElementById("editor-status"),rt=document.getElementById("article-content"),st=document.getElementById("generator-words"),x=document.getElementById("generate-article-btn"),Q=document.getElementById("generator-status"),f=document.getElementById("start-grade"),y=document.getElementById("sync-server"),k=document.getElementById("sync-status"),tt=document.getElementById("server-scores"),F=document.getElementById("score-api-url"),Et=document.getElementById("api-url"),vt=document.getElementById("api-key"),St=document.getElementById("ai-model"),Rt=document.getElementById("practiced-count"),Pt=document.getElementById("total-count"),Gt=document.getElementById("mastery-threshold"),T=document.getElementById("auto-fill-words"),P=new Map;y&&!y.dataset.originalText&&(y.dataset.originalText=y.textContent);W([]);h("","info");Tt({quiet:!0});const Ot=220,H=.85,et=.6;let q={};function G(e){return"term-"+e.toLowerCase().replace(/[^a-z0-9]+/g,"-")}function $t(e,t){const n=typeof e=="string"?e.trim():"";if(!n)return;const o=typeof t=="string"&&t.trim()?t.trim():n;V.set(o.toLowerCase(),n),V.set(n.toLowerCase(),n),dt.set(n,o)}function jt(e=[]){if(V.clear(),dt.clear(),!!Array.isArray(e))for(const t of e)!t||typeof t!="object"||$t(t.original,t.used)}function mt(e){if(!e)return null;const t=e.trim().toLowerCase();return V.has(t)?V.get(t):S.find(o=>o.toLowerCase()===t)||null}function _t(e){if(!e)return null;const t=e.trim();return dt.get(t)||t}function at(e){const t=_t(e)||e,n="t-"+t.toLowerCase().replace(/[^a-z0-9]+/g,"-"),o=document.getElementById(n);if(o){o.scrollIntoView({behavior:"smooth",block:"center"}),ht(o);return}const r=document.querySelectorAll("#article-content strong"),s=t.toLowerCase();for(const i of r){const a=i.textContent.trim().toLowerCase();if(a===s||a.includes(s)){i.scrollIntoView({behavior:"smooth",block:"center"}),ht(i);return}}alert("åœ¨æ–‡ç« ä¸­æœªæ‰¾åˆ°è¯¥è¯ï¼š"+e)}function ht(e){e.style.outline="2px solid var(--accent-2)",e.style.boxShadow="0 0 0 4px rgba(137,220,235,.25)",setTimeout(()=>{e.style.outline="",e.style.boxShadow=""},1500)}function Ft(e){if(!e)return[];const t=e.split(/[\n,ï¼Œã€ï¼›;]+/),n=new Set,o=[];for(const r of t){const s=r.trim();s&&!n.has(s)&&(n.add(s),o.push(s))}return o}function Vt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function K(e){if(!e)return"";const{content:t,text:n,tool_calls:o}=e,r=a=>a?typeof a=="string"?a:typeof a=="number"||typeof a=="boolean"?String(a):typeof a=="object"?typeof a.text=="string"?a.text:Array.isArray(a.text)?a.text.map(r).join(""):a.type==="text"&&typeof a.value=="string"?a.value:a.type==="text"&&typeof a.data=="string"?a.data:(a.type==="tool_call"&&a.function?.arguments,""):"":"";let s=[];if(typeof t=="string"?s.push(t):Array.isArray(t)?s.push(t.map(r).join("")):t&&typeof t=="object"&&(typeof t.text=="string"?s.push(t.text):Array.isArray(t.text)&&s.push(t.text.map(r).join(""))),typeof n=="string"?s.push(n):Array.isArray(n)&&s.push(n.map(r).join("")),(!s.length||s.join("").trim()==="")&&Array.isArray(o))for(const a of o)a?.function?.result&&typeof a.function.result=="string"&&s.push(a.function.result);return s.join(`
`).trim()}function Jt(e){const t=Vt(e.trim());return t?/\s/.test(e)?new RegExp(t.replace(/\s+/g,"\\s+"),"i"):new RegExp(`\\b${t}\\b`,"i"):null}function z(e,t,{trim:n=!0}={}){if(!e)return;const o=()=>{const r=n?e.value.trim():e.value;r?localStorage.setItem(t,r):localStorage.removeItem(t)};e.addEventListener("change",o),e.addEventListener("blur",o)}function Ht(e,t,n=[]){const o=e.replace(/\*\*/g,""),r=new Set,s=/\*\*(.*?)\*\*/g;let i;for(;(i=s.exec(e))!==null;){const l=i[1]?.trim().toLowerCase();l&&r.add(l)}const a=new Map;if(Array.isArray(n))for(const l of n){if(!l||typeof l!="object")continue;const c=typeof l.original=="string"?l.original.trim().toLowerCase():"",d=typeof l.used=="string"?l.used.trim().toLowerCase():"";c&&d&&a.set(c,d),c&&!d&&a.set(c,c)}const u=[];for(const l of t){const c=typeof l=="string"?l.trim().toLowerCase():"";if(!c||r.has(c))continue;const d=a.get(c);if(d&&r.has(d))continue;const g=Jt(l);g&&(g.test(o)||u.push(l))}return u}function p(e,t="info"){if(!Q)return;const n={info:"var(--muted)",ok:"var(--ok)",warn:"var(--warn)"};Q.textContent=e||"",Q.style.color=n[t]||n.info}z(Et,"ai-api-url");z(vt,"ai-api-key");z(St,"ai-model");z(F,"score-api-url");function j(e,t){f&&(typeof e=="string"&&(f.textContent=e),f.disabled=t)}function Ut(){f&&(f.disabled=!1,f.textContent=f.dataset.originalText||"ğŸ“ å¼€å§‹åˆ¤é¢˜")}function h(e,t="info"){k&&(k.classList.remove("ok","warn"),t==="ok"&&k.classList.add("ok"),t==="warn"&&k.classList.add("warn"),t!=="ok"&&t!=="warn"&&k.classList.remove("ok","warn"),k.textContent=e||"")}function W(e){if(!tt)return;if(P.clear(),!e||!e.length){tt.innerHTML='<div class="empty">æœåŠ¡å™¨æš‚æ— è¯æ±‡è®°å½•ã€‚</div>',it();return}const t=e.map(({term:n,score:o,submissions:r,last_submission:s})=>{const i=Z(n),a=Number(o),u=Number.isFinite(a)?a.toFixed(2):"0.00",l=Number.isFinite(Number(r))?Number(r):0;typeof n=="string"&&P.set(n.trim(),Number.isFinite(a)?a:null);let c="-";if(s){const d=new Date(s);c=Number.isNaN(d.getTime())?Z(s):d.toLocaleString()}return`<tr><td>${i}</td><td>${u}</td><td>${l}</td><td>${Z(c)}</td></tr>`}).join("");tt.innerHTML=`
    <h5>æœåŠ¡å™¨è¯è¡¨å¾—åˆ†</h5>
    <table>
      <thead><tr><th>è¯æ±‡</th><th>ç´¯è®¡åˆ†æ•°</th><th>æäº¤æ¬¡æ•°</th><th>æœ€åæäº¤æ—¶é—´</th></tr></thead>
      <tbody>${t}</tbody>
    </table>
  `,it()}function Y(){const e=F?.value?.trim();if(e)return e;const t=localStorage.getItem("score-api-url");return t||"http://localhost:4000"}function qt(){const e=[];if(!q)return e;for(const[t,n]of Object.entries(q))if(n&&typeof n.similarity=="number"){const o=L.get(t)||"";e.push({term:t,similarity:n.similarity,context:o||null,standard_answer:n.standardAnswer?String(n.standardAnswer):null,explanation:n.explanation?String(n.explanation):null})}return e}function Dt(){return typeof N=="string"&&N.trim()?N.trim():typeof R?.value=="string"?R.value.trim():""}function Kt(){const e=Number(Rt?.value??0),t=Number(Pt?.value??0),n=Number(Gt?.value??1),o=Number.isFinite(e)?Math.max(0,Math.min(50,Math.round(e))):0,r=Number.isFinite(t)?Math.max(0,Math.min(50,Math.round(t))):0,s=Number.isFinite(n)?n:1;return{practiced:o,total:r,masteryThreshold:s}}async function Tt({quiet:e=!1}={}){try{const n=Y().replace(/\/$/,"")+"/api/word-scores",o=await ct(n);Array.isArray(o?.scores)?(W(o.scores),e||h(`å·²è·å–æœåŠ¡å™¨è®°å½•ï¼ˆ${o.scores.length} ä¸ªè¯ï¼‰`,"ok")):e||h("æœåŠ¡å™¨æœªè¿”å›æœ‰æ•ˆæ•°æ®","warn")}catch(t){e||h(`æ— æ³•è·å–æœåŠ¡å™¨åˆ†æ•°ï¼š${t.message}`,"warn")}}async function zt(){if(!T)return;const{practiced:e,total:t,masteryThreshold:n}=Kt();if(!t){p("è¯·è®¾ç½®æ€»è¯æ•°ï¼ˆè‡³å°‘ 1ï¼‰","warn");return}if(e>t){p("ç»ƒä¹ è¿‡çš„è¯æ•°ä¸èƒ½è¶…è¿‡æ€»è¯æ•°","warn");return}const o=Y(),r=`${o.replace(/\/$/,"")}/api/word-suggestions?practiced=${e}&total=${t}&threshold=${encodeURIComponent(n)}`;T.disabled=!0,T.textContent="è·å–ä¸­â€¦",p("æ­£åœ¨å‘æœåŠ¡å™¨è¯·æ±‚æ¨èè¯æ±‡â€¦","info");try{const s=await ct(r),i=Array.isArray(s?.practiced)?s.practiced.map(l=>l.term).filter(Boolean):[],a=Array.isArray(s?.fresh)?s.fresh.map(l=>l.term).filter(Boolean):[];if(!i.length&&!a.length){p("æœªè·å–åˆ°ç¬¦åˆæ¡ä»¶çš„è¯æ±‡ï¼Œè¯·è°ƒæ•´å‚æ•°ã€‚","warn");return}const u=[];i.length&&u.push(i.join(", ")),a.length&&u.push(a.join(", ")),st.value=u.join(`

`),p(`å·²å¡«å…¥ ${i.length} ä¸ªç»ƒä¹ è¯ä¸ ${a.length} ä¸ªæ–°è¯`,"ok"),localStorage.setItem("score-api-url",o)}catch(s){console.error("[Auto Fill Words] è·å–å¤±è´¥:",s),p(`è·å–æ¨èè¯æ±‡å¤±è´¥ï¼š${s.message}`,"warn")}finally{T.disabled=!1,T.textContent="ğŸ¯ è‡ªåŠ¨å–è¯"}}function ft(){const e=Et?.value?.trim(),t=vt?.value?.trim(),n=St?.value?.trim(),o=localStorage.getItem("ai-api-url"),r=localStorage.getItem("ai-api-key"),s=localStorage.getItem("ai-model"),i=(e||o||"").trim(),a=(t||r||"").trim(),u=(n||s||"gpt-3.5-turbo").trim()||"gpt-3.5-turbo";return e!==void 0&&(e?localStorage.setItem("ai-api-url",e):localStorage.removeItem("ai-api-url")),t!==void 0&&(t?localStorage.setItem("ai-api-key",t):localStorage.removeItem("ai-api-key")),n!==void 0&&(n?localStorage.setItem("ai-model",n):localStorage.removeItem("ai-model")),{apiUrl:i,apiKey:a,model:u}}function Wt(e){const t=[...e];for(let n=t.length-1;n>0;n--){const o=Math.floor(Math.random()*(n+1));[t[n],t[o]]=[t[o],t[n]]}return t}function Yt(e){return`è¯·ä¸ºè‹±è¯­å­¦ä¹ è€…å†™ä¸€ç¯‡è‹±æ–‡çŸ­æ–‡ï¼Œä½¿ç”¨ Markdown æ®µè½æ ¼å¼ï¼ˆå¯è‡ªè¡Œåˆ†æ®µï¼Œä½†ä¸è¦æ·»åŠ æ ‡é¢˜ã€å‰è¨€æˆ–ä»£ç å—ï¼‰ã€‚ä¸¥æ ¼éµå®ˆä¸‹åˆ—è§„åˆ™ï¼š

**A. æ ‡æ³¨ä¸é¢‘æ¬¡**

* ä»…å¯¹ç›®æ ‡è¯åŠ ç²—ï¼Œå½¢å¼ä¸º **word**ï¼›é™¤ç›®æ ‡è¯å¤–ä¸å¾—ä½¿ç”¨ç²—ä½“ã€‚
* æ¯ä¸ªç›®æ ‡è¯è‡³å°‘å‡ºç°ä¸€æ¬¡ï¼›å¯æŒ‰è¯­å¢ƒå˜åŒ–è¯å½¢ï¼Œå¹¶å¯¹å˜åŒ–åçš„è¯å½¢åŠ ç²—ã€‚
* **æ¯å¥æœ€å¤šå‡ºç°ä¸€ä¸ªç›®æ ‡è¯**ï¼›ç¦æ­¢åœ¨åŒä¸€å¥ç”¨å¹¶åˆ—ï¼ˆå¦‚ â€œX and Yâ€ æˆ– â€œX, Y, and Zâ€ï¼‰æ”¾å…¥å¤šä¸ªç›®æ ‡è¯ã€‚

**B. è¯­ä¹‰åˆ†æ•£ä¸é˜²â€œæ‰å †â€**

* **åŒä¹‰ã€è¿‘ä¹‰ã€åä¹‰ã€åŒè¯æ ¹æˆ–åŒä¸€è¯­ä¹‰åœºçš„ç›®æ ‡è¯ï¼Œå½¼æ­¤ä¹‹é—´è‡³å°‘é—´éš” â‰¥2 å¥**ï¼›ä¸å¾—å‡ºç°åœ¨ç›¸é‚»å¥æˆ–åŒä¸€å¥ã€‚
* è‹¥ä¸¤è¯å¸¸ä½œå¹¶åˆ—å½¢å®¹æˆ–å¯äº’æ¢ä½¿ç”¨ï¼Œåªåœ¨ä¸åŒå¥ä¸­å‡ºç°ï¼Œä¸”ç½®äºä¸åŒè¯é¢˜æˆ–åŠŸèƒ½ï¼ˆå¦‚ä¸€ä¸ªä½œæè¿°ï¼Œå¦ä¸€ä¸ªç”¨äºè¡ŒåŠ¨æˆ–ç»“æœï¼‰ã€‚

**C. è¿è´¯æ€§ä¸ç»“æ„ï¼ˆé‡ç‚¹ï¼‰**

* å…ˆåœ¨å†…éƒ¨æ‹Ÿå®šâ€œä¸‰æ®µå¼å™äº‹â€ä½†**ä¸è¾“å‡ºå¤§çº²**ï¼š
  1ï¼‰å¼€ç«¯ï¼šäº¤ä»£æ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ä¸ç›®æ ‡ï¼›
  2ï¼‰å‘å±•ï¼šè¡ŒåŠ¨ã€é˜»ç¢ä¸æŠ‰æ‹©ï¼›
  3ï¼‰ç»“å°¾ï¼šç»“æœæˆ–åæ€ï¼Œå‘¼åº”ç›®æ ‡ã€‚
* å…¨æ–‡ä¿æŒ**åŒä¸€ç»„äººç‰©/åœ°ç‚¹/ç›®æ ‡**è´¯ç©¿ï¼›ä¸è¦æ— æç¤ºåœ°æ›´æ¢åœºæ™¯æˆ–äººç‰©ã€‚
* **å¥é™…é€»è¾‘**æ¸…æ™°ï¼šæ¯å¥ä¸ä¸Šä¸€å¥æ„æˆæ—¶é—´é¡ºåºã€å› æœã€é€’è¿›æˆ–è½¬æŠ˜å…³ç³»ã€‚å¿…è¦æ—¶åœ¨å¥é¦–ä½¿ç”¨ then, later, because, however, therefore, eventually ç­‰è¿æ¥è¯ï¼ˆé€‚é‡ä½¿ç”¨ï¼‰ã€‚
* ç¦æ­¢æ¸…å•å¼ã€å£å·å¼æˆ–ä¸ä¸»çº¿æ— å…³çš„è·³è½¬ï¼›é¿å…æ¨¡æ¿åŒ–é‡å¤å¥å¼ã€‚

**D. è¯­å¢ƒæš—ç¤ºï¼Œç¦æ­¢å®šä¹‰å¼å†™æ³•**

* ç¦æ­¢ â€œ**X** is/means/refers to/also called/defined as â€¦â€ ç­‰å®šä¹‰å¥ï¼›ç¦æ­¢åœ¨ç›®æ ‡è¯æ‰€åœ¨å¥ç”¨æ‹¬å·ã€ç ´æŠ˜å·ã€åŒä½è¯­æˆ– â€œi.e./such as/for exampleâ€ ç»™å‡ºç›´ç™½è§£é‡Šæˆ–åŒä¹‰æ›¿æ¢ã€‚
* ä¸ç»™å‡ºä¸­æ–‡é‡Šä¹‰æˆ–ç›´è¯‘æç¤ºè¯ï¼›é€šè¿‡åŠ¨ä½œã€ç»“æœã€æ„Ÿå—ã€å¯¹è¯æˆ–æƒ…å¢ƒ**é—´æ¥**è¡¨è¾¾å«ä¹‰ã€‚

**E. ç¯‡å¹…ä¸æ®µè½**

* å¥å­æ•°åº” â‰¥ ç›®æ ‡è¯æ•°é‡ï¼Œä¼˜å…ˆé‡‡ç”¨â€œä¸€è¯ä¸€å¥â€ã€‚

**F. è¾“å‡º**

* **ä»…è¾“å‡ºæ–‡ç« æ­£æ–‡**ï¼Œä¿ç•™ Markdown æ®µè½ä¸ç²—ä½“æ ‡è®°ï¼›ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–è¯´æ˜ã€æ ‡é¢˜ã€åˆ—è¡¨æˆ– JSONã€‚

ç›®æ ‡è¯æ±‡ï¼ˆé¡ºåºéšæœºï¼‰ï¼š

${e.map((n,o)=>`${o+1}. ${n}`).join(`
`)}`}function Xt(e,t){const n=t.map((o,r)=>`${r+1}. ${o}`).join(`
`);return`è¯·é˜…è¯»ä¸‹æ–¹çš„è‹±æ–‡æ–‡ç« ï¼Œå¹¶æ ¹æ®æä¾›çš„ç›®æ ‡è¯æ±‡åˆ—è¡¨ï¼ŒæŒ‡å‡ºæ–‡ç« ä¸­æ¯ä¸ªè¯æ±‡çš„å®é™…å†™æ³•ã€‚

è¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "pairs": [
    {"original": "ç›®æ ‡è¯æ±‡", "used": "æ–‡ç« ä¸­çš„å®é™…å†™æ³•ï¼ˆå»æ‰**ï¼Œè‹¥æœªå‡ºç°åˆ™ç•™ç©ºå­—ç¬¦ä¸²ï¼‰"}
  ]
}

è¦æ±‚ï¼š
- original å¿…é¡»ä¸æä¾›çš„ç›®æ ‡è¯æ±‡å®Œå…¨ä¸€è‡´ï¼›
- used ä¸ºæ–‡ç« ä¸­å‡ºç°çš„å…·ä½“å½¢å¼ï¼ˆä¿ç•™å¤§å°å†™/å•å¤æ•°ç­‰å˜åŒ–ï¼Œä½†å»æ‰ä»»ä½• Markdown ** æ ‡è®°ï¼‰ï¼›
- å¦‚æœæŸä¸ªè¯æœªåœ¨æ–‡ç« ä¸­å‡ºç°ï¼Œå°† used è®¾ä¸ºç©ºå­—ç¬¦ä¸²ã€‚

è‹±æ–‡æ–‡ç« ï¼š
"""
${e}
"""

ç›®æ ‡è¯æ±‡åˆ—è¡¨ï¼š
${n}`}function nt(e){return typeof e!="string"?"":e.replace(/\*\*/g,"").trim()}function Zt(e,t){const n=(t||[]).map(l=>({original:l,used:l}));if(!e)return n;let o=e.trim();if(!o)return n;let r=null;const s=o.match(/```(?:json)?([\s\S]*?)```/i);if(s)r=s[1].trim();else{const l=o.match(/\{[\s\S]*\}/);l&&(r=l[0])}let i=[];if(r)try{const l=JSON.parse(r);i=(Array.isArray(l?.pairs)?l.pairs:Array.isArray(l)?l:[]).map(d=>{if(!d||typeof d!="object")return null;const g=typeof d.original=="string"?d.original.trim():"",m=nt(d.used??"");return g?{original:g,used:m||""}:null}).filter(Boolean)}catch(l){console.warn("[Variant Mapping] JSONè§£æå¤±è´¥ï¼Œå°è¯•è§£æçº¯æ–‡æœ¬æ ¼å¼",l),i=[]}if(!i.length){const l=o.split(/\n+/).map(c=>c.trim()).filter(Boolean);for(const c of l){const d=c.match(/^(.+?)\s*(?:=>|->|ï¼š|:|=)\s*(.+)$/);if(!d)continue;const g=d[1].trim(),m=nt(d[2]);g&&i.push({original:g,used:m})}}const a=new Map;for(const l of i){const c=typeof l.original=="string"?l.original.trim():"";if(!c)continue;const d=c.toLowerCase(),g=nt(l.used||c);a.has(d)||a.set(d,{original:c,used:g||c})}const u=[];for(const l of t||[]){const c=l.trim().toLowerCase(),d=a.get(c),g=d?d.used:l;u.push({original:l,used:g})}return u}async function Qt(e,t,n,o,r){const s=Xt(o,r),i={model:n,messages:[{role:"system",content:"You are an assistant that extracts vocabulary mappings and responds with concise JSON."},{role:"user",content:s}],temperature:0,max_tokens:3e3};console.log("[Variant Mapping] è¯·æ±‚ä½“:",JSON.stringify(i,null,2));const a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(i)});if(console.log("[Variant Mapping] å“åº”çŠ¶æ€:",a.status,a.statusText),!a.ok){const d=await a.text();throw console.error("[Variant Mapping] APIé”™è¯¯å“åº”:",d),new Error(`è¯å½¢æ˜ å°„è¯·æ±‚å¤±è´¥: ${a.status} ${a.statusText}: ${d}`)}const u=await a.json();console.log("[Variant Mapping] APIå“åº”:",u);const l=u?.choices?.[0]?.message;if(!l)throw new Error("è¯å½¢æ˜ å°„å“åº”æ ¼å¼å¼‚å¸¸");const c=K(l);return console.log("[Variant Mapping] AIå›å¤:",c),Zt(c,r)}async function te(){if(!x)return;const e=Ft(st?.value||"");if(!e.length){p("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç›®æ ‡è¯æ±‡","warn"),st?.focus();return}const{apiUrl:t,apiKey:n,model:o}=ft();if(!t||!n){p("è¯·å…ˆåœ¨å³ä¾§é…ç½®AI APIåœ°å€ä¸Key","warn");return}const r=x.dataset.originalText||x.textContent;try{x.disabled=!0,x.dataset.originalText=r,x.textContent="ç”Ÿæˆä¸­â€¦",p("æ­£åœ¨è¯·æ±‚AIç”Ÿæˆæ–‡ç« â€¦","info");const s=Wt(e),i=Yt(s),a={model:o,messages:[{role:"system",content:"You are an expert science writer who produces fluent, engaging English articles in Markdown without extra commentary."},{role:"user",content:i}],temperature:.65,top_p:.9,max_tokens:Math.min(1200,Math.round(Ot*4.2))};console.log("[Article Generator] è¯·æ±‚ä½“:",JSON.stringify(a,null,2));const u=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(a)});if(!u.ok){const v=await u.text();throw new Error(`APIè¯·æ±‚å¤±è´¥: ${u.status} ${u.statusText} | ${v}`)}const l=await u.json();console.log("[Article Generator] APIå“åº”:",l);const c=l?.choices?.[0]?.message;if(!c)throw new Error("AIæœªè¿”å›æ–‡ç« å†…å®¹");const d=K(c);if(!d)throw new Error("AIæœªè¿”å›æ–‡ç« å†…å®¹");R.value=d.trim();let g,m=!1;try{if(p("æ–‡ç« ç”ŸæˆæˆåŠŸï¼Œæ­£åœ¨åˆ†æè¯å½¢æ˜ å°„â€¦","info"),g=await Qt(t,n,o,d,e),!Array.isArray(g)||!g.length)throw new Error("æœªè·å¾—æœ‰æ•ˆçš„è¯å½¢æ˜ å°„")}catch(v){console.error("[Article Generator] è¯å½¢æ˜ å°„å¤±è´¥:",v),g=e.map(b=>({original:b,used:b})),p("æ–‡ç« ç”Ÿæˆå®Œæˆï¼Œä½†è¯å½¢æ˜ å°„å¤±è´¥ï¼Œå·²ä½¿ç”¨åŸå§‹è¯æ±‡ã€‚","warn"),w("è¯å½¢æ˜ å°„å¤±è´¥ï¼Œå·²ä½¿ç”¨åŸå§‹è¯æ±‡","warn"),m=!0}console.log("[Article Generator] æœ€ç»ˆè¯å½¢æ˜ å°„:",g),pt(d,g),X();const A=Ht(d,e,g);if(A.length){const v=`âš ï¸ å·²ç”Ÿæˆæ–‡ç« ï¼Œä½†ç¼ºå°‘ ${A.length} ä¸ªè¯ï¼š${A.join("ï¼Œ")}`;p(v,"warn"),w("ç”Ÿæˆå®Œæˆï¼Œä½†å­˜åœ¨ç¼ºå¤±è¯æ±‡ï¼Œè¯·æ‰‹åŠ¨è¡¥å……ã€‚","warn")}else m||(p("AIæ–‡ç« ç”Ÿæˆå®Œæˆï¼Œè¯æ±‡ä¸è¯å½¢å‡å·²è¦†ç›– âœ“","ok"),w("æ–‡ç« ç”ŸæˆæˆåŠŸå¹¶åŒ…å«å…¨éƒ¨ç›®æ ‡è¯æ±‡ï¼","ok"));await Tt({quiet:!0})}catch(s){console.error("[Article Generator] ç”Ÿæˆæ–‡ç« å¤±è´¥:",s),p(`ç”Ÿæˆå¤±è´¥ï¼š${s.message}`,"warn")}finally{x.disabled=!1,x.textContent=x.dataset.originalText||"âœ¨ AIç”Ÿæˆæ–‡ç« "}}function pt(e,t=[]){try{N=typeof e=="string"?e:"",jt(t);const n=ee(e);rt.innerHTML=n,ne(e),oe(),yt(),B.textContent="æ–‡ç« ä¿å­˜æˆåŠŸï¼",B.style.color="var(--ok)"}catch(n){B.textContent="å¤„ç†æ–‡ç« å†…å®¹æ—¶å‡ºé”™: "+n.message,B.style.color="var(--warn)"}}function ee(e){return e.split(`

`).map(o=>`<p>${o.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function ne(e){const t=/\*\*(.*?)\*\*/g,n=[],o=new Set;let r;for(;(r=t.exec(e))!==null;){const s=r[1]?.trim();if(!s)continue;const i=mt(s)||s;$t(i,s),o.has(i)||(o.add(i),n.push(i))}S=n}function oe(){if(L.clear(),!rt)return;rt.querySelectorAll("p").forEach(t=>{const n=t.textContent?t.textContent.replace(/\s+/g," ").trim():"";if(!n)return;t.querySelectorAll("strong").forEach(r=>{const s=r.textContent?r.textContent.trim():"";if(!s)return;const i=mt(s)||s;if(!i||L.has(i))return;const a=re(n,s)||n;L.set(i,a)})})}function re(e,t){if(!e||!t)return"";const n=e.replace(/\s+/g," ").trim(),o=t.trim().toLowerCase(),r=n.match(/[^ã€‚ï¼ï¼Ÿ!?\.]+[ã€‚ï¼ï¼Ÿ!?\.]?/g)||[n];for(const s of r)if(s.toLowerCase().includes(o))return s.trim();return n}function se(){ut.classList.add("active"),gt.classList.remove("active"),At.style.display="block",bt.style.display="none"}function X(){ut.classList.remove("active"),gt.classList.add("active"),At.style.display="none",bt.style.display="block"}ut.addEventListener("click",se);gt.addEventListener("click",X);Nt.addEventListener("click",()=>{const e=R.value;e.trim()?(pt(e),X()):(B.textContent="è¯·è¾“å…¥æ–‡ç« å†…å®¹",B.style.color="var(--warn)")});x&&x.addEventListener("click",te);T&&T.addEventListener("click",e=>{e.preventDefault(),zt()});y&&y.addEventListener("click",async()=>{const e=qt();if(!e.length){h("è¯·å…ˆå®ŒæˆAIåˆ¤é¢˜åå†åŒæ­¥ã€‚","warn"),w("æ²¡æœ‰å¯åŒæ­¥çš„åˆ¤é¢˜åˆ†æ•°","warn");return}const t=Y(),n=t.replace(/\/$/,"")+"/api/word-scores",o=Dt(),r=y.dataset.originalText||y.textContent;y.dataset.originalText=r,y.disabled=!0,y.textContent="åŒæ­¥ä¸­â€¦",h("æ­£åœ¨åŒæ­¥åˆ¤é¢˜ç»“æœåˆ°æœåŠ¡å™¨â€¦","info");try{const s=await ct(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({results:e,article:o})}),i=Array.isArray(s?.scores)?s.scores:[];W(i);const a=s?.updated??e.length,u=s?.session_id,l=u?`ï¼ˆå†å²è®°å½• #${u} å·²ç”Ÿæˆï¼‰`:"";h(`åŒæ­¥æˆåŠŸï¼Œå·²æ›´æ–° ${a} ä¸ªè¯æ±‡${l}`,"ok"),w(u?`åŒæ­¥å®Œæˆï¼å†å²è®°å½• #${u}`:"æœåŠ¡å™¨è¯è¡¨å·²æ›´æ–° âœ“","ok"),localStorage.setItem("score-api-url",t)}catch(s){console.error("[Sync Scores] åŒæ­¥å¤±è´¥:",s),h(`åŒæ­¥å¤±è´¥ï¼š${s.message}`,"warn"),w("åŒæ­¥å¤±è´¥ï¼š"+s.message,"warn")}finally{y.disabled=!1,y.textContent=y.dataset.originalText||"â¬†ï¸ åŒæ­¥åˆ°æœåŠ¡å™¨"}});function ae(e){const t=document.getElementById(G(e));if(t){t.scrollIntoView({behavior:"smooth",block:"center"}),t.focus();const n=t.closest(".item");n&&(n.style.outline="2px solid var(--accent-2)",n.style.boxShadow="0 0 0 4px rgba(137,220,235,.25)",setTimeout(()=>{n.style.outline="",n.style.boxShadow=""},1500))}}function J(){S.forEach(e=>{const t=document.getElementById(G(e));if(!t)return;const n=t.closest(".item");if(!n)return;const o=t.value&&t.value.trim().length>0;n.classList.toggle("filled",o)})}function it(){if(!M)return;M.querySelectorAll(".score-badge").forEach(t=>{const n=t.dataset.termScore,o=n&&P.has(n)?P.get(n):null;typeof o=="number"?(t.textContent=o.toFixed(2),t.classList.add("score-known")):(t.textContent="â€”",t.classList.remove("score-known"))})}function yt(){M.innerHTML="";const e=xt.value?.trim().toLowerCase();for(const t of S){if(e&&!t.toLowerCase().includes(e))continue;const n=G(t),o=document.createElement("div");o.className="item";const r=P.has(t)?P.get(t):null,s=typeof r=="number"?r.toFixed(2):"â€”";o.innerHTML=`
      <div class="term" data-term="${t}">
        <span>${t}</span>
        <span class="score-badge" data-term-score="${t}">${s}</span>
        <span class="jump" data-term="${t}">è·³åˆ°æ–‡ä¸­</span>
      </div>
      <input aria-label="${t} ä¸­æ–‡æ„æ€" placeholder="ä¸­æ–‡æ„æ€â€¦" id="${n}" data-term="${t}" />
    `,M.appendChild(o)}J(),it()}yt();M.addEventListener("click",e=>{const t=e.target;if(t.classList.contains("jump"))at(t.dataset.term);else if(t.classList.contains("term")||t.parentElement.classList.contains("term")){const n=t.dataset.term||t.parentElement.dataset.term;n&&at(n)}});xt.addEventListener("input",yt);M.addEventListener("focus",e=>{e.target.tagName==="INPUT"&&e.target.dataset.term&&at(e.target.dataset.term)},!0);document.getElementById("article-content").addEventListener("click",e=>{if(e.target.tagName==="STRONG"){const t=e.target.textContent.trim(),n=mt(t);n&&S.includes(n)&&ae(n)}});const Lt="geo_vocab_answers_v1";function Ct(){const e={};for(const t of S){const n=document.getElementById(G(t));e[t]=n&&n.value||""}return e}function ie(e){if(e){for(const t of S){const n=document.getElementById(G(t));n&&t in e&&(n.value=e[t]||"")}J()}}function Mt(){try{const e=Ct();localStorage.setItem(Lt,JSON.stringify(e)),J()}catch(e){console.warn("[Persist Answers] ä¿å­˜å¤±è´¥:",e)}}let U=null;function le(){U&&clearTimeout(U),U=setTimeout(()=>{U=null,Mt()},300)}try{const e=JSON.parse(localStorage.getItem(Lt)||"null");ie(e)}catch{}M.addEventListener("input",e=>{const t=e.target;t instanceof HTMLInputElement&&t.dataset.term&&(le(),J())});document.getElementById("clear").addEventListener("click",()=>{for(const e of S){const t=document.getElementById(G(e));t&&(t.value="")}Mt(),J(),w("å·²æ¸…ç©ºè¾“å…¥","warn")});function w(e,t){const n=document.createElement("div");n.textContent=e,n.style.position="fixed",n.style.right="18px",n.style.bottom="18px",n.style.background="rgba(10,15,30,.95)",n.style.border="1px solid rgba(122,162,247,.3)",n.style.color=t==="ok"?"var(--ok)":t==="warn"?"var(--warn)":"var(--text)",n.style.padding="10px 12px",n.style.borderRadius="10px",n.style.boxShadow="0 6px 18px var(--shadow)",document.body.appendChild(n),setTimeout(()=>n.remove(),2200)}let _=!1;const C=document.getElementById("ai-config"),D=document.getElementById("ai-results"),ot=document.getElementById("ai-progress"),ce=document.getElementById("progress-fill"),wt=document.getElementById("progress-text"),lt=document.getElementById("score-summary"),O=document.getElementById("ai-identity-check");document.getElementById("ai-grade").addEventListener("click",async()=>{if(C.style.display==="none"){C.style.display="block",p("");const e=localStorage.getItem("ai-api-url"),t=localStorage.getItem("ai-api-key"),n=localStorage.getItem("ai-model")||"gpt-3.5-turbo";e&&(document.getElementById("api-url").value=e),t&&(document.getElementById("api-key").value=t),document.getElementById("ai-model").value=n;const o=localStorage.getItem("score-api-url");F&&(F.value=o||F.value||"http://localhost:4000"),W([]),h("åŒæ­¥åå°†æ˜¾ç¤ºæœ¬æ¬¡æäº¤çš„è¯æ±‡æˆç»©","info")}else C.style.display="none"});O.addEventListener("click",async()=>{const{apiUrl:e,apiKey:t,model:n}=ft();if(!e||!t){alert(`è¯·å…ˆé…ç½®APIåœ°å€å’ŒKeyï¼

ç‚¹å‡»"ğŸ¤– AIå·¥å…·ç®±"æŒ‰é’®è¿›è¡Œé…ç½®ã€‚`);return}O.textContent="ğŸ” æ£€æµ‹ä¸­...",O.disabled=!0;try{const o=await pe(e,t,n);alert(`AIèº«ä»½ä¿¡æ¯ï¼š

${o}`)}catch(o){alert(`AIèº«ä»½æ£€æµ‹å¤±è´¥ï¼š

${o.message}`)}finally{O.textContent="ğŸ” æ£€æµ‹AIèº«ä»½",O.disabled=!1}});document.getElementById("cancel-grade").addEventListener("click",()=>{C.style.display="none",_=!1});f&&f.addEventListener("click",async()=>{const{apiUrl:e,apiKey:t,model:n}=ft();if(!e||!t){C.style.display="block",w("è¯·å¡«å†™APIåœ°å€å’ŒKey","warn");return}const o=f.dataset.originalText||f.textContent;f.dataset.originalText=o,j("åˆ¤é¢˜å‡†å¤‡ä¸­â€¦",!0);try{await de(e,t,n)}finally{setTimeout(Ut,600)}});async function de(e,t,n="gpt-3.5-turbo"){if(console.log("[Main Grading] å¼€å§‹AIåˆ¤é¢˜æµç¨‹"),console.log("[Main Grading] API URL:",e),console.log("[Main Grading] æ¨¡å‹:",n),console.log("[Main Grading] API Key é•¿åº¦:",t?t.length:0),_){console.warn("[Main Grading] åˆ¤é¢˜å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡");return}_=!0,ot.style.display="block",D.style.display="none",Bt();try{const o=Ct();console.log("[Main Grading] æ”¶é›†çš„æ•°æ®:",o);const r=S.filter(l=>o[l]&&o[l].trim());if(console.log("[Main Grading] å·²å¡«å†™çš„è¯æ±‡:",r),console.log("[Main Grading] å·²å¡«å†™è¯æ±‡æ•°é‡:",r.length),r.length===0){console.warn("[Main Grading] æ²¡æœ‰å¡«å†™çš„è¯æ±‡"),w("è¯·å…ˆå¡«å†™ä¸€äº›ç­”æ¡ˆ","warn"),_=!1,ot.style.display="none";return}wt.textContent=`å¼€å§‹åˆ¤é¢˜... (å…±${r.length}ä¸ªè¯)`,f&&j(`åˆ¤é¢˜ä¸­ 0/${r.length}`,!0);const s=50,i=[];for(let l=0;l<r.length;l+=s)i.push(r.slice(l,l+s));console.log("[Main Grading] åˆ†æ‰¹å¤„ç†:",i.length,"ä¸ªæ‰¹æ¬¡");let a=0;const u={};for(let l=0;l<i.length;l++){const c=i[l];console.log(`[Main Grading] å¤„ç†ç¬¬${l+1}æ‰¹:`,c),wt.textContent=`æ­£åœ¨å¤„ç†ç¬¬${l+1}/${i.length}æ‰¹ (${c.length}ä¸ªè¯)...`;try{const d=await ue(c,o,e,t,n);console.log(`[Main Grading] ç¬¬${l+1}æ‰¹ç»“æœ:`,d),Object.assign(u,d),a+=c.length;const g=a/r.length*100;if(ce.style.width=g+"%",console.log(`[Main Grading] è¿›åº¦: ${g}% (${a}/${r.length})`),f){const m=Math.round(g);j(`åˆ¤é¢˜ä¸­ ${a}/${r.length} (${m}%)`,!0)}l<i.length-1&&(console.log("[Main Grading] ç­‰å¾…1ç§’é¿å…é¢‘ç‡é™åˆ¶"),await new Promise(m=>setTimeout(m,1e3)))}catch(d){console.error(`[Main Grading] ç¬¬${l+1}æ‰¹å¤„ç†å¤±è´¥:`,d),w(`ç¬¬${l+1}æ‰¹å¤„ç†å¤±è´¥: ${d.message}`,"warn")}}console.log("[Main Grading] æ‰€æœ‰æ‰¹æ¬¡å¤„ç†å®Œæˆï¼Œæœ€ç»ˆç»“æœ:",u),kt(u,r.length),f&&j("åˆ¤é¢˜å®Œæˆ âœ“",!0)}catch(o){console.error("[Main Grading] åˆ¤é¢˜è¿‡ç¨‹é”™è¯¯:",o),w("åˆ¤é¢˜è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: "+o.message,"warn"),f&&j("åˆ¤é¢˜å¤±è´¥",!0)}finally{_=!1,ot.style.display="none",console.log("[Main Grading] åˆ¤é¢˜æµç¨‹ç»“æŸ")}}async function ue(e,t,n,o,r="gpt-3.5-turbo"){console.log("[Batch Grading] å¼€å§‹å¤„ç†æ‰¹æ¬¡:",e),console.log("[Batch Grading] ä½¿ç”¨æ¨¡å‹:",r);const s=me(e,t);console.log("[Batch Grading] ç”Ÿæˆçš„æç¤ºè¯:",s);const i={model:r,messages:[{role:"user",content:s}],temperature:.1};console.log("[Batch Grading] è¯·æ±‚ä½“:",JSON.stringify(i,null,2));const a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(i)});if(console.log("[Batch Grading] å“åº”çŠ¶æ€:",a.status,a.statusText),!a.ok){const g=await a.text();throw console.error("[Batch Grading] APIé”™è¯¯å“åº”:",g),new Error(`APIè¯·æ±‚å¤±è´¥: ${a.status} ${a.statusText}: ${g}`)}const u=await a.json();console.log("[Batch Grading] APIå“åº”:",u);const l=u?.choices?.[0]?.message;if(!l)throw console.error("[Batch Grading] å“åº”æ ¼å¼å¼‚å¸¸:",u),new Error("APIå“åº”æ ¼å¼å¼‚å¸¸");const c=K(l);console.log("[Batch Grading] AIå›å¤å†…å®¹:",c);const d=fe(c,e);return console.log("[Batch Grading] è§£æç»“æœ:",d),d}function ge(e){const t=typeof e=="number"?e:parseFloat(e);if(!Number.isFinite(t))return null;const n=Math.min(Math.max(t,0),1);return Math.round(n*1e3)/1e3}function me(e,t){return`ä½ æ˜¯ä¸€åç²¾é€šä¸­è‹±æ–‡æœ¯è¯­çš„æ•™å¸ˆï¼Œéœ€è¦åˆ¤æ–­å­¦ç”Ÿç»™å‡ºçš„ä¸­æ–‡ç¿»è¯‘ä¸è‹±æ–‡æœ¯è¯­çš„è¯­ä¹‰ç›¸ä¼¼åº¦ã€‚è¯·èšç„¦è¯ä¹‰æœ¬èº«ï¼Œä¸è¦è´´åˆç‰¹å®šå­¦ç§‘èƒŒæ™¯æˆ–å†·åƒ»çŸ¥è¯†ã€‚

è¯·å¯¹æ¯ä¸ªè¯æ±‡ï¼š
1. ç»™å‡ºæœ€æ ‡å‡†ã€æœ€å¸¸ç”¨çš„ä¸­æ–‡ç¿»è¯‘ï¼ˆå¯åŒ…å«å¤šä¸ªè¯ï¼Œç¡®ä¿å«ä¹‰å‡†ç¡®ï¼‰ã€‚
2. è¯„ä¼°å­¦ç”Ÿç­”æ¡ˆä¸æ ‡å‡†ç­”æ¡ˆåœ¨è¯­ä¹‰ä¸Šçš„ç›¸ä¼¼åº¦ï¼Œç›¸ä¼¼åº¦ç”¨ 0~1 çš„å°æ•°è¡¨ç¤ºï¼š0 ä»£è¡¨å®Œå…¨é”™è¯¯ï¼Œ1 ä»£è¡¨å®Œå…¨ä¸€è‡´ã€‚å…è®¸ä¿ç•™ä¸‰ä½å°æ•°ã€‚
   - è‹¥å­¦ç”Ÿç­”æ¡ˆæ¶µç›–äº†ä¸»è¦å«ä¹‰æˆ–æä¾›äº†å¸¸è§è¿‘ä¹‰è¯ï¼Œå³ä½¿æœªåˆ—å‡ºå…¨éƒ¨é‡Šä¹‰ï¼Œä¹Ÿåº”ç»™äºˆè¾ƒé«˜åˆ†ï¼ˆä¾‹å¦‚ â‰¥0.7ï¼‰ã€‚
3. å¦‚æœ‰éœ€è¦ï¼Œå¯ç»™å‡ºç®€çŸ­è¯´æ˜ï¼ˆ10~25ä¸ªå­—ï¼‰ï¼Œè§£é‡Šä¸»è¦å·®å¼‚æˆ–åŒ¹é…äº®ç‚¹ã€‚

åœ¨è¯„ä¼°æ—¶è¯·ç»“åˆæä¾›çš„åŸæ–‡è¯­å¢ƒç†è§£æœ¯è¯­çš„å«ä¹‰ï¼Œä»¥è¯¥è¯­å¢ƒä¸ºå‡†åˆ¤æ–­å­¦ç”Ÿç¿»è¯‘çš„å‡†ç¡®åº¦ã€‚

è¯„åˆ†åŸºå‡†ç¤ºä¾‹ï¼š
- å­¦ç”Ÿç­”æ¡ˆã€Œæç‚¹ã€ï¼Œæ ‡å‡†ç­”æ¡ˆã€Œæ†ï¼›æç‚¹ï¼›ç”µæã€â†’ 1.0 åˆ†ï¼ˆæ ¸å¿ƒå«ä¹‰å®Œå…¨å¯¹åº”ï¼‰
- å­¦ç”Ÿç­”æ¡ˆã€ŒçƒŸã€ï¼Œæ ‡å‡†ç­”æ¡ˆã€ŒçƒŸé›¾ã€â†’ 0.7 åˆ†ï¼ˆä¼ è¾¾ä¸»è¦æ¦‚å¿µï¼Œç»†èŠ‚ç•¥ç¼ºï¼‰
- å­¦ç”Ÿç­”æ¡ˆã€Œå¹³å¦çš„ã€ï¼Œæ ‡å‡†ç­”æ¡ˆã€Œå¹³åŸã€â†’ 0.5 åˆ†ï¼ˆç›¸å…³ä½†åå‘å½¢å®¹è¯ï¼Œéœ€è¦æŒ‡å‡ºè¯­ä¹‰å·®å¼‚ï¼‰

åŠ¡å¿…åªè¾“å‡º JSONï¼Œä¸è¦è§£é‡Šã€‚JSON æ ¼å¼å¦‚ä¸‹ï¼š
{
  "è‹±æ–‡è¯æ±‡": {
    "æ ‡å‡†ç­”æ¡ˆ": "æ ‡å‡†ä¸­æ–‡ç¿»è¯‘",
    "ç›¸ä¼¼åº¦": 0.000,
    "è¯´æ˜": "å¯é€‰ï¼Œè‹¥æ— åˆ™ç•™ç©ºå­—ç¬¦ä¸²"
  }
}

å¾…è¯„ä¼°çš„è¯æ±‡ä¸å­¦ç”Ÿç­”æ¡ˆï¼š
${e.map(o=>{const s=(L.get(o)||"ï¼ˆåŸæ–‡æœªæä¾›è¯­å¢ƒï¼‰").replace(/\s+/g," ").trim(),i=t[o]&&t[o].trim()?t[o].trim():"(ç©ºç™½)";return`- è‹±æ–‡è¯æ±‡: ${o}
  åŸæ–‡è¯­å¢ƒ: ${s}
  å­¦ç”Ÿç¿»è¯‘: ${i}`}).join(`
`)}`}function fe(e,t){console.log("[Parse Response] å¼€å§‹è§£æAIå›å¤:",e),console.log("[Parse Response] éœ€è¦è§£æçš„è¯æ±‡:",t);try{const n=e.match(/\{[\s\S]*\}/);if(console.log("[Parse Response] JSONåŒ¹é…ç»“æœ:",n?n[0]:"null"),!n)throw console.warn("[Parse Response] æœªæ‰¾åˆ°JSONæ ¼å¼ï¼Œä½¿ç”¨fallbackè§£æ"),new Error("æ— æ³•è§£æAIå›å¤æ ¼å¼");const o=JSON.parse(n[0]);console.log("[Parse Response] JSONè§£ææˆåŠŸ:",o);const r={};return t.forEach(s=>{console.log(`[Parse Response] å¤„ç†è¯æ±‡: ${s}`);const i=o[s]||o[s.trim()]||null;if(i&&typeof i=="object"){const a=i.ç›¸ä¼¼åº¦??i.similarity??i.score,u=ge(typeof a=="string"?parseFloat(a):a),l=(i.æ ‡å‡†ç­”æ¡ˆ??i.æ­£ç¡®ç­”æ¡ˆ??"").toString().trim(),c=(i.è¯´æ˜??i.è§£é‡Š??"").toString().trim();r[s]={similarity:typeof u=="number"?u:null,standardAnswer:l||null,explanation:c||null},console.log(`[Parse Response] ${s} è§£ææˆåŠŸ - ç›¸ä¼¼åº¦:`,r[s].similarity,"æ ‡å‡†ç­”æ¡ˆ:",r[s].standardAnswer,"è¯´æ˜:",r[s].explanation)}else if(typeof i=="string"){const a=i==="æ­£ç¡®";r[s]={similarity:a?1:0,standardAnswer:null,explanation:null},console.log(`[Parse Response] ${s} ä½¿ç”¨æ—§æ ¼å¼å­—ç¬¦ä¸² - ç›¸ä¼¼åº¦æ¨¡æ‹Ÿ:`,r[s].similarity)}else console.log(`[Parse Response] ${s} æœªåœ¨è§£æç»“æœä¸­æ‰¾åˆ°ï¼Œä½¿ç”¨fallback`),r[s]={similarity:null,standardAnswer:null,explanation:null}}),console.log("[Parse Response] æœ€ç»ˆè§£æç»“æœ:",r),r}catch(n){console.error("[Parse Response] JSONè§£æå¤±è´¥:",n),console.log("[Parse Response] ä½¿ç”¨fallbackè§£ææ–¹æ³•");const o={};return t.forEach(r=>{const s=r.toLowerCase(),i=e.toLowerCase();o[r]={similarity:i.includes(s)?.5:null,standardAnswer:null,explanation:null},console.log(`[Parse Response] ${r} fallbackç»“æœ - ç›¸ä¼¼åº¦: ${o[r].similarity}`)}),console.log("[Parse Response] Fallbackæœ€ç»ˆç»“æœ:",o),o}}function kt(e,t,n={}){const{suppressToast:o=!1}=n||{};q=e||{};const r=Object.values(e).map(c=>typeof c.similarity=="number"?c.similarity:null).filter(c=>c!==null),s=r.length?Math.round(r.reduce((c,d)=>c+d,0)/r.length*100)/100:0,i=r.filter(c=>c>=H).length,a=r.filter(c=>c<H&&c>=et).length,u=H.toFixed(2),l=et.toFixed(2);lt.innerHTML=`
    <div>åˆ¤é¢˜å®Œæˆï¼</div>
    <div class="score-line">
      <span>å¹³å‡ç›¸ä¼¼åº¦ï¼š<strong>${s.toFixed(2)}</strong></span>
      <span>é«˜åŒ¹é…(â‰¥${u}): <strong>${i}</strong></span>
      <span>ä¸­ç­‰åŒ¹é…(â‰¥${l}): <strong>${a}</strong></span>
      <span>æ€»è¯æ•°: <strong>${t}</strong></span>
    </div>
  `,Object.entries(e).forEach(([c,d])=>{const g=document.querySelector(`[data-term="${c}"]`)?.closest(".item");if(!g)return;g.classList.remove("correct","incorrect","partial");const m=typeof d.similarity=="number"?d.similarity:null;let A="incorrect";m!==null&&(m>=H?A="correct":m>=et&&(A="partial")),g.classList.add(A);const v=g.querySelector(".term");if(!v)return;let b=v.querySelector(".grade-indicator");b||(b=document.createElement("span"),b.className="grade-indicator",v.appendChild(b)),b.className=`grade-indicator ${A}`,b.textContent=m!==null?m.toFixed(2):"â€”",b.title="è¯­ä¹‰ç›¸ä¼¼åº¦ (0-1)";let E=g.querySelector(".grading-details");if(E||(E=document.createElement("div"),E.className="grading-details",g.appendChild(E)),E.innerHTML="",m!==null){const I=document.createElement("div"),$=document.createElement("strong");$.textContent="ç›¸ä¼¼åº¦:",I.appendChild($),I.appendChild(document.createTextNode(" "+m.toFixed(2))),E.appendChild(I)}if(d.standardAnswer){const I=document.createElement("div"),$=document.createElement("strong");$.textContent="æ ‡å‡†ç­”æ¡ˆ:",I.appendChild($),I.appendChild(document.createTextNode(" "+d.standardAnswer)),E.appendChild(I)}if(d.explanation){const I=document.createElement("div"),$=document.createElement("strong");$.textContent="è¯´æ˜:",I.appendChild($),I.appendChild(document.createTextNode(" "+d.explanation)),E.appendChild(I)}E.hasChildNodes()||E.remove()}),D.style.display="block",C.style.display="none",o||w(`åˆ¤é¢˜å®Œæˆï¼å¹³å‡ç›¸ä¼¼åº¦ ${s.toFixed(2)}`,"ok")}function Bt(){q={},document.querySelectorAll(".item").forEach(e=>{e.classList.remove("correct","incorrect","partial");const t=e.querySelector(".grade-indicator");t&&t.remove();const n=e.querySelector(".grading-details");n&&n.remove()})}async function pe(e,t,n="gpt-3.5-turbo"){console.log("[AI Identity] å¼€å§‹æ£€æµ‹AIèº«ä»½"),console.log("[AI Identity] API URL:",e),console.log("[AI Identity] æ¨¡å‹:",n),console.log("[AI Identity] API Key é•¿åº¦:",t?t.length:0);const o={model:n,messages:[{role:"user",content:"ä½ å¥½ï¼Œè¯·è¯¦ç»†ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ï¼ŒåŒ…æ‹¬ä½ çš„åç§°ã€ç‰ˆæœ¬ã€ä¸»è¦åŠŸèƒ½å’Œç‰¹è‰²ã€‚"}],temperature:.1,max_tokens:200};console.log("[AI Identity] è¯·æ±‚ä½“:",JSON.stringify(o,null,2));const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(o)});if(console.log("[AI Identity] å“åº”çŠ¶æ€:",r.status,r.statusText),!r.ok){const u=await r.text();throw console.error("[AI Identity] APIé”™è¯¯å“åº”:",u),new Error(`${r.status} ${r.statusText}: ${u}`)}const s=await r.json();console.log("[AI Identity] APIå“åº”:",s);const i=s?.choices?.[0]?.message;if(!i)throw console.error("[AI Identity] å“åº”æ ¼å¼å¼‚å¸¸:",s),new Error("APIå“åº”æ ¼å¼å¼‚å¸¸");const a=K(i);if(!a)throw console.error("[AI Identity] æœªè·å¾—æ–‡æœ¬å›å¤:",i),new Error("AIæœªè¿”å›æ–‡æœ¬ä¿¡æ¯");return console.log("[AI Identity] AIå›å¤:",a),a}async function ye(e){const t=Number(e);if(!Number.isInteger(t)||t<=0){h(`æ— æ³•è¯†åˆ«çš„å†å²è®°å½•ç¼–å·ï¼š${e}`,"warn");return}const n=Y();if(!n){h("è¯·å…ˆé…ç½®æœåŠ¡å™¨åœ°å€å†åŠ è½½å†å²è®°å½•ã€‚","warn");return}const o=`${n.replace(/\/$/,"")}/api/sessions/${t}`;h(`æ­£åœ¨åŠ è½½å†å²è®°å½• #${t}â€¦`,"info");try{const r=await fetch(o,{headers:{Accept:"application/json"}});if(!r.ok){const c=await r.text();throw new Error(`HTTP ${r.status} ${r.statusText}: ${c}`)}const s=await r.json(),i=s?.session||{},a=Array.isArray(s?.results)?s.results:[],u=typeof i.article=="string"?i.article:"";typeof N<"u"&&(N=u),R&&(R.value=u),pt(u||"",[]),X();const l={};if(a.forEach(c=>{if(!c||typeof c.term!="string")return;const d=c.term.trim();if(!d)return;const g=typeof c.similarity=="number"?c.similarity:Number(c.similarity),m=c.standard_answer||c.standardAnswer||null,A=c.explanation||null;l[d]={similarity:Number.isFinite(g)?g:null,standardAnswer:m,explanation:A},c.context&&L&&L.set(d,c.context)}),Object.keys(l).length?kt(l,i.total_terms||a.length,{suppressToast:!0}):(Bt(),D.style.display="none"),lt){const c=i.submitted_at?new Date(i.submitted_at):null,d=typeof i.avg_similarity=="number"?i.avg_similarity:Number(i.avg_similarity),g=[];c&&!Number.isNaN(c.getTime())&&g.push(`æäº¤æ—¶é—´ï¼š${c.toLocaleString()}`),g.push(`æ€»è¯æ•°ï¼š${i.total_terms??a.length}`),Number.isFinite(d)&&g.push(`å¹³å‡ç›¸ä¼¼åº¦ï¼š${d.toFixed(2)}`),g.push(`æ­£ç¡® / éƒ¨åˆ†æ­£ç¡® / é”™è¯¯ï¼š${i.correct_terms??0} / ${i.partial_terms??0} / ${i.incorrect_terms??0}`),lt.insertAdjacentHTML("beforeend",`<div class="score-line history-note">${g.join(" ï½œ ")}</div>`)}D.style.display="block",C.style.display="none",h(`å·²åŠ è½½å†å²è®°å½• #${t}ï¼Œå¦‚éœ€é‡æ–°ç»ƒä¹ å¯ç›´æ¥ç¼–è¾‘æ–‡ç« ã€‚`,"ok"),document.body.classList.add("replay-mode")}catch(r){console.error("[History Replay] åŠ è½½å†å²è®°å½•å¤±è´¥:",r),h(`åŠ è½½å†å²è®°å½•å¤±è´¥ï¼š${r.message}`,"warn"),w("åŠ è½½å†å²è®°å½•å¤±è´¥ï¼š"+r.message,"warn")}}const It=new URLSearchParams(window.location.search).get("session");It&&ye(It);
