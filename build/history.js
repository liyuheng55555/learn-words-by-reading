import{f as D,e as T}from"./chunks/http.js";function q(e){if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}const x=document.getElementById("history-status"),g=document.getElementById("history-session-list"),O=document.getElementById("history-refresh"),p=document.getElementById("history-score-api"),R=document.getElementById("history-detail-empty"),H=document.getElementById("history-detail-content"),X=document.getElementById("history-detail-title"),Z=document.getElementById("history-detail-meta"),z=document.getElementById("history-article"),M=document.getElementById("history-results-body"),U=document.getElementById("history-open-session"),u=document.getElementById("history-copy-low"),k=document.getElementById("history-results-head"),v=document.getElementById("history-chart"),S=document.getElementById("history-chart-empty"),I=new Map;let m=[],F=[],N="term",$=!0,L=[];function f(e,t="info"){x&&(x.textContent=e||"",x.classList.remove("ok","warn"),t==="ok"&&x.classList.add("ok"),t==="warn"&&x.classList.add("warn"))}function A(){const e=p?.value?.trim();if(e)return localStorage.setItem("score-api-url",e),e;const t=localStorage.getItem("score-api-url");if(t)return p&&(p.value=t),t;const s="http://localhost:4000";return p&&(p.value=s),s}function tt(e){return Number.isFinite(e)?e>=.85?"correct":e>=.6?"partial":"incorrect":"unknown"}function et(e){if(!g)return;if(!Array.isArray(e)||!e.length){g.innerHTML='<li class="history-session-item empty">暂无历史记录，请先同步一次判题结果。</li>';return}const t=e.map(s=>{const r=q(s.submitted_at),n=Number(s.incorrect_terms)||0,i=Number(s.partial_terms)||0,c=Number(s.total_terms)||0,a=Number(s.avg_similarity),d=Number.isFinite(a)?a.toFixed(2):"—",o=n>0?"warn":"ok";return`
      <li class="history-session-item" data-id="${s.id}">
        <button type="button" class="history-session-button">
          <div class="history-session-row">
            <span class="history-session-id">#${s.id}</span>
            <span class="history-session-date">${T(r)}</span>
          </div>
          <div class="history-session-row small ${o}">
            <span>词数：${c}</span>
            <span>错误：${n}</span>
            <span>部分正确：${i}</span>
            <span>平均：${d}</span>
          </div>
        </button>
      </li>
    `}).join("");g.innerHTML=t}async function J({autoSelect:e=!1}={}){try{f("正在载入历史记录…","info");const s=`${A().replace(/\/$/,"")}/api/sessions?limit=100`,r=await D(s),n=Array.isArray(r?.sessions)?r.sessions:[];et(n),f(`已载入 ${n.length} 条历史记录`,"ok"),e&&n.length&&Q(Number(n[0].id))}catch(t){console.error("[History] 获取历史记录失败:",t),f(`加载失败：${t.message}`,"warn"),g.innerHTML='<li class="history-session-item empty warn">无法加载历史记录。</li>'}}async function K(e=7){try{const s=`${A().replace(/\/$/,"")}/api/stats/daily?days=${encodeURIComponent(e)}`,r=await D(s),n=Array.isArray(r?.stats)?r.stats:[];L=it(n,e),S&&S.classList.toggle("hidden",L.some(i=>i.practiced||i.below_zero||i.above_two)),G(L)}catch(t){console.error("[History] 获取每日统计失败:",t),S&&(S.classList.remove("hidden"),S.textContent=`无法加载趋势数据：${t.message}`)}}function st(e=""){return typeof e!="string"||!e.trim()?"<p>（无文章内容记录）</p>":e.split(/\n\n+/).map(r=>`<p>${r.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function rt(e){const t=Array.isArray(e)?[...e]:[],s=$?1:-1;return t.sort((r,n)=>{switch(N){case"similarity":{const i=Number(r?.similarity),c=Number(n?.similarity),a=Number.isFinite(i),d=Number.isFinite(c);return!a&&!d?0:a?d?i===c?(r.term||"").localeCompare(n.term||"")*s:(i-c)*s:-1*s:1*s}case"standard":{const i=(r?.standard_answer||r?.standardAnswer||"").toString(),c=(n?.standard_answer||n?.standardAnswer||"").toString(),a=i.localeCompare(c,"zh",{sensitivity:"base"});return a===0?(r.term||"").localeCompare(n.term||"")*s:a*s}case"explanation":{const i=(r?.explanation||"").toString(),c=(n?.explanation||"").toString(),a=i.localeCompare(c,"zh",{sensitivity:"base"});return a===0?(r.term||"").localeCompare(n.term||"")*s:a*s}case"term":default:return(r?.term||"").localeCompare(n?.term||"","en",{sensitivity:"base"})*s}}),t}function W(){if(!k)return;k.querySelectorAll("th[data-sort]").forEach(t=>{const s=t.dataset.sort;s&&(t.classList.add("sortable"),s===N?(t.classList.add("active"),t.dataset.indicator=$?"↑":"↓"):(t.classList.remove("active"),t.dataset.indicator=""))})}function Y(){if(!M)return;const e=rt(F);if(!e.length){M.innerHTML='<tr><td colspan="4" class="empty">未记录判题结果。</td></tr>',m=[],u&&(u.disabled=!0,u.textContent="复制 ≤0.5 词"),W();return}const t=e.map(s=>{const r=T(s.term),n=typeof s.similarity=="number"?s.similarity:Number(s.similarity),i=Number.isFinite(n)?n.toFixed(2):"—",c=tt(Number.isFinite(n)?n:NaN),a=T(s.standard_answer||s.standardAnswer||""),d=T(s.explanation||"");return`
      <tr class="history-result-${c}">
        <td>${r||"—"}</td>
        <td>${i}</td>
        <td>${a||"—"}</td>
        <td>${d||"—"}</td>
      </tr>
    `}).join("");M.innerHTML=t,m=e.filter(s=>{if(!s||typeof s.term!="string")return!1;const r=typeof s.similarity=="number"?s.similarity:Number(s.similarity);return Number.isFinite(r)&&r<=.5}).map(s=>s.term.trim()).filter(Boolean),u&&(m.length?(u.disabled=!1,u.textContent=`复制 ≤0.5 词 (${m.length})`):(u.disabled=!0,u.textContent="暂无低分词")),W()}function nt(e){if(!e)return null;const t=window.devicePixelRatio||1,s=e.getBoundingClientRect();e.width=s.width*t,e.height=s.height*t;const r=e.getContext("2d");return r&&r.scale(t,t),r}function G(e){if(!v)return;const t=nt(v);if(!t)return;if(!e||!e.length){t.clearRect(0,0,v.width,v.height),S&&S.classList.remove("hidden");return}const s=v.getBoundingClientRect().width,r=v.getBoundingClientRect().height;t.clearRect(0,0,s,r);const n=e.map(l=>l.day),i=e.map(l=>Number(l.practiced)||0),c=e.map(l=>Number(l.below_zero)||0),a=e.map(l=>Number(l.above_two)||0),d=Math.max(5,...i,...c,...a),o={top:16,right:24,bottom:32,left:40},b=s-o.left-o.right,y=r-o.top-o.bottom;t.strokeStyle="rgba(147, 161, 161, 0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(o.left,o.top),t.lineTo(o.left,o.top+y),t.lineTo(o.left+b,o.top+y),t.stroke();const P=Math.min(4,d);t.fillStyle="var(--muted)",t.font="12px sans-serif";for(let l=0;l<=P;l++){const w=Math.round(d/P*l),h=o.top+y-y*(w/d);t.fillText(String(w),6,h+4),t.strokeStyle="rgba(147, 161, 161, 0.15)",t.beginPath(),t.moveTo(o.left,h),t.lineTo(o.left+b,h),t.stroke()}n.forEach((l,w)=>{const h=o.left+b/Math.max(1,n.length-1)*w,E=o.top+y+16;t.fillStyle="var(--muted)",t.fillText(l.slice(5),h-18,E)});function B(l,w){t.strokeStyle=w,t.lineWidth=2,t.beginPath(),l.forEach((h,E)=>{const _=o.left+b/Math.max(1,l.length-1)*E,C=o.top+y-y*(h/d);E===0?t.moveTo(_,C):t.lineTo(_,C)}),t.stroke(),l.forEach((h,E)=>{const _=o.left+b/Math.max(1,l.length-1)*E,C=o.top+y-y*(h/d);t.fillStyle=w,t.beginPath(),t.arc(_,C,3,0,Math.PI*2),t.fill()})}B(i,"#268bd2"),B(c,"#dc322f"),B(a,"#859900")}function it(e,t=7){const s=new Date,r=[];for(let n=t-1;n>=0;n--){const i=new Date(s);i.setDate(s.getDate()-n);const c=i.toISOString().slice(0,10),a=e.find(d=>d.day===c);a?r.push(a):r.push({day:c,practiced:0,below_zero:0,above_two:0})}return r}function j(e){if(!H||!R)return;if(!e||!e.session){m=[],u&&(u.disabled=!0,u.textContent="复制 ≤0.5 词"),H.classList.add("hidden"),R.classList.remove("hidden");return}R.classList.add("hidden"),H.classList.remove("hidden");const{session:t,results:s}=e,r=q(t.submitted_at),n=Number(t.total_terms)||(Array.isArray(s)?s.length:0),i=Number(t.avg_similarity),c=Number.isFinite(i)?i.toFixed(2):"—",a=Number(t.correct_terms)||0,d=Number(t.partial_terms)||0,o=Number(t.incorrect_terms)||0;if(X.textContent=`历史记录 #${t.id}`,Z.textContent=`提交时间：${r} ｜ 总词数：${n} ｜ 平均相似度：${c} ｜ 正确/部分/错误：${a}/${d}/${o}`,U&&(U.href=`geo_vocab_fill_in_webpage_english→chinese.html?session=${t.id}`),z){const b=st(t.article||"");z.innerHTML=b}N="term",$=!0,F=Array.isArray(s)?[...s]:[],Y()}async function Q(e){if(!Number.isInteger(e)||e<=0)return;Array.from(g?.querySelectorAll(".history-session-item.active")||[]).forEach(s=>{s.classList.remove("active")});const t=g?.querySelector(`.history-session-item[data-id="${e}"]`);if(t&&t.classList.add("active"),I.has(e)){j(I.get(e));return}try{f(`正在加载记录 #${e}…`,"info");const r=`${A().replace(/\/$/,"")}/api/sessions/${e}`,n=await D(r);I.set(e,n),j(n),f(`已加载记录 #${e}`,"ok")}catch(s){console.error("[History] 加载详情失败:",s),f(`加载记录 #${e} 失败：${s.message}`,"warn")}}p&&p.addEventListener("change",()=>{const e=p.value.trim();e&&localStorage.setItem("score-api-url",e),K(7)});O&&O.addEventListener("click",()=>{I.clear(),J({autoSelect:!1})});g&&g.addEventListener("click",e=>{const t=e.target.closest(".history-session-item");if(!t)return;const s=Number(t.dataset.id);Number.isInteger(s)&&Q(s)});k&&k.addEventListener("click",e=>{const t=e.target.closest("th[data-sort]");if(!t)return;const s=t.dataset.sort;s&&F.length&&(N===s?$=!$:(N=s,$=!0),Y())});window.addEventListener("resize",()=>{L.length&&G(L)});function V(e){const t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="fixed",t.style.top="-9999px",document.body.appendChild(t),t.select();let s=!1;try{s=document.execCommand("copy")}catch{s=!1}return document.body.removeChild(t),s}async function ot(){if(!Array.isArray(m)||!m.length){f("当前记录没有相似度 ≤0.5 的词汇","warn");return}const e=m.join(", ");try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(e);else if(!V(e))throw new Error("无法访问剪贴板");f(`已复制 ${m.length} 个词汇到剪贴板`,"ok")}catch(t){V(e)?f(`已复制 ${m.length} 个词汇到剪贴板`,"ok"):f(`复制失败：${t.message}`,"warn")}}u&&u.addEventListener("click",ot);A();K(7);J({autoSelect:!0});
