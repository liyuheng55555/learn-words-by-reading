import{f as Y,e as B}from"./chunks/html.js";import{l as mt,d as vt,m as xt,a as _t}from"./chunks/history-storage.js";function ft(e){if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}const U=document.getElementById("history-status"),_=document.getElementById("history-session-list"),ot=document.getElementById("history-refresh"),x=document.getElementById("history-score-api"),J=document.getElementById("history-detail-empty"),K=document.getElementById("history-detail-content"),at=document.getElementById("history-detail-title"),ct=document.getElementById("history-detail-meta"),lt=document.getElementById("history-article"),tt=document.getElementById("history-results-body"),v=document.getElementById("history-open-session"),b=document.getElementById("history-copy-low"),l=document.getElementById("history-score-record"),f=document.getElementById("history-delete-record"),Q=document.getElementById("history-results-head"),H=document.getElementById("history-chart"),C=document.getElementById("history-chart-empty"),q=document.getElementById("history-toggle-meaning"),X=new Map;let E=[],st=[],G="term",M=!0,W=[],z=!0,et=mt(),P=[],k=new Map,V=[],I=null,F=null,d=null;l&&!l.dataset.originalText&&(l.dataset.originalText=l.textContent||"计分",l.classList.add("hidden"));f&&!f.dataset.originalText&&(f.dataset.originalText=f.textContent||"删除",f.classList.add("hidden"));function u(e,t="info"){U&&(U.textContent=e||"",U.classList.remove("ok","warn"),t==="ok"&&U.classList.add("ok"),t==="warn"&&U.classList.add("warn"))}function j(){const e=x?.value?.trim();if(e)return localStorage.setItem("score-api-url",e),e;const t=localStorage.getItem("score-api-url");if(t)return x&&(x.value=t),t;const s="http://localhost:4000";return x&&(x.value=s),s}function $t(e){return Number.isFinite(e)?e>=.85?"correct":e>=.6?"partial":"incorrect":"unknown"}function g(e,t=0){const s=Number(e);return Number.isFinite(s)?s:t}function Z(e){const t=Number(e);return Number.isFinite(t)?t:null}function yt(e){return e?"已计分":"未计分"}function ht(e){return e?"scored":"unscored"}function Nt(){const e=[],t=Array.isArray(et)?et:[],s=new Set;t.forEach(r=>{!r||typeof r!="object"||(Number.isInteger(r.sessionId)&&s.add(Number(r.sessionId)),e.push({id:`local-${r.id}`,source:"local",status:r.status==="submitted"?"submitted":"pending",createdAt:r.createdAt,submittedAt:r.submittedAt,sessionId:Number.isInteger(r.sessionId)?Number(r.sessionId):null,summary:r.summary||{total:0,correct:0,partial:0,incorrect:0,avg:null},article:r.article||"",results:Array.isArray(r.results)?r.results:[],recordId:r.id,record:r,scored:r.scored===!0}))}),(Array.isArray(P)?P:[]).forEach(r=>{if(!r||typeof r!="object")return;const c=g(r.id,null);c&&s.has(c)||e.push({id:`remote-${r.id}`,source:"remote",status:"submitted",createdAt:r.submitted_at,submittedAt:r.submitted_at,sessionId:c,summary:{total:g(r.total_terms),correct:g(r.correct_terms),partial:g(r.partial_terms),incorrect:g(r.incorrect_terms),avg:Z(r.avg_similarity)},session:r,scored:!!Number(r.scored)})}),e.sort((r,c)=>{if(r.scored!==c.scored)return r.scored?1:-1;const o=new Date(r.submittedAt||r.createdAt).getTime(),n=new Date(c.submittedAt||c.createdAt).getTime();return Number.isFinite(n)&&Number.isFinite(o)?n-o:Number.isFinite(n)?-1:Number.isFinite(o)?1:0});const a=new Map;return e.forEach(r=>{a.set(r.id,r)}),k=a,V=e,e}function Tt(e){if(!_)return;if(!Array.isArray(e)||!e.length){_.innerHTML='<li class="history-session-item empty">暂无判题记录，请先完成一次判题。</li>';return}const t=e.map(s=>{const i=s.submittedAt||s.createdAt,a=i?ft(i):"—",r=s.summary||{},c=g(r.total),o=g(r.incorrect),n=g(r.partial),h=Z(r.avg),y=Number.isFinite(h)?h.toFixed(2):"—",A=o>0?"warn":"ok",L=ht(s.scored),m=yt(s.scored),S=s.sessionId?`#${s.sessionId}`:s.source==="local"?`本地 · ${s.recordId.slice(-6)}`:`#${s.id}`;return`
      <li class="history-session-item" data-id="${s.id}">
        <button type="button" class="history-session-button">
          <div class="history-session-row">
            <span class="history-session-id">${B(S)}</span>
            <span class="history-session-date">${B(a)}</span>
          </div>
          <div class="history-session-row small ${A}">
            <span>词数：${c}</span>
            <span>错误：${o}</span>
            <span>部分正确：${n}</span>
            <span>平均：${y}</span>
            <span class="history-session-status ${L}">${m}</span>
          </div>
        </button>
      </li>
    `}).join("");_.innerHTML=t,I&&rt(I)}function $({autoSelect:e=!1}={}){if(et=mt(),Nt(),Tt(V),V.length===0){K?.classList.add("hidden"),J?.classList.remove("hidden"),I=null;return}if(I&&k.has(I)){rt(I);return}e&&Ct()}function Ct(){if(!V.length)return;const e=V[0];e&&bt(e.id)}function rt(e){if(!_||(Array.from(_.querySelectorAll(".history-session-item.active")||[]).forEach(s=>{s.classList.remove("active")}),!e))return;const t=_.querySelector(`.history-session-item[data-id="${e}"]`);t&&t.classList.add("active")}async function R({autoSelect:e=!1}={}){try{u("正在载入判题历史（已提交）…","info");const s=`${j().replace(/\/$/,"")}/api/sessions?limit=100`,i=await Y(s);P=Array.isArray(i?.sessions)?i.sessions:[],$({autoSelect:e}),u(`已载入 ${P.length} 条已提交记录`,"ok")}catch(t){console.error("[History] 获取历史记录失败:",t),u(`云端记录加载失败：${t.message}`,"warn"),$({autoSelect:!1})}}async function gt(e=7){try{const s=`${j().replace(/\/$/,"")}/api/stats/daily?days=${encodeURIComponent(e)}`,i=await Y(s),a=Array.isArray(i?.stats)?i.stats:[];W=Ht(a,e),C&&C.classList.toggle("hidden",W.some(r=>r.practiced||r.below_zero||r.above_two)),pt(W)}catch(t){console.error("[History] 获取每日统计失败:",t),C&&(C.classList.remove("hidden"),C.textContent=`无法加载趋势数据：${t.message}`)}}function kt(e=""){return typeof e!="string"||!e.trim()?"<p>（无文章内容记录）</p>":e.split(/\n\n+/).map(i=>`<p>${i.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function Rt(e){const t=Array.isArray(e)?[...e]:[],s=M?1:-1;return t.sort((i,a)=>{switch(G){case"similarity":{const r=Number(i?.similarity),c=Number(a?.similarity),o=Number.isFinite(r),n=Number.isFinite(c);return!o&&!n?0:o?n?r===c?(i.term||"").localeCompare(a.term||"")*s:(r-c)*s:-1*s:1*s}case"standard":{const r=(i?.standard_answer||i?.standardAnswer||"").toString(),c=(a?.standard_answer||a?.standardAnswer||"").toString(),o=r.localeCompare(c,"zh",{sensitivity:"base"});return o===0?(i.term||"").localeCompare(a.term||"")*s:o*s}case"explanation":{const r=(i?.explanation||"").toString(),c=(a?.explanation||"").toString(),o=r.localeCompare(c,"zh",{sensitivity:"base"});return o===0?(i.term||"").localeCompare(a.term||"")*s:o*s}case"term":default:return(i?.term||"").localeCompare(a?.term||"","en",{sensitivity:"base"})*s}}),t}function dt(){if(!Q)return;Q.querySelectorAll("th[data-sort]").forEach(t=>{const s=t.dataset.sort;s&&(t.classList.add("sortable"),s===G?(t.classList.add("active"),t.dataset.indicator=M?"↑":"↓"):(t.classList.remove("active"),t.dataset.indicator=""))})}function nt(){if(!tt)return;const e=Rt(st);if(!e.length){tt.innerHTML='<tr><td colspan="4" class="empty">未记录判题结果。</td></tr>',E=[],b&&(b.disabled=!0,b.textContent="复制 ≤0.5 词"),dt();return}const t=e.map(s=>{const i=B(s.term),a=typeof s.similarity=="number"?s.similarity:Number(s.similarity),r=Number.isFinite(a)?a.toFixed(2):"—",c=$t(Number.isFinite(a)?a:NaN),o=s.standard_answer||s.standardAnswer||"",n=s.explanation||"",h=z?B(o):"—",y=z?B(n):"—";return`
      <tr class="history-result-${c}">
        <td>${i||"—"}</td>
        <td>${r}</td>
        <td>${h||"—"}</td>
        <td>${y||"—"}</td>
      </tr>
    `}).join("");tt.innerHTML=t,E=e.filter(s=>{if(!s||typeof s.term!="string")return!1;const i=typeof s.similarity=="number"?s.similarity:Number(s.similarity);return Number.isFinite(i)&&i<=.5}).map(s=>s.term.trim()).filter(Boolean),b&&(E.length?(b.disabled=!1,b.textContent=`复制 ≤0.5 词 (${E.length})`):(b.disabled=!0,b.textContent="暂无低分词")),dt()}function Dt(e){if(!e)return null;const t=window.devicePixelRatio||1,s=e.getBoundingClientRect();e.width=s.width*t,e.height=s.height*t;const i=e.getContext("2d");return i&&i.scale(t,t),i}function pt(e){if(!H)return;const t=Dt(H);if(!t)return;if(!e||!e.length){t.clearRect(0,0,H.width,H.height),C&&C.classList.remove("hidden");return}const s=H.getBoundingClientRect().width,i=H.getBoundingClientRect().height;t.clearRect(0,0,s,i);const a=e.map(m=>m.day),r=e.map(m=>Number(m.below_zero)||0),c=e.map(m=>Number(m.above_two)||0),o=Math.max(5,...r,...c),n={top:16,right:24,bottom:32,left:40},h=s-n.left-n.right,y=i-n.top-n.bottom;t.strokeStyle="rgba(147, 161, 161, 0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(n.left,n.top),t.lineTo(n.left,n.top+y),t.lineTo(n.left+h,n.top+y),t.stroke();const A=Math.min(4,o);t.fillStyle="var(--muted)",t.font="12px sans-serif";for(let m=0;m<=A;m++){const S=Math.round(o/A*m),p=n.top+y-y*(S/o);t.fillText(String(S),6,p+4),t.strokeStyle="rgba(147, 161, 161, 0.15)",t.beginPath(),t.moveTo(n.left,p),t.lineTo(n.left+h,p),t.stroke()}a.forEach((m,S)=>{const p=n.left+h/Math.max(1,a.length-1)*S,w=n.top+y+16;t.fillStyle="var(--muted)",t.fillText(m.slice(5),p-18,w)});function L(m,S){t.strokeStyle=S,t.lineWidth=2,t.beginPath(),m.forEach((p,w)=>{const D=n.left+h/Math.max(1,m.length-1)*w,N=n.top+y-y*(p/o);w===0?t.moveTo(D,N):t.lineTo(D,N)}),t.stroke(),m.forEach((p,w)=>{const D=n.left+h/Math.max(1,m.length-1)*w,N=n.top+y-y*(p/o);t.fillStyle=S,t.beginPath(),t.arc(D,N,3,0,Math.PI*2),t.fill()})}L(r,"#dc322f"),L(c,"#859900")}function Ht(e,t=7){const s=new Date,i=[];for(let a=t-1;a>=0;a--){const r=new Date(s);r.setDate(s.getDate()-a);const c=r.toISOString().slice(0,10),o=e.find(n=>n.day===c);o?i.push(o):i.push({day:c,practiced:0,below_zero:0,above_two:0})}return i}function O(e,t={}){if(!K||!J)return;const{source:s="remote",status:i="submitted",recordId:a=null}=t,r=I?k.get(I):null,c=!!Number(e?.session?.scored),o=r&&r.scored===!0||c;if(!e||!e.session){E=[],b&&(b.disabled=!0,b.textContent="复制 ≤0.5 词"),d=null,l&&(l.classList.add("hidden"),l.disabled=!0,delete l.dataset.recordId),v&&(v.classList.add("hidden"),v.removeAttribute("href")),K.classList.add("hidden"),J.classList.remove("hidden");return}J.classList.add("hidden"),K.classList.remove("hidden");const{session:n,results:h}=e,y=n.submitted_at||n.created_at||n.createdAt||"",A=y?ft(y):"—",L=g(n.total_terms,Array.isArray(h)?h.length:0),m=Z(n.avg_similarity),S=Number.isFinite(m)?m.toFixed(2):"—",p=g(n.correct_terms),w=g(n.partial_terms),D=Math.max(0,L-p-w),N=g(n.incorrect_terms,D),It=yt(o),St=ht(o),wt="记录时间",Et=s==="remote"?"判题记录":"本地判题",it=n.id||(a?`本地-${a.slice(-6)}`:""),At=it?` #${it}`:"";if(at&&(at.textContent=`${Et}${At}`),ct){const T=[`状态：<span class="history-session-status ${St}">${It}</span>`,`${wt}：${B(A)}`,`总词数：${L}`,`平均相似度：${S}`,`正确/部分/错误：${p}/${w}/${N}`];ct.innerHTML=T.join(" ｜ ")}if(v){const T=g(n.session_id??n.id,null);(s==="remote"||i==="submitted")&&T?(v.href=`geo_vocab_fill_in_webpage_english→chinese.html?session=${T}`,v.classList.remove("hidden")):(v.classList.add("hidden"),v.removeAttribute("href"))}if(lt){const T=kt(n.article||"");lt.innerHTML=T}G="term",M=!0,st=Array.isArray(h)?[...h]:[],nt();const Lt=g(n.session_id??n.id,null);d={entryId:I,source:s,recordId:a,sessionId:Lt,article:n.article||"",results:Array.isArray(h)?[...h]:[],sessionData:{...n}},l&&(o||!d.results.length||s==="remote"&&!d.sessionId?(l.classList.add("hidden"),l.disabled=!0,delete l.dataset.recordId):(l.classList.remove("hidden"),l.disabled=!1,a?l.dataset.recordId=a:delete l.dataset.recordId)),f&&(s==="local"||s==="remote"&&!o?(f.classList.remove("hidden"),f.disabled=!1,f.dataset.entryId=I||"",a?f.dataset.recordId=a:f.dataset.recordId=""):(f.classList.add("hidden"),f.disabled=!0,f.dataset.recordId="",f.dataset.entryId="")),r&&(r.session=n,r.scored=o,r.summary=r.summary||{},r.summary.total=L,r.summary.correct=p,r.summary.partial=w,r.summary.incorrect=N,r.summary.avg=m),s==="remote"&&(o?u("该判题记录已计分，可继续复盘。","ok"):u("该判题记录尚未计分，点击“计分”按钮即可累计到总分。","warn"))}function Bt(e){if(!e||!e.record){O(null);return}const t=e.record,s=t.summary||{},i=g(s.total,Array.isArray(t.results)?t.results.length:0),a=Number.isInteger(t.sessionId)?t.sessionId:null,r=Z(s.avg),c={id:a??`本地-${t.id.slice(-6)}`,session_id:a,submitted_at:t.submittedAt||t.createdAt,total_terms:i,correct_terms:g(s.correct),partial_terms:g(s.partial),incorrect_terms:g(s.incorrect,Math.max(0,i-g(s.correct)-g(s.partial))),avg_similarity:r,article:t.article||""},o=Array.isArray(t.results)?t.results.map(n=>({term:n.term,similarity:Number.isFinite(n.similarity)?n.similarity:Number.isFinite(Number(n.similarity))?Number(n.similarity):null,standard_answer:n.standard_answer??n.standardAnswer??null,explanation:n.explanation??null,context:n.context??null})):[];O({session:c,results:o},{source:"local",status:e.status,recordId:t.id}),l&&(e.scored?(l.classList.add("hidden"),l.disabled=!0,l.dataset.recordId=t.id):(l.classList.remove("hidden"),l.disabled=!1,l.dataset.recordId=t.id)),e.scored?u("该判题记录已计入总分，可继续复盘。","ok"):u("该判题记录尚未计分，点击上方“计分”按钮可累计到总分。","warn")}async function bt(e){if(!e||!k.has(e))return;I=e,rt(e);const t=k.get(e);if(!t)return;if(t.source==="local"){Bt(t);return}const s=t.sessionId;if(!s){O(null);return}const i=`remote-${s}`;if(X.has(i)){O(X.get(i),{source:"remote",status:"submitted"});return}try{u(`正在加载记录 #${s}…`,"info");const r=`${j().replace(/\/$/,"")}/api/sessions/${s}`,c=await Y(r);X.set(i,c),O(c,{source:"remote",status:"submitted"}),u(`已加载记录 #${s}`,"ok")}catch(a){console.error("[History] 加载详情失败:",a),u(`加载记录 #${s} 失败：${a.message}`,"warn")}}x&&x.addEventListener("change",()=>{const e=x.value.trim();e&&localStorage.setItem("score-api-url",e),gt(7),R({autoSelect:!1})});ot&&ot.addEventListener("click",()=>{X.clear(),$({autoSelect:!1}),R({autoSelect:!1})});q&&(localStorage.getItem("history-show-meaning")==="false"&&(z=!1,q.checked=!1),q.addEventListener("change",()=>{z=!!q.checked,localStorage.setItem("history-show-meaning",z?"true":"false"),nt()}));_&&_.addEventListener("click",e=>{const t=e.target.closest(".history-session-item");if(!t)return;const s=t.dataset.id;s&&bt(s)});Q&&Q.addEventListener("click",e=>{const t=e.target.closest("th[data-sort]");if(!t)return;const s=t.dataset.sort;s&&st.length&&(G===s?M=!M:(G=s,M=!0),nt())});window.addEventListener("resize",()=>{W.length&&pt(W)});function Mt(e){return Array.isArray(e)?e.map(t=>{if(!t||typeof t!="object")return null;const s=typeof t.term=="string"?t.term.trim():"";if(!s)return null;const i=Number(t.similarity);return Number.isFinite(i)?{term:s,similarity:i,standard_answer:typeof t.standard_answer=="string"?t.standard_answer:null,explanation:typeof t.explanation=="string"?t.explanation:null,context:typeof t.context=="string"?t.context:null}:null}).filter(Boolean):[]}async function Ft(){if(!l)return;if(!d||!Array.isArray(d.results)||!d.results.length){u("当前记录缺少判题结果，无法计分。","warn");return}const e=Mt(d.results);if(!e.length){u("该判题记录没有可计分的相似度数据。","warn");return}const s=`${j().replace(/\/$/,"")}/api/word-scores`,i=l.dataset.originalText||l.textContent||"计分";l.disabled=!0,l.textContent="计分中…",u("正在将判题结果计入总分…","info");const a={results:e,article:d.article||""};Number.isInteger(d.sessionId)&&d.sessionId>0&&(a.session_id=d.sessionId);try{const c=(await Y(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}))?.session_id,o=Number(c),n=d.entryId?k.get(d.entryId):null;if(d.recordId&&(xt(d.recordId,{sessionId:o,submittedAt:new Date().toISOString()}),_t(d.recordId,{sessionId:o})),n&&(n.scored=!0,Number.isInteger(o)&&o>0&&(n.sessionId=o)),d&&(d.sessionId=Number.isInteger(o)&&o>0?o:d.sessionId,d.sessionData&&(d.sessionData.scored=1,Number.isInteger(o)&&o>0&&(d.sessionData.id=o,d.sessionData.session_id=o))),Number.isInteger(o)&&o>0&&Array.isArray(P)){const y=P.find(A=>Number(A?.id)===Number(o));y&&(y.scored=1)}const h=Number.isInteger(o)&&o>0?`计分成功！历史记录 #${o}`:"计分成功，已累计到总分";if(u(h,"ok"),l&&l.classList.add("hidden"),f&&(f.classList.add("hidden"),f.disabled=!0),d?.sessionData){const y={session:{...d.sessionData},results:Array.isArray(d.results)?[...d.results]:[]};O(y,{source:d.source,recordId:d.recordId,status:"submitted"}),u(h,"ok")}$({autoSelect:!1}),R({autoSelect:!1})}catch(r){console.error("[History] 判题计分失败:",r),u(`计分失败：${r.message}`,"warn")}finally{l.disabled=!1,l.textContent=i}}function ut(e){const t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="fixed",t.style.top="-9999px",document.body.appendChild(t),t.select();let s=!1;try{s=document.execCommand("copy")}catch{s=!1}return document.body.removeChild(t),s}async function Ot(){if(!Array.isArray(E)||!E.length){u("当前记录没有相似度 ≤0.5 的词汇","warn");return}const e=E.join(", ");try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(e);else if(!ut(e))throw new Error("无法访问剪贴板");u(`已复制 ${E.length} 个词汇到剪贴板`,"ok")}catch(t){ut(e)?u(`已复制 ${E.length} 个词汇到剪贴板`,"ok"):u(`复制失败：${t.message}`,"warn")}}b&&b.addEventListener("click",Ot);l&&l.addEventListener("click",async()=>{await Ft()});f&&f.addEventListener("click",async()=>{const e=f.dataset.entryId||d?.entryId||I;if(!e){u("未找到需要删除的判题记录。","warn");return}const t=k.get(e);if(!t){u("删除失败：记录不存在或已刷新。","warn");return}if(window.confirm(t.source==="remote"?"此记录尚未计分，删除后将无法计入总分，确定删除？":"确定要删除这条本地判题记录吗？操作不可恢复。"))try{if(t.source==="remote"){const a=`${j().replace(/\/$/,"")}/api/sessions/${t.sessionId}`;await Y(a,{method:"DELETE"}),u(`已删除判题记录 #${t.sessionId}`,"ok")}else{const i=f.dataset.recordId||t.recordId;if(!i){u("删除失败：缺少本地记录ID。","warn");return}if(!vt(i)){u("删除失败：未找到对应的本地记录。","warn");return}u("本地判题记录已删除。","ok")}d=null,I=null,$({autoSelect:!0}),R({autoSelect:!1})}catch(i){console.error("[History] 删除判题记录失败:",i),u(`删除失败：${i.message}`,"warn")}});window.addEventListener("grading-history-updated",()=>{$({autoSelect:!1}),F&&clearTimeout(F),F=setTimeout(()=>{R({autoSelect:!1})},250)});window.addEventListener("storage",e=>{e.key==="grading-history-records"&&($({autoSelect:!1}),F&&clearTimeout(F),F=setTimeout(()=>{R({autoSelect:!1})},250))});j();$({autoSelect:!0});gt(7);R({autoSelect:!1});
