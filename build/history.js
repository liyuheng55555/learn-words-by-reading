import{f as X,e as k}from"./chunks/html.js";import{l as ut,m as vt,a as _t}from"./chunks/history-storage.js";function mt(e){if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}const P=document.getElementById("history-status"),L=document.getElementById("history-session-list"),it=document.getElementById("history-refresh"),_=document.getElementById("history-score-api"),q=document.getElementById("history-detail-empty"),G=document.getElementById("history-detail-content"),ot=document.getElementById("history-detail-title"),at=document.getElementById("history-detail-meta"),ct=document.getElementById("history-article"),Z=document.getElementById("history-results-body"),v=document.getElementById("history-open-session"),p=document.getElementById("history-copy-low"),l=document.getElementById("history-score-record"),K=document.getElementById("history-results-head"),R=document.getElementById("history-chart"),x=document.getElementById("history-chart-empty"),Y=document.getElementById("history-toggle-meaning"),J=new Map;let I=[],et=[],W="term",H=!0,j=[],U=!0,tt=ut(),M=[],F=new Map,z=[],w=null,B=null,d=null;l&&!l.dataset.originalText&&(l.dataset.originalText=l.textContent||"计分",l.classList.add("hidden"));function y(e,t="info"){P&&(P.textContent=e||"",P.classList.remove("ok","warn"),t==="ok"&&P.classList.add("ok"),t==="warn"&&P.classList.add("warn"))}function V(){const e=_?.value?.trim();if(e)return localStorage.setItem("score-api-url",e),e;const t=localStorage.getItem("score-api-url");if(t)return _&&(_.value=t),t;const s="http://localhost:4000";return _&&(_.value=s),s}function Lt(e){return Number.isFinite(e)?e>=.85?"correct":e>=.6?"partial":"incorrect":"unknown"}function h(e,t=0){const s=Number(e);return Number.isFinite(s)?s:t}function Q(e){const t=Number(e);return Number.isFinite(t)?t:null}function ft(e){return e?"已计分":"未计分"}function yt(e){return e?"scored":"unscored"}function Nt(){const e=[],t=Array.isArray(tt)?tt:[],s=new Set;t.forEach(r=>{!r||typeof r!="object"||(Number.isInteger(r.sessionId)&&s.add(Number(r.sessionId)),e.push({id:`local-${r.id}`,source:"local",status:r.status==="submitted"?"submitted":"pending",createdAt:r.createdAt,submittedAt:r.submittedAt,sessionId:Number.isInteger(r.sessionId)?Number(r.sessionId):null,summary:r.summary||{total:0,correct:0,partial:0,incorrect:0,avg:null},article:r.article||"",results:Array.isArray(r.results)?r.results:[],recordId:r.id,record:r,scored:r.scored===!0}))}),(Array.isArray(M)?M:[]).forEach(r=>{if(!r||typeof r!="object")return;const c=h(r.id,null);c&&s.has(c)||e.push({id:`remote-${r.id}`,source:"remote",status:"submitted",createdAt:r.submitted_at,submittedAt:r.submitted_at,sessionId:c,summary:{total:h(r.total_terms),correct:h(r.correct_terms),partial:h(r.partial_terms),incorrect:h(r.incorrect_terms),avg:Q(r.avg_similarity)},session:r,scored:!!Number(r.scored)})}),e.sort((r,c)=>{if(r.scored!==c.scored)return r.scored?1:-1;const i=new Date(r.submittedAt||r.createdAt).getTime(),n=new Date(c.submittedAt||c.createdAt).getTime();return Number.isFinite(n)&&Number.isFinite(i)?n-i:Number.isFinite(n)?-1:Number.isFinite(i)?1:0});const a=new Map;return e.forEach(r=>{a.set(r.id,r)}),F=a,z=e,e}function xt(e){if(!L)return;if(!Array.isArray(e)||!e.length){L.innerHTML='<li class="history-session-item empty">暂无判题记录，请先完成一次判题。</li>';return}const t=e.map(s=>{const o=s.submittedAt||s.createdAt,a=o?mt(o):"—",r=s.summary||{},c=h(r.total),i=h(r.incorrect),n=h(r.partial),f=Q(r.avg),m=Number.isFinite(f)?f.toFixed(2):"—",E=i>0?"warn":"ok",A=yt(s.scored),u=ft(s.scored),b=s.sessionId?`#${s.sessionId}`:s.source==="local"?`本地 · ${s.recordId.slice(-6)}`:`#${s.id}`;return`
      <li class="history-session-item" data-id="${s.id}">
        <button type="button" class="history-session-button">
          <div class="history-session-row">
            <span class="history-session-id">${k(b)}</span>
            <span class="history-session-date">${k(a)}</span>
          </div>
          <div class="history-session-row small ${E}">
            <span>词数：${c}</span>
            <span>错误：${i}</span>
            <span>部分正确：${n}</span>
            <span>平均：${m}</span>
            <span class="history-session-status ${A}">${u}</span>
          </div>
        </button>
      </li>
    `}).join("");L.innerHTML=t,w&&st(w)}function $({autoSelect:e=!1}={}){if(tt=ut(),Nt(),xt(z),z.length===0){G?.classList.add("hidden"),q?.classList.remove("hidden"),w=null;return}if(w&&F.has(w)){st(w);return}e&&$t()}function $t(){if(!z.length)return;const e=z[0];e&&pt(e.id)}function st(e){if(!L||(Array.from(L.querySelectorAll(".history-session-item.active")||[]).forEach(s=>{s.classList.remove("active")}),!e))return;const t=L.querySelector(`.history-session-item[data-id="${e}"]`);t&&t.classList.add("active")}async function O({autoSelect:e=!1}={}){try{y("正在载入判题历史（已提交）…","info");const s=`${V().replace(/\/$/,"")}/api/sessions?limit=100`,o=await X(s);M=Array.isArray(o?.sessions)?o.sessions:[],$({autoSelect:e}),y(`已载入 ${M.length} 条已提交记录`,"ok")}catch(t){console.error("[History] 获取历史记录失败:",t),y(`云端记录加载失败：${t.message}`,"warn"),$({autoSelect:!1})}}async function ht(e=7){try{const s=`${V().replace(/\/$/,"")}/api/stats/daily?days=${encodeURIComponent(e)}`,o=await X(s),a=Array.isArray(o?.stats)?o.stats:[];j=kt(a,e),x&&x.classList.toggle("hidden",j.some(r=>r.practiced||r.below_zero||r.above_two)),gt(j)}catch(t){console.error("[History] 获取每日统计失败:",t),x&&(x.classList.remove("hidden"),x.textContent=`无法加载趋势数据：${t.message}`)}}function Tt(e=""){return typeof e!="string"||!e.trim()?"<p>（无文章内容记录）</p>":e.split(/\n\n+/).map(o=>`<p>${o.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function Ct(e){const t=Array.isArray(e)?[...e]:[],s=H?1:-1;return t.sort((o,a)=>{switch(W){case"similarity":{const r=Number(o?.similarity),c=Number(a?.similarity),i=Number.isFinite(r),n=Number.isFinite(c);return!i&&!n?0:i?n?r===c?(o.term||"").localeCompare(a.term||"")*s:(r-c)*s:-1*s:1*s}case"standard":{const r=(o?.standard_answer||o?.standardAnswer||"").toString(),c=(a?.standard_answer||a?.standardAnswer||"").toString(),i=r.localeCompare(c,"zh",{sensitivity:"base"});return i===0?(o.term||"").localeCompare(a.term||"")*s:i*s}case"explanation":{const r=(o?.explanation||"").toString(),c=(a?.explanation||"").toString(),i=r.localeCompare(c,"zh",{sensitivity:"base"});return i===0?(o.term||"").localeCompare(a.term||"")*s:i*s}case"term":default:return(o?.term||"").localeCompare(a?.term||"","en",{sensitivity:"base"})*s}}),t}function lt(){if(!K)return;K.querySelectorAll("th[data-sort]").forEach(t=>{const s=t.dataset.sort;s&&(t.classList.add("sortable"),s===W?(t.classList.add("active"),t.dataset.indicator=H?"↑":"↓"):(t.classList.remove("active"),t.dataset.indicator=""))})}function rt(){if(!Z)return;const e=Ct(et);if(!e.length){Z.innerHTML='<tr><td colspan="4" class="empty">未记录判题结果。</td></tr>',I=[],p&&(p.disabled=!0,p.textContent="复制 ≤0.5 词"),lt();return}const t=e.map(s=>{const o=k(s.term),a=typeof s.similarity=="number"?s.similarity:Number(s.similarity),r=Number.isFinite(a)?a.toFixed(2):"—",c=Lt(Number.isFinite(a)?a:NaN),i=s.standard_answer||s.standardAnswer||"",n=s.explanation||"",f=U?k(i):"—",m=U?k(n):"—";return`
      <tr class="history-result-${c}">
        <td>${o||"—"}</td>
        <td>${r}</td>
        <td>${f||"—"}</td>
        <td>${m||"—"}</td>
      </tr>
    `}).join("");Z.innerHTML=t,I=e.filter(s=>{if(!s||typeof s.term!="string")return!1;const o=typeof s.similarity=="number"?s.similarity:Number(s.similarity);return Number.isFinite(o)&&o<=.5}).map(s=>s.term.trim()).filter(Boolean),p&&(I.length?(p.disabled=!1,p.textContent=`复制 ≤0.5 词 (${I.length})`):(p.disabled=!0,p.textContent="暂无低分词")),lt()}function Rt(e){if(!e)return null;const t=window.devicePixelRatio||1,s=e.getBoundingClientRect();e.width=s.width*t,e.height=s.height*t;const o=e.getContext("2d");return o&&o.scale(t,t),o}function gt(e){if(!R)return;const t=Rt(R);if(!t)return;if(!e||!e.length){t.clearRect(0,0,R.width,R.height),x&&x.classList.remove("hidden");return}const s=R.getBoundingClientRect().width,o=R.getBoundingClientRect().height;t.clearRect(0,0,s,o);const a=e.map(u=>u.day),r=e.map(u=>Number(u.below_zero)||0),c=e.map(u=>Number(u.above_two)||0),i=Math.max(5,...r,...c),n={top:16,right:24,bottom:32,left:40},f=s-n.left-n.right,m=o-n.top-n.bottom;t.strokeStyle="rgba(147, 161, 161, 0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(n.left,n.top),t.lineTo(n.left,n.top+m),t.lineTo(n.left+f,n.top+m),t.stroke();const E=Math.min(4,i);t.fillStyle="var(--muted)",t.font="12px sans-serif";for(let u=0;u<=E;u++){const b=Math.round(i/E*u),g=n.top+m-m*(b/i);t.fillText(String(b),6,g+4),t.strokeStyle="rgba(147, 161, 161, 0.15)",t.beginPath(),t.moveTo(n.left,g),t.lineTo(n.left+f,g),t.stroke()}a.forEach((u,b)=>{const g=n.left+f/Math.max(1,a.length-1)*b,S=n.top+m+16;t.fillStyle="var(--muted)",t.fillText(u.slice(5),g-18,S)});function A(u,b){t.strokeStyle=b,t.lineWidth=2,t.beginPath(),u.forEach((g,S)=>{const T=n.left+f/Math.max(1,u.length-1)*S,N=n.top+m-m*(g/i);S===0?t.moveTo(T,N):t.lineTo(T,N)}),t.stroke(),u.forEach((g,S)=>{const T=n.left+f/Math.max(1,u.length-1)*S,N=n.top+m-m*(g/i);t.fillStyle=b,t.beginPath(),t.arc(T,N,3,0,Math.PI*2),t.fill()})}A(r,"#dc322f"),A(c,"#859900")}function kt(e,t=7){const s=new Date,o=[];for(let a=t-1;a>=0;a--){const r=new Date(s);r.setDate(s.getDate()-a);const c=r.toISOString().slice(0,10),i=e.find(n=>n.day===c);i?o.push(i):o.push({day:c,practiced:0,below_zero:0,above_two:0})}return o}function D(e,t={}){if(!G||!q)return;const{source:s="remote",status:o="submitted",recordId:a=null}=t,r=w?F.get(w):null,c=!!Number(e?.session?.scored),i=r&&r.scored===!0||c;if(!e||!e.session){I=[],p&&(p.disabled=!0,p.textContent="复制 ≤0.5 词"),d=null,l&&(l.classList.add("hidden"),l.disabled=!0,delete l.dataset.recordId),v&&(v.classList.add("hidden"),v.removeAttribute("href")),G.classList.add("hidden"),q.classList.remove("hidden");return}q.classList.add("hidden"),G.classList.remove("hidden");const{session:n,results:f}=e,m=n.submitted_at||n.created_at||n.createdAt||"",E=m?mt(m):"—",A=h(n.total_terms,Array.isArray(f)?f.length:0),u=Q(n.avg_similarity),b=Number.isFinite(u)?u.toFixed(2):"—",g=h(n.correct_terms),S=h(n.partial_terms),T=Math.max(0,A-g-S),N=h(n.incorrect_terms,T),bt=ft(i),St=yt(i),It="记录时间",wt=s==="remote"?"判题记录":"本地判题",nt=n.id||(a?`本地-${a.slice(-6)}`:""),Et=nt?` #${nt}`:"";if(ot&&(ot.textContent=`${wt}${Et}`),at){const C=[`状态：<span class="history-session-status ${St}">${bt}</span>`,`${It}：${k(E)}`,`总词数：${A}`,`平均相似度：${b}`,`正确/部分/错误：${g}/${S}/${N}`];at.innerHTML=C.join(" ｜ ")}if(v){const C=h(n.session_id??n.id,null);(s==="remote"||o==="submitted")&&C?(v.href=`geo_vocab_fill_in_webpage_english→chinese.html?session=${C}`,v.classList.remove("hidden")):(v.classList.add("hidden"),v.removeAttribute("href"))}if(ct){const C=Tt(n.article||"");ct.innerHTML=C}W="term",H=!0,et=Array.isArray(f)?[...f]:[],rt();const At=h(n.session_id??n.id,null);d={entryId:w,source:s,recordId:a,sessionId:At,article:n.article||"",results:Array.isArray(f)?[...f]:[],sessionData:{...n}},l&&(i||!d.results.length||s==="remote"&&!d.sessionId?(l.classList.add("hidden"),l.disabled=!0,delete l.dataset.recordId):(l.classList.remove("hidden"),l.disabled=!1,a?l.dataset.recordId=a:delete l.dataset.recordId)),r&&(r.session=n,r.scored=i,r.summary=r.summary||{},r.summary.total=A,r.summary.correct=g,r.summary.partial=S,r.summary.incorrect=N,r.summary.avg=u),s==="remote"&&(i?y("该判题记录已计分，可继续复盘。","ok"):y("该判题记录尚未计分，点击“计分”按钮即可累计到总分。","warn"))}function Ht(e){if(!e||!e.record){D(null);return}const t=e.record,s=t.summary||{},o=h(s.total,Array.isArray(t.results)?t.results.length:0),a=Number.isInteger(t.sessionId)?t.sessionId:null,r=Q(s.avg),c={id:a??`本地-${t.id.slice(-6)}`,session_id:a,submitted_at:t.submittedAt||t.createdAt,total_terms:o,correct_terms:h(s.correct),partial_terms:h(s.partial),incorrect_terms:h(s.incorrect,Math.max(0,o-h(s.correct)-h(s.partial))),avg_similarity:r,article:t.article||""},i=Array.isArray(t.results)?t.results.map(n=>({term:n.term,similarity:Number.isFinite(n.similarity)?n.similarity:Number.isFinite(Number(n.similarity))?Number(n.similarity):null,standard_answer:n.standard_answer??n.standardAnswer??null,explanation:n.explanation??null,context:n.context??null})):[];D({session:c,results:i},{source:"local",status:e.status,recordId:t.id}),l&&(e.scored?(l.classList.add("hidden"),l.disabled=!0,l.dataset.recordId=t.id):(l.classList.remove("hidden"),l.disabled=!1,l.dataset.recordId=t.id)),e.scored?y("该判题记录已计入总分，可继续复盘。","ok"):y("该判题记录尚未计分，点击上方“计分”按钮可累计到总分。","warn")}async function pt(e){if(!e||!F.has(e))return;w=e,st(e);const t=F.get(e);if(!t)return;if(t.source==="local"){Ht(t);return}const s=t.sessionId;if(!s){D(null);return}const o=`remote-${s}`;if(J.has(o)){D(J.get(o),{source:"remote",status:"submitted"});return}try{y(`正在加载记录 #${s}…`,"info");const r=`${V().replace(/\/$/,"")}/api/sessions/${s}`,c=await X(r);J.set(o,c),D(c,{source:"remote",status:"submitted"}),y(`已加载记录 #${s}`,"ok")}catch(a){console.error("[History] 加载详情失败:",a),y(`加载记录 #${s} 失败：${a.message}`,"warn")}}_&&_.addEventListener("change",()=>{const e=_.value.trim();e&&localStorage.setItem("score-api-url",e),ht(7),O({autoSelect:!1})});it&&it.addEventListener("click",()=>{J.clear(),$({autoSelect:!1}),O({autoSelect:!1})});Y&&(localStorage.getItem("history-show-meaning")==="false"&&(U=!1,Y.checked=!1),Y.addEventListener("change",()=>{U=!!Y.checked,localStorage.setItem("history-show-meaning",U?"true":"false"),rt()}));L&&L.addEventListener("click",e=>{const t=e.target.closest(".history-session-item");if(!t)return;const s=t.dataset.id;s&&pt(s)});K&&K.addEventListener("click",e=>{const t=e.target.closest("th[data-sort]");if(!t)return;const s=t.dataset.sort;s&&et.length&&(W===s?H=!H:(W=s,H=!0),rt())});window.addEventListener("resize",()=>{j.length&&gt(j)});function Bt(e){return Array.isArray(e)?e.map(t=>{if(!t||typeof t!="object")return null;const s=typeof t.term=="string"?t.term.trim():"";if(!s)return null;const o=Number(t.similarity);return Number.isFinite(o)?{term:s,similarity:o,standard_answer:typeof t.standard_answer=="string"?t.standard_answer:null,explanation:typeof t.explanation=="string"?t.explanation:null,context:typeof t.context=="string"?t.context:null}:null}).filter(Boolean):[]}async function Dt(){if(!l)return;if(!d||!Array.isArray(d.results)||!d.results.length){y("当前记录缺少判题结果，无法计分。","warn");return}const e=Bt(d.results);if(!e.length){y("该判题记录没有可计分的相似度数据。","warn");return}const s=`${V().replace(/\/$/,"")}/api/word-scores`,o=l.dataset.originalText||l.textContent||"计分";l.disabled=!0,l.textContent="计分中…",y("正在将判题结果计入总分…","info");const a={results:e,article:d.article||""};Number.isInteger(d.sessionId)&&d.sessionId>0&&(a.session_id=d.sessionId);try{const c=(await X(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}))?.session_id,i=Number(c),n=d.entryId?F.get(d.entryId):null;if(d.recordId&&(vt(d.recordId,{sessionId:i,submittedAt:new Date().toISOString()}),_t(d.recordId,{sessionId:i})),n&&(n.scored=!0,Number.isInteger(i)&&i>0&&(n.sessionId=i)),d&&(d.sessionId=Number.isInteger(i)&&i>0?i:d.sessionId,d.sessionData&&(d.sessionData.scored=1,Number.isInteger(i)&&i>0&&(d.sessionData.id=i,d.sessionData.session_id=i))),Number.isInteger(i)&&i>0&&Array.isArray(M)){const m=M.find(E=>Number(E?.id)===Number(i));m&&(m.scored=1)}const f=Number.isInteger(i)&&i>0?`计分成功！历史记录 #${i}`:"计分成功，已累计到总分";if(y(f,"ok"),l&&l.classList.add("hidden"),d?.sessionData){const m={session:{...d.sessionData},results:Array.isArray(d.results)?[...d.results]:[]};D(m,{source:d.source,recordId:d.recordId,status:"submitted"}),y(f,"ok")}$({autoSelect:!1}),O({autoSelect:!1})}catch(r){console.error("[History] 判题计分失败:",r),y(`计分失败：${r.message}`,"warn")}finally{l.disabled=!1,l.textContent=o}}function dt(e){const t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="fixed",t.style.top="-9999px",document.body.appendChild(t),t.select();let s=!1;try{s=document.execCommand("copy")}catch{s=!1}return document.body.removeChild(t),s}async function Mt(){if(!Array.isArray(I)||!I.length){y("当前记录没有相似度 ≤0.5 的词汇","warn");return}const e=I.join(", ");try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(e);else if(!dt(e))throw new Error("无法访问剪贴板");y(`已复制 ${I.length} 个词汇到剪贴板`,"ok")}catch(t){dt(e)?y(`已复制 ${I.length} 个词汇到剪贴板`,"ok"):y(`复制失败：${t.message}`,"warn")}}p&&p.addEventListener("click",Mt);l&&l.addEventListener("click",async()=>{await Dt()});window.addEventListener("grading-history-updated",()=>{$({autoSelect:!1}),B&&clearTimeout(B),B=setTimeout(()=>{O({autoSelect:!1})},250)});window.addEventListener("storage",e=>{e.key==="grading-history-records"&&($({autoSelect:!1}),B&&clearTimeout(B),B=setTimeout(()=>{O({autoSelect:!1})},250))});V();$({autoSelect:!0});ht(7);O({autoSelect:!1});
