import{e as v,f as lt}from"./chunks/http.js";function Nt({listElement:t,filterInput:e,scoreCache:n,makeId:a}){function s(o){if(Array.isArray(o))for(const d of o){const i=document.getElementById(a(d));if(!i)continue;const c=i.closest(".item");if(!c)continue;const u=i.value&&i.value.trim().length>0;c.classList.toggle("filled",u)}}function r(){if(!t)return;t.querySelectorAll(".score-badge").forEach(d=>{const i=d.dataset.termScore,c=i&&n?.has(i)?n.get(i):null;typeof c=="number"?(d.textContent=c.toFixed(2),d.classList.add("score-known")):(d.textContent="â€”",d.classList.remove("score-known"))})}function l(o){if(!t||!Array.isArray(o))return;const d=e?.value?.trim().toLowerCase(),i=[];for(const c of o){if(d&&!c.toLowerCase().includes(d))continue;const u=a(c),g=n?.has(c)?n.get(c):null,f=typeof g=="number"?g.toFixed(2):"â€”";i.push(`
        <div class="item">
          <div class="term" data-term="${v(c)}">
            <span>${v(c)}</span>
            <span class="score-badge" data-term-score="${v(c)}">${f}</span>
            <span class="jump" data-term="${v(c)}">è·³åˆ°æ–‡ä¸­</span>
          </div>
          <input aria-label="${v(c)} ä¸­æ–‡æ„æ€" placeholder="ä¸­æ–‡æ„æ€â€¦" id="${v(u)}" data-term="${v(c)}" />
        </div>
      `)}t.innerHTML=i.join(""),s(o),r()}return{buildList:l,updateFilledState:s,updateScoreBadges:r}}function Rt(t={}){const e={...t},n=new Map;function a(o){return e[o]}function s(o,d){const i=e[o];if(e[o]=d,i===d)return d;const c=n.get(o);if(c)for(const u of c)try{u(d,{...e})}catch(g){console.error("[Store] listener error",g)}return d}function r(o,d){if(typeof d!="function")return()=>{};const i=n.get(o);return i?i.add(d):n.set(o,new Set([d])),()=>{const c=n.get(o);c&&(c.delete(d),c.size===0&&n.delete(o))}}function l(){return{...e}}return{get:a,set:s,subscribe:r,snapshot:l}}const J=Rt({vocabs:[],serverScores:[],gradingResults:{},articleMarkdown:""}),It=t=>J.set("vocabs",Array.isArray(t)?[...t]:[]),Pt=t=>J.set("serverScores",Array.isArray(t)?[...t]:[]),Gt=t=>J.set("gradingResults",t||{}),jt=t=>J.set("articleMarkdown",typeof t=="string"?t:"");let y=[];const _=new Map,dt=new Map,M=new Map;let B="";const z=document.getElementById("list"),At=document.getElementById("filter"),ut=document.getElementById("edit-mode-btn"),gt=document.getElementById("view-mode-btn"),xt=document.getElementById("edit-section"),bt=document.getElementById("view-section"),P=document.getElementById("article-editor"),Ot=document.getElementById("save-article-btn"),R=document.getElementById("editor-status"),rt=document.getElementById("article-content"),st=document.getElementById("generator-words"),x=document.getElementById("generate-article-btn"),Q=document.getElementById("generator-status"),m=document.getElementById("start-grade"),h=document.getElementById("sync-server"),N=document.getElementById("sync-status"),tt=document.getElementById("server-scores"),F=document.getElementById("score-api-url"),St=document.getElementById("api-url"),Et=document.getElementById("api-key"),vt=document.getElementById("ai-model"),Ft=document.getElementById("practiced-count"),_t=document.getElementById("total-count"),Vt=document.getElementById("mastery-threshold"),C=document.getElementById("auto-fill-words"),at=new Map,L=Nt({listElement:z,filterInput:At,scoreCache:at,makeId:H});J.subscribe("vocabs",t=>{y=Array.isArray(t)?[...t]:[],L.buildList(y)});h&&!h.dataset.originalText&&(h.dataset.originalText=h.textContent);Y([]);w("","info");Lt({quiet:!0});const Jt=220,U=.85,et=.6;let V={};function H(t){return"term-"+t.toLowerCase().replace(/[^a-z0-9]+/g,"-")}function $t(t,e){const n=typeof t=="string"?t.trim():"";if(!n)return;const a=typeof e=="string"&&e.trim()?e.trim():n;_.set(a.toLowerCase(),n),_.set(n.toLowerCase(),n),dt.set(n,a)}function Ht(t=[]){if(_.clear(),dt.clear(),!!Array.isArray(t))for(const e of t)!e||typeof e!="object"||$t(e.original,e.used)}function ft(t){if(!t)return null;const e=t.trim().toLowerCase();return _.has(e)?_.get(e):y.find(a=>a.toLowerCase()===e)||null}function Ut(t){if(!t)return null;const e=t.trim();return dt.get(e)||e}function it(t){const e=Ut(t)||t,n="t-"+e.toLowerCase().replace(/[^a-z0-9]+/g,"-"),a=document.getElementById(n);if(a){a.scrollIntoView({behavior:"smooth",block:"center"}),yt(a);return}const s=document.querySelectorAll("#article-content strong"),r=e.toLowerCase();for(const l of s){const o=l.textContent.trim().toLowerCase();if(o===r||o.includes(r)){l.scrollIntoView({behavior:"smooth",block:"center"}),yt(l);return}}alert("åœ¨æ–‡ç« ä¸­æœªæ‰¾åˆ°è¯¥è¯ï¼š"+t)}function yt(t){t.style.outline="2px solid var(--accent-2)",t.style.boxShadow="0 0 0 4px rgba(137,220,235,.25)",setTimeout(()=>{t.style.outline="",t.style.boxShadow=""},1500)}function qt(t){if(!t)return[];const e=t.split(/[\n,ï¼Œã€ï¼›;]+/),n=new Set,a=[];for(const s of e){const r=s.trim();r&&!n.has(r)&&(n.add(r),a.push(r))}return a}function Dt(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function K(t){if(!t)return"";const{content:e,text:n,tool_calls:a}=t,s=o=>o?typeof o=="string"?o:typeof o=="number"||typeof o=="boolean"?String(o):typeof o=="object"?typeof o.text=="string"?o.text:Array.isArray(o.text)?o.text.map(s).join(""):o.type==="text"&&typeof o.value=="string"?o.value:o.type==="text"&&typeof o.data=="string"?o.data:(o.type==="tool_call"&&o.function?.arguments,""):"":"";let r=[];if(typeof e=="string"?r.push(e):Array.isArray(e)?r.push(e.map(s).join("")):e&&typeof e=="object"&&(typeof e.text=="string"?r.push(e.text):Array.isArray(e.text)&&r.push(e.text.map(s).join(""))),typeof n=="string"?r.push(n):Array.isArray(n)&&r.push(n.map(s).join("")),(!r.length||r.join("").trim()==="")&&Array.isArray(a))for(const o of a)o?.function?.result&&typeof o.function.result=="string"&&r.push(o.function.result);return r.join(`
`).trim()}function zt(t){const e=Dt(t.trim());return e?/\s/.test(t)?new RegExp(e.replace(/\s+/g,"\\s+"),"i"):new RegExp(`\\b${e}\\b`,"i"):null}function W(t,e,{trim:n=!0}={}){if(!t)return;const a=()=>{const s=n?t.value.trim():t.value;s?localStorage.setItem(e,s):localStorage.removeItem(e)};t.addEventListener("change",a),t.addEventListener("blur",a)}function Kt(t,e,n=[]){const a=t.replace(/\*\*/g,""),s=new Set,r=/\*\*(.*?)\*\*/g;let l;for(;(l=r.exec(t))!==null;){const i=l[1]?.trim().toLowerCase();i&&s.add(i)}const o=new Map;if(Array.isArray(n))for(const i of n){if(!i||typeof i!="object")continue;const c=typeof i.original=="string"?i.original.trim().toLowerCase():"",u=typeof i.used=="string"?i.used.trim().toLowerCase():"";c&&u&&o.set(c,u),c&&!u&&o.set(c,c)}const d=[];for(const i of e){const c=typeof i=="string"?i.trim().toLowerCase():"";if(!c||s.has(c))continue;const u=o.get(c);if(u&&s.has(u))continue;const g=zt(i);g&&(g.test(a)||d.push(i))}return d}function p(t,e="info"){if(!Q)return;const n={info:"var(--muted)",ok:"var(--ok)",warn:"var(--warn)"};Q.textContent=t||"",Q.style.color=n[e]||n.info}W(St,"ai-api-url");W(Et,"ai-api-key");W(vt,"ai-model");W(F,"score-api-url");function j(t,e){m&&(typeof t=="string"&&(m.textContent=t),m.disabled=e)}function Wt(){m&&(m.disabled=!1,m.textContent=m.dataset.originalText||"ğŸ“ å¼€å§‹åˆ¤é¢˜")}function w(t,e="info"){N&&(N.classList.remove("ok","warn"),e==="ok"&&N.classList.add("ok"),e==="warn"&&N.classList.add("warn"),e!=="ok"&&e!=="warn"&&N.classList.remove("ok","warn"),N.textContent=t||"")}function Y(t){if(!tt)return;if(at.clear(),Pt(Array.isArray(t)?t:[]),!t||!t.length){tt.innerHTML='<div class="empty">æœåŠ¡å™¨æš‚æ— è¯æ±‡è®°å½•ã€‚</div>',L.updateScoreBadges();return}const e=t.map(({term:n,score:a,submissions:s,last_submission:r})=>{const l=v(n),o=Number(a),d=Number.isFinite(o)?o.toFixed(2):"0.00",i=Number.isFinite(Number(s))?Number(s):0;typeof n=="string"&&at.set(n.trim(),Number.isFinite(o)?o:null);let c="-";if(r){const u=new Date(r);c=Number.isNaN(u.getTime())?v(r):u.toLocaleString()}return`<tr><td>${l}</td><td>${d}</td><td>${i}</td><td>${v(c)}</td></tr>`}).join("");tt.innerHTML=`
    <h5>æœåŠ¡å™¨è¯è¡¨å¾—åˆ†</h5>
    <table>
      <thead><tr><th>è¯æ±‡</th><th>ç´¯è®¡åˆ†æ•°</th><th>æäº¤æ¬¡æ•°</th><th>æœ€åæäº¤æ—¶é—´</th></tr></thead>
      <tbody>${e}</tbody>
    </table>
  `,L.updateScoreBadges()}function X(){const t=F?.value?.trim();if(t)return t;const e=localStorage.getItem("score-api-url");return e||"http://localhost:4000"}function Yt(){const t=[];if(!V)return t;for(const[e,n]of Object.entries(V))if(n&&typeof n.similarity=="number"){const a=M.get(e)||"";t.push({term:e,similarity:n.similarity,context:a||null,standard_answer:n.standardAnswer?String(n.standardAnswer):null,explanation:n.explanation?String(n.explanation):null})}return t}function Xt(){return typeof B=="string"&&B.trim()?B.trim():typeof P?.value=="string"?P.value.trim():""}function Zt(){const t=Number(Ft?.value??0),e=Number(_t?.value??0),n=Number(Vt?.value??1),a=Number.isFinite(t)?Math.max(0,Math.min(50,Math.round(t))):0,s=Number.isFinite(e)?Math.max(0,Math.min(50,Math.round(e))):0,r=Number.isFinite(n)?n:1;return{practiced:a,total:s,masteryThreshold:r}}async function Lt({quiet:t=!1}={}){try{const n=X().replace(/\/$/,"")+"/api/word-scores",a=await lt(n);Array.isArray(a?.scores)?(Y(a.scores),t||w(`å·²è·å–æœåŠ¡å™¨è®°å½•ï¼ˆ${a.scores.length} ä¸ªè¯ï¼‰`,"ok")):t||w("æœåŠ¡å™¨æœªè¿”å›æœ‰æ•ˆæ•°æ®","warn")}catch(e){t||w(`æ— æ³•è·å–æœåŠ¡å™¨åˆ†æ•°ï¼š${e.message}`,"warn")}}async function Qt(){if(!C)return;const{practiced:t,total:e,masteryThreshold:n}=Zt();if(!e){p("è¯·è®¾ç½®æ€»è¯æ•°ï¼ˆè‡³å°‘ 1ï¼‰","warn");return}if(t>e){p("ç»ƒä¹ è¿‡çš„è¯æ•°ä¸èƒ½è¶…è¿‡æ€»è¯æ•°","warn");return}const a=X(),s=`${a.replace(/\/$/,"")}/api/word-suggestions?practiced=${t}&total=${e}&threshold=${encodeURIComponent(n)}`;C.disabled=!0,C.textContent="è·å–ä¸­â€¦",p("æ­£åœ¨å‘æœåŠ¡å™¨è¯·æ±‚æ¨èè¯æ±‡â€¦","info");try{const r=await lt(s),l=Array.isArray(r?.practiced)?r.practiced.map(i=>i.term).filter(Boolean):[],o=Array.isArray(r?.fresh)?r.fresh.map(i=>i.term).filter(Boolean):[];if(!l.length&&!o.length){p("æœªè·å–åˆ°ç¬¦åˆæ¡ä»¶çš„è¯æ±‡ï¼Œè¯·è°ƒæ•´å‚æ•°ã€‚","warn");return}const d=[];l.length&&d.push(l.join(", ")),o.length&&d.push(o.join(", ")),st.value=d.join(`

`),p(`å·²å¡«å…¥ ${l.length} ä¸ªç»ƒä¹ è¯ä¸ ${o.length} ä¸ªæ–°è¯`,"ok"),localStorage.setItem("score-api-url",a)}catch(r){console.error("[Auto Fill Words] è·å–å¤±è´¥:",r),p(`è·å–æ¨èè¯æ±‡å¤±è´¥ï¼š${r.message}`,"warn")}finally{C.disabled=!1,C.textContent="ğŸ¯ è‡ªåŠ¨å–è¯"}}function mt(){const t=St?.value?.trim(),e=Et?.value?.trim(),n=vt?.value?.trim(),a=localStorage.getItem("ai-api-url"),s=localStorage.getItem("ai-api-key"),r=localStorage.getItem("ai-model"),l=(t||a||"").trim(),o=(e||s||"").trim(),d=(n||r||"gpt-3.5-turbo").trim()||"gpt-3.5-turbo";return t!==void 0&&(t?localStorage.setItem("ai-api-url",t):localStorage.removeItem("ai-api-url")),e!==void 0&&(e?localStorage.setItem("ai-api-key",e):localStorage.removeItem("ai-api-key")),n!==void 0&&(n?localStorage.setItem("ai-model",n):localStorage.removeItem("ai-model")),{apiUrl:l,apiKey:o,model:d}}function te(t){const e=[...t];for(let n=e.length-1;n>0;n--){const a=Math.floor(Math.random()*(n+1));[e[n],e[a]]=[e[a],e[n]]}return e}function ee(t){return`è¯·ä¸ºè‹±è¯­å­¦ä¹ è€…å†™ä¸€ç¯‡è‹±æ–‡çŸ­æ–‡ï¼Œä½¿ç”¨ Markdown æ®µè½æ ¼å¼ï¼ˆå¯è‡ªè¡Œåˆ†æ®µï¼Œä½†ä¸è¦æ·»åŠ æ ‡é¢˜ã€å‰è¨€æˆ–ä»£ç å—ï¼‰ã€‚ä¸¥æ ¼éµå®ˆä¸‹åˆ—è§„åˆ™ï¼š

**A. æ ‡æ³¨ä¸é¢‘æ¬¡**

* ä»…å¯¹ç›®æ ‡è¯åŠ ç²—ï¼Œå½¢å¼ä¸º **word**ï¼›é™¤ç›®æ ‡è¯å¤–ä¸å¾—ä½¿ç”¨ç²—ä½“ã€‚
* æ¯ä¸ªç›®æ ‡è¯è‡³å°‘å‡ºç°ä¸€æ¬¡ï¼›å¯æŒ‰è¯­å¢ƒå˜åŒ–è¯å½¢ï¼Œå¹¶å¯¹å˜åŒ–åçš„è¯å½¢åŠ ç²—ã€‚
* **æ¯å¥æœ€å¤šå‡ºç°ä¸€ä¸ªç›®æ ‡è¯**ï¼›ç¦æ­¢åœ¨åŒä¸€å¥ç”¨å¹¶åˆ—ï¼ˆå¦‚ â€œX and Yâ€ æˆ– â€œX, Y, and Zâ€ï¼‰æ”¾å…¥å¤šä¸ªç›®æ ‡è¯ã€‚

**B. è¯­ä¹‰åˆ†æ•£ä¸é˜²â€œæ‰å †â€**

* **åŒä¹‰ã€è¿‘ä¹‰ã€åä¹‰ã€åŒè¯æ ¹æˆ–åŒä¸€è¯­ä¹‰åœºçš„ç›®æ ‡è¯ï¼Œå½¼æ­¤ä¹‹é—´è‡³å°‘é—´éš” â‰¥2 å¥**ï¼›ä¸å¾—å‡ºç°åœ¨ç›¸é‚»å¥æˆ–åŒä¸€å¥ã€‚
* è‹¥ä¸¤è¯å¸¸ä½œå¹¶åˆ—å½¢å®¹æˆ–å¯äº’æ¢ä½¿ç”¨ï¼Œåªåœ¨ä¸åŒå¥ä¸­å‡ºç°ï¼Œä¸”ç½®äºä¸åŒè¯é¢˜æˆ–åŠŸèƒ½ï¼ˆå¦‚ä¸€ä¸ªä½œæè¿°ï¼Œå¦ä¸€ä¸ªç”¨äºè¡ŒåŠ¨æˆ–ç»“æœï¼‰ã€‚

**C. è¿è´¯æ€§ä¸ç»“æ„ï¼ˆé‡ç‚¹ï¼‰**

* å…ˆåœ¨å†…éƒ¨æ‹Ÿå®šâ€œä¸‰æ®µå¼å™äº‹â€ä½†**ä¸è¾“å‡ºå¤§çº²**ï¼š
  1ï¼‰å¼€ç«¯ï¼šäº¤ä»£æ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ä¸ç›®æ ‡ï¼›
  2ï¼‰å‘å±•ï¼šè¡ŒåŠ¨ã€é˜»ç¢ä¸æŠ‰æ‹©ï¼›
  3ï¼‰ç»“å°¾ï¼šç»“æœæˆ–åæ€ï¼Œå‘¼åº”ç›®æ ‡ã€‚
* å…¨æ–‡ä¿æŒ**åŒä¸€ç»„äººç‰©/åœ°ç‚¹/ç›®æ ‡**è´¯ç©¿ï¼›ä¸è¦æ— æç¤ºåœ°æ›´æ¢åœºæ™¯æˆ–äººç‰©ã€‚
* **å¥é™…é€»è¾‘**æ¸…æ™°ï¼šæ¯å¥ä¸ä¸Šä¸€å¥æ„æˆæ—¶é—´é¡ºåºã€å› æœã€é€’è¿›æˆ–è½¬æŠ˜å…³ç³»ã€‚å¿…è¦æ—¶åœ¨å¥é¦–ä½¿ç”¨ then, later, because, however, therefore, eventually ç­‰è¿æ¥è¯ï¼ˆé€‚é‡ä½¿ç”¨ï¼‰ã€‚
* ç¦æ­¢æ¸…å•å¼ã€å£å·å¼æˆ–ä¸ä¸»çº¿æ— å…³çš„è·³è½¬ï¼›é¿å…æ¨¡æ¿åŒ–é‡å¤å¥å¼ã€‚

**D. è¯­å¢ƒæš—ç¤ºï¼Œç¦æ­¢å®šä¹‰å¼å†™æ³•**

* ç¦æ­¢ â€œ**X** is/means/refers to/also called/defined as â€¦â€ ç­‰å®šä¹‰å¥ï¼›ç¦æ­¢åœ¨ç›®æ ‡è¯æ‰€åœ¨å¥ç”¨æ‹¬å·ã€ç ´æŠ˜å·ã€åŒä½è¯­æˆ– â€œi.e./such as/for exampleâ€ ç»™å‡ºç›´ç™½è§£é‡Šæˆ–åŒä¹‰æ›¿æ¢ã€‚
* ä¸ç»™å‡ºä¸­æ–‡é‡Šä¹‰æˆ–ç›´è¯‘æç¤ºè¯ï¼›é€šè¿‡åŠ¨ä½œã€ç»“æœã€æ„Ÿå—ã€å¯¹è¯æˆ–æƒ…å¢ƒ**é—´æ¥**è¡¨è¾¾å«ä¹‰ã€‚

**E. ç¯‡å¹…ä¸æ®µè½**

* å¥å­æ•°åº” â‰¥ ç›®æ ‡è¯æ•°é‡ï¼Œä¼˜å…ˆé‡‡ç”¨â€œä¸€è¯ä¸€å¥â€ã€‚

**F. è¾“å‡º**

* **ä»…è¾“å‡ºæ–‡ç« æ­£æ–‡**ï¼Œä¿ç•™ Markdown æ®µè½ä¸ç²—ä½“æ ‡è®°ï¼›ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–è¯´æ˜ã€æ ‡é¢˜ã€åˆ—è¡¨æˆ– JSONã€‚

ç›®æ ‡è¯æ±‡ï¼ˆé¡ºåºéšæœºï¼‰ï¼š

${t.map((n,a)=>`${a+1}. ${n}`).join(`
`)}`}function ne(t,e){const n=e.map((a,s)=>`${s+1}. ${a}`).join(`
`);return`è¯·é˜…è¯»ä¸‹æ–¹çš„è‹±æ–‡æ–‡ç« ï¼Œå¹¶æ ¹æ®æä¾›çš„ç›®æ ‡è¯æ±‡åˆ—è¡¨ï¼ŒæŒ‡å‡ºæ–‡ç« ä¸­æ¯ä¸ªè¯æ±‡çš„å®é™…å†™æ³•ã€‚

è¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "pairs": [
    {"original": "ç›®æ ‡è¯æ±‡", "used": "æ–‡ç« ä¸­çš„å®é™…å†™æ³•ï¼ˆå»æ‰**ï¼Œè‹¥æœªå‡ºç°åˆ™ç•™ç©ºå­—ç¬¦ä¸²ï¼‰"}
  ]
}

è¦æ±‚ï¼š
- original å¿…é¡»ä¸æä¾›çš„ç›®æ ‡è¯æ±‡å®Œå…¨ä¸€è‡´ï¼›
- used ä¸ºæ–‡ç« ä¸­å‡ºç°çš„å…·ä½“å½¢å¼ï¼ˆä¿ç•™å¤§å°å†™/å•å¤æ•°ç­‰å˜åŒ–ï¼Œä½†å»æ‰ä»»ä½• Markdown ** æ ‡è®°ï¼‰ï¼›
- å¦‚æœæŸä¸ªè¯æœªåœ¨æ–‡ç« ä¸­å‡ºç°ï¼Œå°† used è®¾ä¸ºç©ºå­—ç¬¦ä¸²ã€‚

è‹±æ–‡æ–‡ç« ï¼š
"""
${t}
"""

ç›®æ ‡è¯æ±‡åˆ—è¡¨ï¼š
${n}`}function nt(t){return typeof t!="string"?"":t.replace(/\*\*/g,"").trim()}function oe(t,e){const n=(e||[]).map(i=>({original:i,used:i}));if(!t)return n;let a=t.trim();if(!a)return n;let s=null;const r=a.match(/```(?:json)?([\s\S]*?)```/i);if(r)s=r[1].trim();else{const i=a.match(/\{[\s\S]*\}/);i&&(s=i[0])}let l=[];if(s)try{const i=JSON.parse(s);l=(Array.isArray(i?.pairs)?i.pairs:Array.isArray(i)?i:[]).map(u=>{if(!u||typeof u!="object")return null;const g=typeof u.original=="string"?u.original.trim():"",f=nt(u.used??"");return g?{original:g,used:f||""}:null}).filter(Boolean)}catch(i){console.warn("[Variant Mapping] JSONè§£æå¤±è´¥ï¼Œå°è¯•è§£æçº¯æ–‡æœ¬æ ¼å¼",i),l=[]}if(!l.length){const i=a.split(/\n+/).map(c=>c.trim()).filter(Boolean);for(const c of i){const u=c.match(/^(.+?)\s*(?:=>|->|ï¼š|:|=)\s*(.+)$/);if(!u)continue;const g=u[1].trim(),f=nt(u[2]);g&&l.push({original:g,used:f})}}const o=new Map;for(const i of l){const c=typeof i.original=="string"?i.original.trim():"";if(!c)continue;const u=c.toLowerCase(),g=nt(i.used||c);o.has(u)||o.set(u,{original:c,used:g||c})}const d=[];for(const i of e||[]){const c=i.trim().toLowerCase(),u=o.get(c),g=u?u.used:i;d.push({original:i,used:g})}return d}async function re(t,e,n,a,s){const r=ne(a,s),l={model:n,messages:[{role:"system",content:"You are an assistant that extracts vocabulary mappings and responds with concise JSON."},{role:"user",content:r}],temperature:0,max_tokens:3e3};console.log("[Variant Mapping] è¯·æ±‚ä½“:",JSON.stringify(l,null,2));const o=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(l)});if(console.log("[Variant Mapping] å“åº”çŠ¶æ€:",o.status,o.statusText),!o.ok){const u=await o.text();throw console.error("[Variant Mapping] APIé”™è¯¯å“åº”:",u),new Error(`è¯å½¢æ˜ å°„è¯·æ±‚å¤±è´¥: ${o.status} ${o.statusText}: ${u}`)}const d=await o.json();console.log("[Variant Mapping] APIå“åº”:",d);const i=d?.choices?.[0]?.message;if(!i)throw new Error("è¯å½¢æ˜ å°„å“åº”æ ¼å¼å¼‚å¸¸");const c=K(i);return console.log("[Variant Mapping] AIå›å¤:",c),oe(c,s)}async function se(){if(!x)return;const t=qt(st?.value||"");if(!t.length){p("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç›®æ ‡è¯æ±‡","warn"),st?.focus();return}const{apiUrl:e,apiKey:n,model:a}=mt();if(!e||!n){p("è¯·å…ˆåœ¨å³ä¾§é…ç½®AI APIåœ°å€ä¸Key","warn");return}const s=x.dataset.originalText||x.textContent;try{x.disabled=!0,x.dataset.originalText=s,x.textContent="ç”Ÿæˆä¸­â€¦",p("æ­£åœ¨è¯·æ±‚AIç”Ÿæˆæ–‡ç« â€¦","info");const r=te(t),l=ee(r),o={model:a,messages:[{role:"system",content:"You are an expert science writer who produces fluent, engaging English articles in Markdown without extra commentary."},{role:"user",content:l}],temperature:.65,top_p:.9,max_tokens:Math.min(1200,Math.round(Jt*4.2))};console.log("[Article Generator] è¯·æ±‚ä½“:",JSON.stringify(o,null,2));const d=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(o)});if(!d.ok){const $=await d.text();throw new Error(`APIè¯·æ±‚å¤±è´¥: ${d.status} ${d.statusText} | ${$}`)}const i=await d.json();console.log("[Article Generator] APIå“åº”:",i);const c=i?.choices?.[0]?.message;if(!c)throw new Error("AIæœªè¿”å›æ–‡ç« å†…å®¹");const u=K(c);if(!u)throw new Error("AIæœªè¿”å›æ–‡ç« å†…å®¹");P.value=u.trim();let g,f=!1;try{if(p("æ–‡ç« ç”ŸæˆæˆåŠŸï¼Œæ­£åœ¨åˆ†æè¯å½¢æ˜ å°„â€¦","info"),g=await re(e,n,a,u,t),!Array.isArray(g)||!g.length)throw new Error("æœªè·å¾—æœ‰æ•ˆçš„è¯å½¢æ˜ å°„")}catch($){console.error("[Article Generator] è¯å½¢æ˜ å°„å¤±è´¥:",$),g=t.map(S=>({original:S,used:S})),p("æ–‡ç« ç”Ÿæˆå®Œæˆï¼Œä½†è¯å½¢æ˜ å°„å¤±è´¥ï¼Œå·²ä½¿ç”¨åŸå§‹è¯æ±‡ã€‚","warn"),I("è¯å½¢æ˜ å°„å¤±è´¥ï¼Œå·²ä½¿ç”¨åŸå§‹è¯æ±‡","warn"),f=!0}console.log("[Article Generator] æœ€ç»ˆè¯å½¢æ˜ å°„:",g),pt(u,g),Z();const b=Kt(u,t,g);if(b.length){const $=`âš ï¸ å·²ç”Ÿæˆæ–‡ç« ï¼Œä½†ç¼ºå°‘ ${b.length} ä¸ªè¯ï¼š${b.join("ï¼Œ")}`;p($,"warn"),I("ç”Ÿæˆå®Œæˆï¼Œä½†å­˜åœ¨ç¼ºå¤±è¯æ±‡ï¼Œè¯·æ‰‹åŠ¨è¡¥å……ã€‚","warn")}else f||(p("AIæ–‡ç« ç”Ÿæˆå®Œæˆï¼Œè¯æ±‡ä¸è¯å½¢å‡å·²è¦†ç›– âœ“","ok"),I("æ–‡ç« ç”ŸæˆæˆåŠŸå¹¶åŒ…å«å…¨éƒ¨ç›®æ ‡è¯æ±‡ï¼","ok"));await Lt({quiet:!0})}catch(r){console.error("[Article Generator] ç”Ÿæˆæ–‡ç« å¤±è´¥:",r),p(`ç”Ÿæˆå¤±è´¥ï¼š${r.message}`,"warn")}finally{x.disabled=!1,x.textContent=x.dataset.originalText||"âœ¨ AIç”Ÿæˆæ–‡ç« "}}function pt(t,e=[]){try{B=typeof t=="string"?t:"",jt(B),Ht(e);const n=ae(t);rt.innerHTML=n,ie(t),ce(),L.buildList(y),R.textContent="æ–‡ç« ä¿å­˜æˆåŠŸï¼",R.style.color="var(--ok)"}catch(n){R.textContent="å¤„ç†æ–‡ç« å†…å®¹æ—¶å‡ºé”™: "+n.message,R.style.color="var(--warn)"}}function ae(t){return t.split(`

`).map(a=>`<p>${a.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function ie(t){const e=/\*\*(.*?)\*\*/g,n=[],a=new Set;let s;for(;(s=e.exec(t))!==null;){const r=s[1]?.trim();if(!r)continue;const l=ft(r)||r;$t(l,r),a.has(l)||(a.add(l),n.push(l))}It(n)}function ce(){if(M.clear(),!rt)return;rt.querySelectorAll("p").forEach(e=>{const n=e.textContent?e.textContent.replace(/\s+/g," ").trim():"";if(!n)return;e.querySelectorAll("strong").forEach(s=>{const r=s.textContent?s.textContent.trim():"";if(!r)return;const l=ft(r)||r;if(!l||M.has(l))return;const o=le(n,r)||n;M.set(l,o)})})}function le(t,e){if(!t||!e)return"";const n=t.replace(/\s+/g," ").trim(),a=e.trim().toLowerCase(),s=n.match(/[^ã€‚ï¼ï¼Ÿ!?.]+[ã€‚ï¼ï¼Ÿ!?.]?/g)||[n];for(const r of s)if(r.toLowerCase().includes(a))return r.trim();return n}function de(){ut.classList.add("active"),gt.classList.remove("active"),xt.style.display="block",bt.style.display="none"}function Z(){ut.classList.remove("active"),gt.classList.add("active"),xt.style.display="none",bt.style.display="block"}ut.addEventListener("click",de);gt.addEventListener("click",Z);Ot.addEventListener("click",()=>{const t=P.value;t.trim()?(pt(t),Z()):(R.textContent="è¯·è¾“å…¥æ–‡ç« å†…å®¹",R.style.color="var(--warn)")});x&&x.addEventListener("click",se);C&&C.addEventListener("click",t=>{t.preventDefault(),Qt()});h&&h.addEventListener("click",async()=>{const t=Yt();if(!t.length){w("è¯·å…ˆå®ŒæˆAIåˆ¤é¢˜åå†åŒæ­¥ã€‚","warn"),I("æ²¡æœ‰å¯åŒæ­¥çš„åˆ¤é¢˜åˆ†æ•°","warn");return}const e=X(),n=e.replace(/\/$/,"")+"/api/word-scores",a=Xt(),s=h.dataset.originalText||h.textContent;h.dataset.originalText=s,h.disabled=!0,h.textContent="åŒæ­¥ä¸­â€¦",w("æ­£åœ¨åŒæ­¥åˆ¤é¢˜ç»“æœåˆ°æœåŠ¡å™¨â€¦","info");try{const r=await lt(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({results:t,article:a})}),l=Array.isArray(r?.scores)?r.scores:[];Y(l);const o=r?.updated??t.length,d=r?.session_id,i=d?`ï¼ˆå†å²è®°å½• #${d} å·²ç”Ÿæˆï¼‰`:"";w(`åŒæ­¥æˆåŠŸï¼Œå·²æ›´æ–° ${o} ä¸ªè¯æ±‡${i}`,"ok"),I(d?`åŒæ­¥å®Œæˆï¼å†å²è®°å½• #${d}`:"æœåŠ¡å™¨è¯è¡¨å·²æ›´æ–° âœ“","ok"),localStorage.setItem("score-api-url",e)}catch(r){console.error("[Sync Scores] åŒæ­¥å¤±è´¥:",r),w(`åŒæ­¥å¤±è´¥ï¼š${r.message}`,"warn"),I("åŒæ­¥å¤±è´¥ï¼š"+r.message,"warn")}finally{h.disabled=!1,h.textContent=h.dataset.originalText||"â¬†ï¸ åŒæ­¥åˆ°æœåŠ¡å™¨"}});function ue(t){const e=document.getElementById(H(t));if(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus();const n=e.closest(".item");n&&(n.style.outline="2px solid var(--accent-2)",n.style.boxShadow="0 0 0 4px rgba(137,220,235,.25)",setTimeout(()=>{n.style.outline="",n.style.boxShadow=""},1500))}}It(y);z.addEventListener("click",t=>{const e=t.target;if(e.classList.contains("jump"))it(e.dataset.term);else if(e.classList.contains("term")||e.parentElement.classList.contains("term")){const n=e.dataset.term||e.parentElement.dataset.term;n&&it(n)}});At.addEventListener("input",()=>L.buildList(y));z.addEventListener("focus",t=>{t.target.tagName==="INPUT"&&t.target.dataset.term&&it(t.target.dataset.term)},!0);document.getElementById("article-content").addEventListener("click",t=>{if(t.target.tagName==="STRONG"){const e=t.target.textContent.trim(),n=ft(e);n&&y.includes(n)&&ue(n)}});const Tt="geo_vocab_answers_v1";function Ct(){const t={};for(const e of y){const n=document.getElementById(H(e));t[e]=n&&n.value||""}return t}function ge(t){if(t){for(const e of y){const n=document.getElementById(H(e));n&&e in t&&(n.value=t[e]||"")}L.updateFilledState(y)}}function Mt(){try{const t=Ct();localStorage.setItem(Tt,JSON.stringify(t)),L.updateFilledState(y)}catch(t){console.warn("[Persist Answers] ä¿å­˜å¤±è´¥:",t)}}let q=null;function fe(){q&&clearTimeout(q),q=setTimeout(()=>{q=null,Mt()},300)}try{const t=JSON.parse(localStorage.getItem(Tt)||"null");ge(t)}catch(t){console.warn("[Persist Answers] æ¢å¤ç¼“å­˜å¤±è´¥:",t)}z.addEventListener("input",t=>{const e=t.target;e instanceof HTMLInputElement&&e.dataset.term&&(fe(),L.updateFilledState(y))});document.getElementById("clear").addEventListener("click",()=>{for(const t of y){const e=document.getElementById(H(t));e&&(e.value="")}Mt(),L.updateFilledState(y),I("å·²æ¸…ç©ºè¾“å…¥","warn")});function I(t,e){const n=document.createElement("div");n.textContent=t,n.style.position="fixed",n.style.right="18px",n.style.bottom="18px",n.style.background="rgba(10,15,30,.95)",n.style.border="1px solid rgba(122,162,247,.3)",n.style.color=e==="ok"?"var(--ok)":e==="warn"?"var(--warn)":"var(--text)",n.style.padding="10px 12px",n.style.borderRadius="10px",n.style.boxShadow="0 6px 18px var(--shadow)",document.body.appendChild(n),setTimeout(()=>n.remove(),2200)}let O=!1;const k=document.getElementById("ai-config"),D=document.getElementById("ai-results"),ot=document.getElementById("ai-progress"),me=document.getElementById("progress-fill"),ht=document.getElementById("progress-text"),ct=document.getElementById("score-summary"),G=document.getElementById("ai-identity-check");document.getElementById("ai-grade").addEventListener("click",async()=>{if(k.style.display==="none"){k.style.display="block",p("");const t=localStorage.getItem("ai-api-url"),e=localStorage.getItem("ai-api-key"),n=localStorage.getItem("ai-model")||"gpt-3.5-turbo";t&&(document.getElementById("api-url").value=t),e&&(document.getElementById("api-key").value=e),document.getElementById("ai-model").value=n;const a=localStorage.getItem("score-api-url");F&&(F.value=a||F.value||"http://localhost:4000"),Y([]),w("åŒæ­¥åå°†æ˜¾ç¤ºæœ¬æ¬¡æäº¤çš„è¯æ±‡æˆç»©","info")}else k.style.display="none"});G.addEventListener("click",async()=>{const{apiUrl:t,apiKey:e,model:n}=mt();if(!t||!e){alert(`è¯·å…ˆé…ç½®APIåœ°å€å’ŒKeyï¼

ç‚¹å‡»"ğŸ¤– AIå·¥å…·ç®±"æŒ‰é’®è¿›è¡Œé…ç½®ã€‚`);return}G.textContent="ğŸ” æ£€æµ‹ä¸­...",G.disabled=!0;try{const a=await Ae(t,e,n);alert(`AIèº«ä»½ä¿¡æ¯ï¼š

${a}`)}catch(a){alert(`AIèº«ä»½æ£€æµ‹å¤±è´¥ï¼š

${a.message}`)}finally{G.textContent="ğŸ” æ£€æµ‹AIèº«ä»½",G.disabled=!1}});document.getElementById("cancel-grade").addEventListener("click",()=>{k.style.display="none",O=!1});m&&m.addEventListener("click",async()=>{const{apiUrl:t,apiKey:e,model:n}=mt();if(!t||!e){k.style.display="block",I("è¯·å¡«å†™APIåœ°å€å’ŒKey","warn");return}const a=m.dataset.originalText||m.textContent;m.dataset.originalText=a,j("åˆ¤é¢˜å‡†å¤‡ä¸­â€¦",!0);try{await pe(t,e,n)}finally{setTimeout(Wt,600)}});async function pe(t,e,n="gpt-3.5-turbo"){if(console.log("[Main Grading] å¼€å§‹AIåˆ¤é¢˜æµç¨‹"),console.log("[Main Grading] API URL:",t),console.log("[Main Grading] æ¨¡å‹:",n),console.log("[Main Grading] API Key é•¿åº¦:",e?e.length:0),O){console.warn("[Main Grading] åˆ¤é¢˜å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡");return}O=!0,ot.style.display="block",D.style.display="none",kt();try{const a=Ct();console.log("[Main Grading] æ”¶é›†çš„æ•°æ®:",a);const s=y.filter(i=>a[i]&&a[i].trim());if(console.log("[Main Grading] å·²å¡«å†™çš„è¯æ±‡:",s),console.log("[Main Grading] å·²å¡«å†™è¯æ±‡æ•°é‡:",s.length),s.length===0){console.warn("[Main Grading] æ²¡æœ‰å¡«å†™çš„è¯æ±‡"),I("è¯·å…ˆå¡«å†™ä¸€äº›ç­”æ¡ˆ","warn"),O=!1,ot.style.display="none";return}ht.textContent=`å¼€å§‹åˆ¤é¢˜... (å…±${s.length}ä¸ªè¯)`,m&&j(`åˆ¤é¢˜ä¸­ 0/${s.length}`,!0);const r=50,l=[];for(let i=0;i<s.length;i+=r)l.push(s.slice(i,i+r));console.log("[Main Grading] åˆ†æ‰¹å¤„ç†:",l.length,"ä¸ªæ‰¹æ¬¡");let o=0;const d={};for(let i=0;i<l.length;i++){const c=l[i];console.log(`[Main Grading] å¤„ç†ç¬¬${i+1}æ‰¹:`,c),ht.textContent=`æ­£åœ¨å¤„ç†ç¬¬${i+1}/${l.length}æ‰¹ (${c.length}ä¸ªè¯)...`;try{const u=await ye(c,a,t,e,n);console.log(`[Main Grading] ç¬¬${i+1}æ‰¹ç»“æœ:`,u),Object.assign(d,u),o+=c.length;const g=o/s.length*100;if(me.style.width=g+"%",console.log(`[Main Grading] è¿›åº¦: ${g}% (${o}/${s.length})`),m){const f=Math.round(g);j(`åˆ¤é¢˜ä¸­ ${o}/${s.length} (${f}%)`,!0)}i<l.length-1&&(console.log("[Main Grading] ç­‰å¾…1ç§’é¿å…é¢‘ç‡é™åˆ¶"),await new Promise(f=>setTimeout(f,1e3)))}catch(u){console.error(`[Main Grading] ç¬¬${i+1}æ‰¹å¤„ç†å¤±è´¥:`,u),I(`ç¬¬${i+1}æ‰¹å¤„ç†å¤±è´¥: ${u.message}`,"warn")}}console.log("[Main Grading] æ‰€æœ‰æ‰¹æ¬¡å¤„ç†å®Œæˆï¼Œæœ€ç»ˆç»“æœ:",d),Bt(d,s.length),m&&j("åˆ¤é¢˜å®Œæˆ âœ“",!0)}catch(a){console.error("[Main Grading] åˆ¤é¢˜è¿‡ç¨‹é”™è¯¯:",a),I("åˆ¤é¢˜è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: "+a.message,"warn"),m&&j("åˆ¤é¢˜å¤±è´¥",!0)}finally{O=!1,ot.style.display="none",console.log("[Main Grading] åˆ¤é¢˜æµç¨‹ç»“æŸ")}}async function ye(t,e,n,a,s="gpt-3.5-turbo"){console.log("[Batch Grading] å¼€å§‹å¤„ç†æ‰¹æ¬¡:",t),console.log("[Batch Grading] ä½¿ç”¨æ¨¡å‹:",s);const r=we(t,e);console.log("[Batch Grading] ç”Ÿæˆçš„æç¤ºè¯:",r);const l={model:s,messages:[{role:"user",content:r}],temperature:.1};console.log("[Batch Grading] è¯·æ±‚ä½“:",JSON.stringify(l,null,2));const o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(l)});if(console.log("[Batch Grading] å“åº”çŠ¶æ€:",o.status,o.statusText),!o.ok){const g=await o.text();throw console.error("[Batch Grading] APIé”™è¯¯å“åº”:",g),new Error(`APIè¯·æ±‚å¤±è´¥: ${o.status} ${o.statusText}: ${g}`)}const d=await o.json();console.log("[Batch Grading] APIå“åº”:",d);const i=d?.choices?.[0]?.message;if(!i)throw console.error("[Batch Grading] å“åº”æ ¼å¼å¼‚å¸¸:",d),new Error("APIå“åº”æ ¼å¼å¼‚å¸¸");const c=K(i);console.log("[Batch Grading] AIå›å¤å†…å®¹:",c);const u=Ie(c,t);return console.log("[Batch Grading] è§£æç»“æœ:",u),u}function he(t){const e=typeof t=="number"?t:parseFloat(t);if(!Number.isFinite(e))return null;const n=Math.min(Math.max(e,0),1);return Math.round(n*1e3)/1e3}function we(t,e){return`ä½ æ˜¯ä¸€åç²¾é€šä¸­è‹±æ–‡æœ¯è¯­çš„æ•™å¸ˆï¼Œéœ€è¦åˆ¤æ–­å­¦ç”Ÿç»™å‡ºçš„ä¸­æ–‡ç¿»è¯‘ä¸è‹±æ–‡æœ¯è¯­çš„è¯­ä¹‰ç›¸ä¼¼åº¦ã€‚è¯·èšç„¦è¯ä¹‰æœ¬èº«ï¼Œä¸è¦è´´åˆç‰¹å®šå­¦ç§‘èƒŒæ™¯æˆ–å†·åƒ»çŸ¥è¯†ã€‚

è¯·å¯¹æ¯ä¸ªè¯æ±‡ï¼š
1. ç»™å‡ºæœ€æ ‡å‡†ã€æœ€å¸¸ç”¨çš„ä¸­æ–‡ç¿»è¯‘ï¼ˆå¯åŒ…å«å¤šä¸ªè¯ï¼Œç¡®ä¿å«ä¹‰å‡†ç¡®ï¼‰ã€‚
2. è¯„ä¼°å­¦ç”Ÿç­”æ¡ˆä¸æ ‡å‡†ç­”æ¡ˆåœ¨è¯­ä¹‰ä¸Šçš„ç›¸ä¼¼åº¦ï¼Œç›¸ä¼¼åº¦ç”¨ 0~1 çš„å°æ•°è¡¨ç¤ºï¼š0 ä»£è¡¨å®Œå…¨é”™è¯¯ï¼Œ1 ä»£è¡¨å®Œå…¨ä¸€è‡´ã€‚å…è®¸ä¿ç•™ä¸‰ä½å°æ•°ã€‚
   - è‹¥å­¦ç”Ÿç­”æ¡ˆæ¶µç›–äº†ä¸»è¦å«ä¹‰æˆ–æä¾›äº†å¸¸è§è¿‘ä¹‰è¯ï¼Œå³ä½¿æœªåˆ—å‡ºå…¨éƒ¨é‡Šä¹‰ï¼Œä¹Ÿåº”ç»™äºˆè¾ƒé«˜åˆ†ï¼ˆä¾‹å¦‚ â‰¥0.7ï¼‰ã€‚
3. å¦‚æœ‰éœ€è¦ï¼Œå¯ç»™å‡ºç®€çŸ­è¯´æ˜ï¼ˆ10~25ä¸ªå­—ï¼‰ï¼Œè§£é‡Šä¸»è¦å·®å¼‚æˆ–åŒ¹é…äº®ç‚¹ã€‚

åœ¨è¯„ä¼°æ—¶è¯·ç»“åˆæä¾›çš„åŸæ–‡è¯­å¢ƒç†è§£æœ¯è¯­çš„å«ä¹‰ï¼Œä»¥è¯¥è¯­å¢ƒä¸ºå‡†åˆ¤æ–­å­¦ç”Ÿç¿»è¯‘çš„å‡†ç¡®åº¦ã€‚

è¯„åˆ†åŸºå‡†ç¤ºä¾‹ï¼š
- å­¦ç”Ÿç­”æ¡ˆã€Œæç‚¹ã€ï¼Œæ ‡å‡†ç­”æ¡ˆã€Œæ†ï¼›æç‚¹ï¼›ç”µæã€â†’ 1.0 åˆ†ï¼ˆæ ¸å¿ƒå«ä¹‰å®Œå…¨å¯¹åº”ï¼‰
- å­¦ç”Ÿç­”æ¡ˆã€ŒçƒŸã€ï¼Œæ ‡å‡†ç­”æ¡ˆã€ŒçƒŸé›¾ã€â†’ 0.7 åˆ†ï¼ˆä¼ è¾¾ä¸»è¦æ¦‚å¿µï¼Œç»†èŠ‚ç•¥ç¼ºï¼‰
- å­¦ç”Ÿç­”æ¡ˆã€Œå¹³å¦çš„ã€ï¼Œæ ‡å‡†ç­”æ¡ˆã€Œå¹³åŸã€â†’ 0.5 åˆ†ï¼ˆç›¸å…³ä½†åå‘å½¢å®¹è¯ï¼Œéœ€è¦æŒ‡å‡ºè¯­ä¹‰å·®å¼‚ï¼‰

åŠ¡å¿…åªè¾“å‡º JSONï¼Œä¸è¦è§£é‡Šã€‚JSON æ ¼å¼å¦‚ä¸‹ï¼š
{
  "è‹±æ–‡è¯æ±‡": {
    "æ ‡å‡†ç­”æ¡ˆ": "æ ‡å‡†ä¸­æ–‡ç¿»è¯‘",
    "ç›¸ä¼¼åº¦": 0.000,
    "è¯´æ˜": "å¯é€‰ï¼Œè‹¥æ— åˆ™ç•™ç©ºå­—ç¬¦ä¸²"
  }
}

å¾…è¯„ä¼°çš„è¯æ±‡ä¸å­¦ç”Ÿç­”æ¡ˆï¼š
${t.map(a=>{const r=(M.get(a)||"ï¼ˆåŸæ–‡æœªæä¾›è¯­å¢ƒï¼‰").replace(/\s+/g," ").trim(),l=e[a]&&e[a].trim()?e[a].trim():"(ç©ºç™½)";return`- è‹±æ–‡è¯æ±‡: ${a}
  åŸæ–‡è¯­å¢ƒ: ${r}
  å­¦ç”Ÿç¿»è¯‘: ${l}`}).join(`
`)}`}function Ie(t,e){console.log("[Parse Response] å¼€å§‹è§£æAIå›å¤:",t),console.log("[Parse Response] éœ€è¦è§£æçš„è¯æ±‡:",e);try{const n=t.match(/\{[\s\S]*\}/);if(console.log("[Parse Response] JSONåŒ¹é…ç»“æœ:",n?n[0]:"null"),!n)throw console.warn("[Parse Response] æœªæ‰¾åˆ°JSONæ ¼å¼ï¼Œä½¿ç”¨fallbackè§£æ"),new Error("æ— æ³•è§£æAIå›å¤æ ¼å¼");const a=JSON.parse(n[0]);console.log("[Parse Response] JSONè§£ææˆåŠŸ:",a);const s={};return e.forEach(r=>{console.log(`[Parse Response] å¤„ç†è¯æ±‡: ${r}`);const l=a[r]||a[r.trim()]||null;if(l&&typeof l=="object"){const o=l.ç›¸ä¼¼åº¦??l.similarity??l.score,d=he(typeof o=="string"?parseFloat(o):o),i=(l.æ ‡å‡†ç­”æ¡ˆ??l.æ­£ç¡®ç­”æ¡ˆ??"").toString().trim(),c=(l.è¯´æ˜??l.è§£é‡Š??"").toString().trim();s[r]={similarity:typeof d=="number"?d:null,standardAnswer:i||null,explanation:c||null},console.log(`[Parse Response] ${r} è§£ææˆåŠŸ - ç›¸ä¼¼åº¦:`,s[r].similarity,"æ ‡å‡†ç­”æ¡ˆ:",s[r].standardAnswer,"è¯´æ˜:",s[r].explanation)}else if(typeof l=="string"){const o=l==="æ­£ç¡®";s[r]={similarity:o?1:0,standardAnswer:null,explanation:null},console.log(`[Parse Response] ${r} ä½¿ç”¨æ—§æ ¼å¼å­—ç¬¦ä¸² - ç›¸ä¼¼åº¦æ¨¡æ‹Ÿ:`,s[r].similarity)}else console.log(`[Parse Response] ${r} æœªåœ¨è§£æç»“æœä¸­æ‰¾åˆ°ï¼Œä½¿ç”¨fallback`),s[r]={similarity:null,standardAnswer:null,explanation:null}}),console.log("[Parse Response] æœ€ç»ˆè§£æç»“æœ:",s),s}catch(n){console.error("[Parse Response] JSONè§£æå¤±è´¥:",n),console.log("[Parse Response] ä½¿ç”¨fallbackè§£ææ–¹æ³•");const a={};return e.forEach(s=>{const r=s.toLowerCase(),l=t.toLowerCase();a[s]={similarity:l.includes(r)?.5:null,standardAnswer:null,explanation:null},console.log(`[Parse Response] ${s} fallbackç»“æœ - ç›¸ä¼¼åº¦: ${a[s].similarity}`)}),console.log("[Parse Response] Fallbackæœ€ç»ˆç»“æœ:",a),a}}function Bt(t,e,n={}){const{suppressToast:a=!1}=n||{};V=t||{},Gt(V);const s=Object.values(t).map(c=>typeof c.similarity=="number"?c.similarity:null).filter(c=>c!==null),r=s.length?Math.round(s.reduce((c,u)=>c+u,0)/s.length*100)/100:0,l=s.filter(c=>c>=U).length,o=s.filter(c=>c<U&&c>=et).length,d=U.toFixed(2),i=et.toFixed(2);ct.innerHTML=`
    <div>åˆ¤é¢˜å®Œæˆï¼</div>
    <div class="score-line">
      <span>å¹³å‡ç›¸ä¼¼åº¦ï¼š<strong>${r.toFixed(2)}</strong></span>
      <span>é«˜åŒ¹é…(â‰¥${d}): <strong>${l}</strong></span>
      <span>ä¸­ç­‰åŒ¹é…(â‰¥${i}): <strong>${o}</strong></span>
      <span>æ€»è¯æ•°: <strong>${e}</strong></span>
    </div>
  `,Object.entries(t).forEach(([c,u])=>{const g=document.querySelector(`[data-term="${c}"]`)?.closest(".item");if(!g)return;g.classList.remove("correct","incorrect","partial");const f=typeof u.similarity=="number"?u.similarity:null;let b="incorrect";f!==null&&(f>=U?b="correct":f>=et&&(b="partial")),g.classList.add(b);const $=g.querySelector(".term");if(!$)return;let S=$.querySelector(".grade-indicator");S||(S=document.createElement("span"),S.className="grade-indicator",$.appendChild(S)),S.className=`grade-indicator ${b}`,S.textContent=f!==null?f.toFixed(2):"â€”",S.title="è¯­ä¹‰ç›¸ä¼¼åº¦ (0-1)";let E=g.querySelector(".grading-details");if(E||(E=document.createElement("div"),E.className="grading-details",g.appendChild(E)),E.innerHTML="",f!==null){const A=document.createElement("div"),T=document.createElement("strong");T.textContent="ç›¸ä¼¼åº¦:",A.appendChild(T),A.appendChild(document.createTextNode(" "+f.toFixed(2))),E.appendChild(A)}if(u.standardAnswer){const A=document.createElement("div"),T=document.createElement("strong");T.textContent="æ ‡å‡†ç­”æ¡ˆ:",A.appendChild(T),A.appendChild(document.createTextNode(" "+u.standardAnswer)),E.appendChild(A)}if(u.explanation){const A=document.createElement("div"),T=document.createElement("strong");T.textContent="è¯´æ˜:",A.appendChild(T),A.appendChild(document.createTextNode(" "+u.explanation)),E.appendChild(A)}E.hasChildNodes()||E.remove()}),D.style.display="block",k.style.display="none",a||I(`åˆ¤é¢˜å®Œæˆï¼å¹³å‡ç›¸ä¼¼åº¦ ${r.toFixed(2)}`,"ok")}function kt(){V={},document.querySelectorAll(".item").forEach(t=>{t.classList.remove("correct","incorrect","partial");const e=t.querySelector(".grade-indicator");e&&e.remove();const n=t.querySelector(".grading-details");n&&n.remove()})}async function Ae(t,e,n="gpt-3.5-turbo"){console.log("[AI Identity] å¼€å§‹æ£€æµ‹AIèº«ä»½"),console.log("[AI Identity] API URL:",t),console.log("[AI Identity] æ¨¡å‹:",n),console.log("[AI Identity] API Key é•¿åº¦:",e?e.length:0);const a={model:n,messages:[{role:"user",content:"ä½ å¥½ï¼Œè¯·è¯¦ç»†ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ï¼ŒåŒ…æ‹¬ä½ çš„åç§°ã€ç‰ˆæœ¬ã€ä¸»è¦åŠŸèƒ½å’Œç‰¹è‰²ã€‚"}],temperature:.1,max_tokens:200};console.log("[AI Identity] è¯·æ±‚ä½“:",JSON.stringify(a,null,2));const s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(a)});if(console.log("[AI Identity] å“åº”çŠ¶æ€:",s.status,s.statusText),!s.ok){const d=await s.text();throw console.error("[AI Identity] APIé”™è¯¯å“åº”:",d),new Error(`${s.status} ${s.statusText}: ${d}`)}const r=await s.json();console.log("[AI Identity] APIå“åº”:",r);const l=r?.choices?.[0]?.message;if(!l)throw console.error("[AI Identity] å“åº”æ ¼å¼å¼‚å¸¸:",r),new Error("APIå“åº”æ ¼å¼å¼‚å¸¸");const o=K(l);if(!o)throw console.error("[AI Identity] æœªè·å¾—æ–‡æœ¬å›å¤:",l),new Error("AIæœªè¿”å›æ–‡æœ¬ä¿¡æ¯");return console.log("[AI Identity] AIå›å¤:",o),o}async function xe(t){const e=Number(t);if(!Number.isInteger(e)||e<=0){w(`æ— æ³•è¯†åˆ«çš„å†å²è®°å½•ç¼–å·ï¼š${t}`,"warn");return}const n=X();if(!n){w("è¯·å…ˆé…ç½®æœåŠ¡å™¨åœ°å€å†åŠ è½½å†å²è®°å½•ã€‚","warn");return}const a=`${n.replace(/\/$/,"")}/api/sessions/${e}`;w(`æ­£åœ¨åŠ è½½å†å²è®°å½• #${e}â€¦`,"info");try{const s=await fetch(a,{headers:{Accept:"application/json"}});if(!s.ok){const c=await s.text();throw new Error(`HTTP ${s.status} ${s.statusText}: ${c}`)}const r=await s.json(),l=r?.session||{},o=Array.isArray(r?.results)?r.results:[],d=typeof l.article=="string"?l.article:"";typeof B<"u"&&(B=d),P&&(P.value=d),pt(d||"",[]),Z();const i={};if(o.forEach(c=>{if(!c||typeof c.term!="string")return;const u=c.term.trim();if(!u)return;const g=typeof c.similarity=="number"?c.similarity:Number(c.similarity),f=c.standard_answer||c.standardAnswer||null,b=c.explanation||null;i[u]={similarity:Number.isFinite(g)?g:null,standardAnswer:f,explanation:b},c.context&&M&&M.set(u,c.context)}),Object.keys(i).length?Bt(i,l.total_terms||o.length,{suppressToast:!0}):(kt(),D.style.display="none"),ct){const c=l.submitted_at?new Date(l.submitted_at):null,u=typeof l.avg_similarity=="number"?l.avg_similarity:Number(l.avg_similarity),g=[];c&&!Number.isNaN(c.getTime())&&g.push(`æäº¤æ—¶é—´ï¼š${c.toLocaleString()}`),g.push(`æ€»è¯æ•°ï¼š${l.total_terms??o.length}`),Number.isFinite(u)&&g.push(`å¹³å‡ç›¸ä¼¼åº¦ï¼š${u.toFixed(2)}`),g.push(`æ­£ç¡® / éƒ¨åˆ†æ­£ç¡® / é”™è¯¯ï¼š${l.correct_terms??0} / ${l.partial_terms??0} / ${l.incorrect_terms??0}`),ct.insertAdjacentHTML("beforeend",`<div class="score-line history-note">${g.join(" ï½œ ")}</div>`)}D.style.display="block",k.style.display="none",w(`å·²åŠ è½½å†å²è®°å½• #${e}ï¼Œå¦‚éœ€é‡æ–°ç»ƒä¹ å¯ç›´æ¥ç¼–è¾‘æ–‡ç« ã€‚`,"ok"),document.body.classList.add("replay-mode")}catch(s){console.error("[History Replay] åŠ è½½å†å²è®°å½•å¤±è´¥:",s),w(`åŠ è½½å†å²è®°å½•å¤±è´¥ï¼š${s.message}`,"warn"),I("åŠ è½½å†å²è®°å½•å¤±è´¥ï¼š"+s.message,"warn")}}const wt=new URLSearchParams(window.location.search).get("session");wt&&xe(wt);
