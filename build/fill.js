import{e as P,f as rt}from"./chunks/html.js";import{m as Lt,a as zt,b as Kt}from"./chunks/history-storage.js";function Wt({listElement:t,filterInput:e,scoreCache:n,makeId:r}){function s(o){if(Array.isArray(o))for(const d of o){const i=document.getElementById(r(d));if(!i)continue;const c=i.closest(".item");if(!c)continue;const u=i.value&&i.value.trim().length>0;c.classList.toggle("filled",u)}}function l(){if(!t)return;t.querySelectorAll(".score-badge").forEach(d=>{const i=d.dataset.termScore,c=i&&n?.has(i)?n.get(i):null;typeof c=="number"?(d.textContent=c.toFixed(2),d.classList.add("score-known")):(d.textContent="—",d.classList.remove("score-known"))})}function a(o){if(!t||!Array.isArray(o))return;const d=e?.value?.trim().toLowerCase(),i=[];for(const c of o){if(d&&!c.toLowerCase().includes(d))continue;const u=r(c),m=n?.has(c)?n.get(c):null,f=typeof m=="number"?m.toFixed(2):"—";i.push(`
        <div class="item">
          <div class="term" data-term="${P(c)}">
            <span>${P(c)}</span>
            <span class="score-badge" data-term-score="${P(c)}">${f}</span>
            <span class="jump" data-term="${P(c)}">跳到文中</span>
          </div>
          <input aria-label="${P(c)} 中文意思" placeholder="中文意思…" id="${P(u)}" data-term="${P(c)}" />
        </div>
      `)}t.innerHTML=i.join(""),s(o),l()}return{buildList:a,updateFilledState:s,updateScoreBadges:l}}function Yt(t={}){const e={...t},n=new Map;function r(o){return e[o]}function s(o,d){const i=e[o];if(e[o]=d,i===d)return d;const c=n.get(o);if(c)for(const u of c)try{u(d,{...e})}catch(m){console.error("[Store] listener error",m)}return d}function l(o,d){if(typeof d!="function")return()=>{};const i=n.get(o);return i?i.add(d):n.set(o,new Set([d])),()=>{const c=n.get(o);c&&(c.delete(d),c.size===0&&n.delete(o))}}function a(){return{...e}}return{get:r,set:s,subscribe:l,snapshot:a}}const W=Yt({vocabs:[],serverScores:[],gradingResults:{},articleMarkdown:""}),Tt=t=>W.set("vocabs",Array.isArray(t)?[...t]:[]),Mt=t=>W.set("serverScores",Array.isArray(t)?[...t]:[]),Xt=t=>W.set("gradingResults",t||{}),Zt=t=>W.set("articleMarkdown",typeof t=="string"?t:"");let I=[];const K=new Map,wt=new Map,N=new Map;let O="";const ot=document.getElementById("list"),Bt=document.getElementById("filter"),It=document.getElementById("edit-mode-btn"),bt=document.getElementById("view-mode-btn"),Nt=document.getElementById("edit-section"),Rt=document.getElementById("view-section"),H=document.getElementById("article-editor"),Qt=document.getElementById("save-article-btn"),F=document.getElementById("editor-status"),ft=document.getElementById("article-content"),pt=document.getElementById("generator-words"),v=document.getElementById("generate-article-btn"),ct=document.getElementById("generator-status"),y=document.getElementById("start-grade"),b=document.getElementById("sync-server"),j=document.getElementById("sync-status"),V=document.getElementById("server-scores"),z=document.getElementById("score-api-url"),kt=document.getElementById("api-url"),Pt=document.getElementById("api-key"),Gt=document.getElementById("ai-model"),te=document.getElementById("practiced-count"),ee=document.getElementById("total-count"),ne=document.getElementById("mastery-threshold"),G=document.getElementById("auto-fill-words"),tt=new Map,et=new Map;function Ot(t,{reset:e=!1}={}){if(e&&(tt.clear(),et.clear()),!Array.isArray(t)){T.updateScoreBadges();return}for(const n of t){if(!n||typeof n.term!="string")continue;const r=n.term.trim();if(!r)continue;const s=Number(n.score);Number.isFinite(s)?tt.set(r,s):tt.delete(r);const l=Number(n.submissions);Number.isFinite(l)?et.set(r,l):et.delete(r)}T.updateScoreBadges()}const T=Wt({listElement:ot,filterInput:Bt,scoreCache:tt,makeId:Y});W.subscribe("vocabs",t=>{I=Array.isArray(t)?[...t]:[],T.buildList(I)});b&&!b.dataset.originalText&&(b.dataset.originalText=b.textContent);St([]);A("","info");Ft({quiet:!0});const re=220,dt=.85,ut=.6;let J={},C=null,L=null;function Y(t){return"term-"+t.toLowerCase().replace(/[^a-z0-9]+/g,"-")}function _t(t,e){const n=typeof t=="string"?t.trim():"";if(!n)return;const r=typeof e=="string"&&e.trim()?e.trim():n;K.set(r.toLowerCase(),n),K.set(n.toLowerCase(),n),wt.set(n,r)}function oe(t=[]){if(K.clear(),wt.clear(),!!Array.isArray(t))for(const e of t)!e||typeof e!="object"||_t(e.original,e.used)}function At(t){if(!t)return null;const e=t.trim().toLowerCase();return K.has(e)?K.get(e):I.find(r=>r.toLowerCase()===e)||null}function se(t){if(!t)return null;const e=t.trim();return wt.get(e)||e}function yt(t){const e=se(t)||t,n="t-"+e.toLowerCase().replace(/[^a-z0-9]+/g,"-"),r=document.getElementById(n);if(r){r.scrollIntoView({behavior:"smooth",block:"center"}),Et(r);return}const s=document.querySelectorAll("#article-content strong"),l=e.toLowerCase();for(const a of s){const o=a.textContent.trim().toLowerCase();if(o===l||o.includes(l)){a.scrollIntoView({behavior:"smooth",block:"center"}),Et(a);return}}alert("在文章中未找到该词："+t)}function Et(t){t.style.outline="2px solid var(--accent-2)",t.style.boxShadow="0 0 0 4px rgba(137,220,235,.25)",setTimeout(()=>{t.style.outline="",t.style.boxShadow=""},1500)}function ae(t){if(!t)return[];const e=t.split(/[\n,，、；;]+/),n=new Set,r=[];for(const s of e){const l=s.trim();l&&!n.has(l)&&(n.add(l),r.push(l))}return r}function ie(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function st(t){if(!t)return"";const{content:e,text:n,tool_calls:r}=t,s=o=>o?typeof o=="string"?o:typeof o=="number"||typeof o=="boolean"?String(o):typeof o=="object"?typeof o.text=="string"?o.text:Array.isArray(o.text)?o.text.map(s).join(""):o.type==="text"&&typeof o.value=="string"?o.value:o.type==="text"&&typeof o.data=="string"?o.data:(o.type==="tool_call"&&o.function?.arguments,""):"":"";let l=[];if(typeof e=="string"?l.push(e):Array.isArray(e)?l.push(e.map(s).join("")):e&&typeof e=="object"&&(typeof e.text=="string"?l.push(e.text):Array.isArray(e.text)&&l.push(e.text.map(s).join(""))),typeof n=="string"?l.push(n):Array.isArray(n)&&l.push(n.map(s).join("")),(!l.length||l.join("").trim()==="")&&Array.isArray(r))for(const o of r)o?.function?.result&&typeof o.function.result=="string"&&l.push(o.function.result);return l.join(`
`).trim()}function le(t){const e=ie(t.trim());return e?/\s/.test(t)?new RegExp(e.replace(/\s+/g,"\\s+"),"i"):new RegExp(`\\b${e}\\b`,"i"):null}function at(t,e,{trim:n=!0}={}){if(!t)return;const r=()=>{const s=n?t.value.trim():t.value;s?localStorage.setItem(e,s):localStorage.removeItem(e)};t.addEventListener("change",r),t.addEventListener("blur",r)}function ce(t,e,n=[]){const r=t.replace(/\*\*/g,""),s=new Set,l=/\*\*(.*?)\*\*/g;let a;for(;(a=l.exec(t))!==null;){const i=a[1]?.trim().toLowerCase();i&&s.add(i)}const o=new Map;if(Array.isArray(n))for(const i of n){if(!i||typeof i!="object")continue;const c=typeof i.original=="string"?i.original.trim().toLowerCase():"",u=typeof i.used=="string"?i.used.trim().toLowerCase():"";c&&u&&o.set(c,u),c&&!u&&o.set(c,c)}const d=[];for(const i of e){const c=typeof i=="string"?i.trim().toLowerCase():"";if(!c||s.has(c))continue;const u=o.get(c);if(u&&s.has(u))continue;const m=le(i);m&&(m.test(r)||d.push(i))}return d}function w(t,e="info"){if(!ct)return;const n={info:"var(--muted)",ok:"var(--ok)",warn:"var(--warn)"};ct.textContent=t||"",ct.style.color=n[e]||n.info}at(kt,"ai-api-url");at(Pt,"ai-api-key");at(Gt,"ai-model");at(z,"score-api-url");function D(t,e){y&&(typeof t=="string"&&(y.textContent=t),y.disabled=e)}function de(){y&&(y.disabled=!1,y.textContent=y.dataset.originalText||"📝 开始判题")}function A(t,e="info"){j&&(j.classList.remove("ok","warn"),e==="ok"&&j.classList.add("ok"),e==="warn"&&j.classList.add("warn"),e!=="ok"&&e!=="warn"&&j.classList.remove("ok","warn"),j.textContent=t||"")}function St(t){V&&(Mt(Array.isArray(t)?t:[]),Ot(t,{reset:!1}),V.style.display="none",V.innerHTML="")}function X(){const t=z?.value?.trim();if(t)return t;const e=localStorage.getItem("score-api-url");return e||"http://localhost:4000"}function ue(){const t=[];if(!J)return t;for(const[e,n]of Object.entries(J))if(n&&typeof n.similarity=="number"){const r=N.get(e)||"";t.push({term:e,similarity:n.similarity,context:r||null,standard_answer:n.standardAnswer?String(n.standardAnswer):null,explanation:n.explanation?String(n.explanation):null})}return t}function me(t){if(!t||typeof t!="object")return[];const e=[];for(const[n,r]of Object.entries(t)){if(!n)continue;const s=n.trim();if(!s)continue;const l=r&&typeof r.similarity=="number"?r.similarity:Number(r?.similarity),a=Number.isFinite(l)?l:null,o=r?.standardAnswer??r?.standard_answer??null,d=r?.explanation??null,i=N?.get(s)||null;e.push({term:s,similarity:a,standard_answer:typeof o=="string"&&o.trim()?o:null,explanation:typeof d=="string"&&d.trim()?d:null,context:typeof i=="string"&&i.trim()?i:null})}return e.sort((n,r)=>n.term.localeCompare(r.term,"en",{sensitivity:"base"}))}function ge(t){const e=me(J);if(!e.length)return C=null,null;const n=jt(),r=Kt({article:n,summary:t||{},results:e});return C=r?.id||null,r?{record:r,entries:e,article:n}:null}async function fe(t){if(!t||!t.record||!Array.isArray(t.entries)||!t.entries.length)return;const e=X(),n=e.replace(/\/$/,"")+"/api/sessions",r=t.record.id;try{const l=(await rt(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({results:t.entries,article:t.article||""})}))?.session_id,a=Number(l),o=Lt(r,{sessionId:Number.isInteger(a)&&a>0?a:null,submittedAt:new Date().toISOString()});C===r&&(L=o?.sessionId??(Number.isInteger(a)&&a>0?a:null)),localStorage.setItem("score-api-url",e)}catch(s){console.error("[History] 自动保存判题记录失败:",s),S("自动保存判题记录失败："+s.message,"warn")}}function jt(){return typeof O=="string"&&O.trim()?O.trim():typeof H?.value=="string"?H.value.trim():""}function pe(){const t=Number(te?.value??0),e=Number(ee?.value??0),n=Number(ne?.value??1),r=Number.isFinite(t)?Math.max(0,Math.min(50,Math.round(t))):0,s=Number.isFinite(e)?Math.max(0,Math.min(50,Math.round(e))):0,l=Number.isFinite(n)?n:1;return{practiced:r,total:s,masteryThreshold:l}}async function Ft({quiet:t=!1}={}){try{const n=X().replace(/\/$/,"")+"/api/word-scores",r=await rt(n);Array.isArray(r?.scores)?(Mt(r.scores),Ot(r.scores,{reset:!0}),V&&(V.style.display="none",V.innerHTML=""),t||A(`已获取服务器记录（${r.scores.length} 个词）`,"ok")):t||A("服务器未返回有效数据","warn")}catch(e){t||A(`无法获取服务器分数：${e.message}`,"warn")}}async function ye(){if(!G)return;const{practiced:t,total:e,masteryThreshold:n}=pe();if(!e){w("请设置总词数（至少 1）","warn");return}if(t>e){w("练习过的词数不能超过总词数","warn");return}const r=X(),s=`${r.replace(/\/$/,"")}/api/word-suggestions?practiced=${t}&total=${e}&threshold=${encodeURIComponent(n)}`;G.disabled=!0,G.textContent="获取中…",w("正在向服务器请求推荐词汇…","info");try{const l=await rt(s),a=Array.isArray(l?.practiced)?l.practiced.map(i=>i.term).filter(Boolean):[],o=Array.isArray(l?.fresh)?l.fresh.map(i=>i.term).filter(Boolean):[];if(!a.length&&!o.length){w("未获取到符合条件的词汇，请调整参数。","warn");return}const d=[];a.length&&d.push(a.join(", ")),o.length&&d.push(o.join(", ")),pt.value=d.join(`

`),w(`已填入 ${a.length} 个练习词与 ${o.length} 个新词`,"ok"),localStorage.setItem("score-api-url",r)}catch(l){console.error("[Auto Fill Words] 获取失败:",l),w(`获取推荐词汇失败：${l.message}`,"warn")}finally{G.disabled=!1,G.textContent="🎯 自动取词"}}function xt(){const t=kt?.value?.trim(),e=Pt?.value?.trim(),n=Gt?.value?.trim(),r=localStorage.getItem("ai-api-url"),s=localStorage.getItem("ai-api-key"),l=localStorage.getItem("ai-model"),a=(t||r||"").trim(),o=(e||s||"").trim(),d=(n||l||"gpt-3.5-turbo").trim()||"gpt-3.5-turbo";return t!==void 0&&(t?localStorage.setItem("ai-api-url",t):localStorage.removeItem("ai-api-url")),e!==void 0&&(e?localStorage.setItem("ai-api-key",e):localStorage.removeItem("ai-api-key")),n!==void 0&&(n?localStorage.setItem("ai-model",n):localStorage.removeItem("ai-model")),{apiUrl:a,apiKey:o,model:d}}function he(t){const e=[...t];for(let n=e.length-1;n>0;n--){const r=Math.floor(Math.random()*(n+1));[e[n],e[r]]=[e[r],e[n]]}return e}function we(t){return`请为英语学习者写一篇英文短文，使用 Markdown 段落格式（可自行分段，但不要添加标题、前言或代码块）。严格遵守下列规则：

**A. 标注与频次**

* 仅对目标词加粗，形式为 **word**；除目标词外不得使用粗体。
* 每个目标词至少出现一次；可按语境变化词形，并对变化后的词形加粗。
* **每句最多出现一个目标词**；禁止在同一句用并列（如 “X and Y” 或 “X, Y, and Z”）放入多个目标词。

**B. 语义分散与防“扎堆”**

* **同义、近义、反义、同词根或同一语义场的目标词，彼此之间至少间隔 ≥2 句**；不得出现在相邻句或同一句。
* 若两词常作并列形容或可互换使用，只在不同句中出现，且置于不同话题或功能（如一个作描述，另一个用于行动或结果）。

**C. 连贯性与结构（重点）**

* 先在内部拟定“三段式叙事”但**不输出大纲**：
  1）开端：交代时间、地点、人物与目标；
  2）发展：行动、阻碍与抉择；
  3）结尾：结果或反思，呼应目标。
* 全文保持**同一组人物/地点/目标**贯穿；不要无提示地更换场景或人物。
* **句际逻辑**清晰：每句与上一句构成时间顺序、因果、递进或转折关系。必要时在句首使用 then, later, because, however, therefore, eventually 等连接词（适量使用）。
* 禁止清单式、口号式或与主线无关的跳转；避免模板化重复句式。

**D. 语境暗示，禁止定义式写法**

* 禁止 “**X** is/means/refers to/also called/defined as …” 等定义句；禁止在目标词所在句用括号、破折号、同位语或 “i.e./such as/for example” 给出直白解释或同义替换。
* 不给出中文释义或直译提示词；通过动作、结果、感受、对话或情境**间接**表达含义。

**E. 篇幅与段落**

* 句子数应 ≥ 目标词数量，优先采用“一词一句”。

**F. 输出**

* **仅输出文章正文**，保留 Markdown 段落与粗体标记；不要添加任何额外说明、标题、列表或 JSON。

目标词汇（顺序随机）：

${t.map((n,r)=>`${r+1}. ${n}`).join(`
`)}`}function Ie(t,e){const n=e.map((r,s)=>`${s+1}. ${r}`).join(`
`);return`请阅读下方的英文文章，并根据提供的目标词汇列表，指出文章中每个词汇的实际写法。

输出一个 JSON 对象，格式如下：
{
  "pairs": [
    {"original": "目标词汇", "used": "文章中的实际写法（去掉**，若未出现则留空字符串）"}
  ]
}

要求：
- original 必须与提供的目标词汇完全一致；
- used 为文章中出现的具体形式（保留大小写/单复数等变化，但去掉任何 Markdown ** 标记）；
- 如果某个词未在文章中出现，将 used 设为空字符串。

英文文章：
"""
${t}
"""

目标词汇列表：
${n}`}function mt(t){return typeof t!="string"?"":t.replace(/\*\*/g,"").trim()}function be(t,e){const n=(e||[]).map(i=>({original:i,used:i}));if(!t)return n;let r=t.trim();if(!r)return n;let s=null;const l=r.match(/```(?:json)?([\s\S]*?)```/i);if(l)s=l[1].trim();else{const i=r.match(/\{[\s\S]*\}/);i&&(s=i[0])}let a=[];if(s)try{const i=JSON.parse(s);a=(Array.isArray(i?.pairs)?i.pairs:Array.isArray(i)?i:[]).map(u=>{if(!u||typeof u!="object")return null;const m=typeof u.original=="string"?u.original.trim():"",f=mt(u.used??"");return m?{original:m,used:f||""}:null}).filter(Boolean)}catch(i){console.warn("[Variant Mapping] JSON解析失败，尝试解析纯文本格式",i),a=[]}if(!a.length){const i=r.split(/\n+/).map(c=>c.trim()).filter(Boolean);for(const c of i){const u=c.match(/^(.+?)\s*(?:=>|->|：|:|=)\s*(.+)$/);if(!u)continue;const m=u[1].trim(),f=mt(u[2]);m&&a.push({original:m,used:f})}}const o=new Map;for(const i of a){const c=typeof i.original=="string"?i.original.trim():"";if(!c)continue;const u=c.toLowerCase(),m=mt(i.used||c);o.has(u)||o.set(u,{original:c,used:m||c})}const d=[];for(const i of e||[]){const c=i.trim().toLowerCase(),u=o.get(c),m=u?u.used:i;d.push({original:i,used:m})}return d}async function Ae(t,e,n,r,s){const l=Ie(r,s),a={model:n,messages:[{role:"system",content:"You are an assistant that extracts vocabulary mappings and responds with concise JSON."},{role:"user",content:l}],temperature:0,max_tokens:3e3};console.log("[Variant Mapping] 请求体:",JSON.stringify(a,null,2));const o=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(a)});if(console.log("[Variant Mapping] 响应状态:",o.status,o.statusText),!o.ok){const u=await o.text();throw console.error("[Variant Mapping] API错误响应:",u),new Error(`词形映射请求失败: ${o.status} ${o.statusText}: ${u}`)}const d=await o.json();console.log("[Variant Mapping] API响应:",d);const i=d?.choices?.[0]?.message;if(!i)throw new Error("词形映射响应格式异常");const c=st(i);return console.log("[Variant Mapping] AI回复:",c),be(c,s)}async function Se(){if(!v)return;const t=ae(pt?.value||"");if(!t.length){w("请至少输入一个目标词汇","warn"),pt?.focus();return}const{apiUrl:e,apiKey:n,model:r}=xt();if(!e||!n){w("请先在右侧配置AI API地址与Key","warn");return}const s=v.dataset.originalText||v.textContent;try{v.disabled=!0,v.dataset.originalText=s,v.textContent="生成中…",w("正在请求AI生成文章…","info");const l=he(t),a=we(l),o={model:r,messages:[{role:"system",content:"You are an expert science writer who produces fluent, engaging English articles in Markdown without extra commentary."},{role:"user",content:a}],temperature:.65,top_p:.9,max_tokens:Math.min(1200,Math.round(re*4.2))};console.log("[Article Generator] 请求体:",JSON.stringify(o,null,2));const d=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(o)});if(!d.ok){const M=await d.text();throw new Error(`API请求失败: ${d.status} ${d.statusText} | ${M}`)}const i=await d.json();console.log("[Article Generator] API响应:",i);const c=i?.choices?.[0]?.message;if(!c)throw new Error("AI未返回文章内容");const u=st(c);if(!u)throw new Error("AI未返回文章内容");H.value=u.trim();let m,f=!1;try{if(w("文章生成成功，正在分析词形映射…","info"),m=await Ae(e,n,r,u,t),!Array.isArray(m)||!m.length)throw new Error("未获得有效的词形映射")}catch(M){console.error("[Article Generator] 词形映射失败:",M),m=t.map(p=>({original:p,used:p})),w("文章生成完成，但词形映射失败，已使用原始词汇。","warn"),S("词形映射失败，已使用原始词汇","warn"),f=!0}console.log("[Article Generator] 最终词形映射:",m),vt(u,m),it();const R=ce(u,t,m);if(R.length){const M=`⚠️ 已生成文章，但缺少 ${R.length} 个词：${R.join("，")}`;w(M,"warn"),S("生成完成，但存在缺失词汇，请手动补充。","warn")}else f||(w("AI文章生成完成，词汇与词形均已覆盖 ✓","ok"),S("文章生成成功并包含全部目标词汇！","ok"));await Ft({quiet:!0})}catch(l){console.error("[Article Generator] 生成文章失败:",l),w(`生成失败：${l.message}`,"warn")}finally{v.disabled=!1,v.textContent=v.dataset.originalText||"✨ AI生成文章"}}function vt(t,e=[]){try{O=typeof t=="string"?t:"",Zt(O),oe(e);const n=xe(t);ft.innerHTML=n,ve(t),Ee(),T.buildList(I),F.textContent="文章保存成功！",F.style.color="var(--ok)"}catch(n){F.textContent="处理文章内容时出错: "+n.message,F.style.color="var(--warn)"}}function xe(t){return t.split(`

`).map(r=>`<p>${r.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function ve(t){const e=/\*\*(.*?)\*\*/g,n=[],r=new Set;let s;for(;(s=e.exec(t))!==null;){const l=s[1]?.trim();if(!l)continue;const a=At(l)||l;_t(a,l),r.has(a)||(r.add(a),n.push(a))}Tt(n)}function Ee(){if(N.clear(),!ft)return;ft.querySelectorAll("p").forEach(e=>{const n=e.textContent?e.textContent.replace(/\s+/g," ").trim():"";if(!n)return;e.querySelectorAll("strong").forEach(s=>{const l=s.textContent?s.textContent.trim():"";if(!l)return;const a=At(l)||l;if(!a||N.has(a))return;const o=$e(n,l)||n;N.set(a,o)})})}function $e(t,e){if(!t||!e)return"";const n=t.replace(/\s+/g," ").trim(),r=e.trim().toLowerCase(),s=n.match(/[^。！？!?.]+[。！？!?.]?/g)||[n];for(const l of s)if(l.toLowerCase().includes(r))return l.trim();return n}function Ce(){It.classList.add("active"),bt.classList.remove("active"),Nt.style.display="block",Rt.style.display="none"}function it(){It.classList.remove("active"),bt.classList.add("active"),Nt.style.display="none",Rt.style.display="block"}It.addEventListener("click",Ce);bt.addEventListener("click",it);Qt.addEventListener("click",()=>{const t=H.value;t.trim()?(vt(t),it()):(F.textContent="请输入文章内容",F.style.color="var(--warn)")});v&&v.addEventListener("click",Se);G&&G.addEventListener("click",t=>{t.preventDefault(),ye()});b&&b.addEventListener("click",async()=>{const t=ue();if(!t.length){A("请先完成AI判题后再同步。","warn"),S("没有可同步的判题分数","warn");return}const e=X(),n=e.replace(/\/$/,"")+"/api/word-scores",r=jt(),s={results:t,article:r};Number.isInteger(L)&&L>0&&(s.session_id=L);const l=b.dataset.originalText||b.textContent;b.dataset.originalText=l,b.disabled=!0,b.textContent="同步中…",A("正在同步判题结果到服务器…","info");try{const a=await rt(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),o=Array.isArray(a?.scores)?a.scores:[];St(o);const d=a?.updated??t.length,i=a?.session_id,c=i?`（历史记录 #${i} 已生成）`:"";A(`同步成功，已更新 ${d} 个词汇${c}`,"ok"),S(i?`同步完成！历史记录 #${i}`:"服务器词表已更新 ✓","ok"),localStorage.setItem("score-api-url",e),Number.isInteger(Number(i))&&Number(i)>0&&(L=Number(i)),C&&(Lt(C,{sessionId:i,submittedAt:new Date().toISOString()}),zt(C,{sessionId:i}),C=null)}catch(a){console.error("[Sync Scores] 同步失败:",a),A(`同步失败：${a.message}`,"warn"),S("同步失败："+a.message,"warn")}finally{b.disabled=!1,b.textContent=b.dataset.originalText||"⬆️ 同步到服务器"}});function Le(t){const e=document.getElementById(Y(t));if(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus();const n=e.closest(".item");n&&(n.style.outline="2px solid var(--accent-2)",n.style.boxShadow="0 0 0 4px rgba(137,220,235,.25)",setTimeout(()=>{n.style.outline="",n.style.boxShadow=""},1500))}}Tt(I);ot.addEventListener("click",t=>{const e=t.target;if(e.classList.contains("jump"))yt(e.dataset.term);else if(e.classList.contains("term")||e.parentElement.classList.contains("term")){const n=e.dataset.term||e.parentElement.dataset.term;n&&yt(n)}});Bt.addEventListener("input",()=>T.buildList(I));ot.addEventListener("focus",t=>{t.target.tagName==="INPUT"&&t.target.dataset.term&&yt(t.target.dataset.term)},!0);document.getElementById("article-content").addEventListener("click",t=>{if(t.target.tagName==="STRONG"){const e=t.target.textContent.trim(),n=At(e);n&&I.includes(n)&&Le(n)}});const Vt="geo_vocab_answers_v1";function Ht(){const t={};for(const e of I){const n=document.getElementById(Y(e));t[e]=n&&n.value||""}return t}function Te(t){if(t){for(const e of I){const n=document.getElementById(Y(e));n&&e in t&&(n.value=t[e]||"")}T.updateFilledState(I)}}function Jt(){try{const t=Ht();localStorage.setItem(Vt,JSON.stringify(t)),T.updateFilledState(I)}catch(t){console.warn("[Persist Answers] 保存失败:",t)}}let Q=null;function Me(){Q&&clearTimeout(Q),Q=setTimeout(()=>{Q=null,Jt()},300)}try{const t=JSON.parse(localStorage.getItem(Vt)||"null");Te(t)}catch(t){console.warn("[Persist Answers] 恢复缓存失败:",t)}ot.addEventListener("input",t=>{const e=t.target;e instanceof HTMLInputElement&&e.dataset.term&&(Me(),T.updateFilledState(I))});document.getElementById("clear").addEventListener("click",()=>{for(const t of I){const e=document.getElementById(Y(t));e&&(e.value="")}Jt(),T.updateFilledState(I),S("已清空输入","warn")});function S(t,e){const n=document.createElement("div");n.textContent=t,n.style.position="fixed",n.style.right="18px",n.style.bottom="18px",n.style.background="rgba(10,15,30,.95)",n.style.border="1px solid rgba(122,162,247,.3)",n.style.color=e==="ok"?"var(--ok)":e==="warn"?"var(--warn)":"var(--text)",n.style.padding="10px 12px",n.style.borderRadius="10px",n.style.boxShadow="0 6px 18px var(--shadow)",document.body.appendChild(n),setTimeout(()=>n.remove(),2200)}let q=!1;const _=document.getElementById("ai-config"),nt=document.getElementById("ai-results"),gt=document.getElementById("ai-progress"),Be=document.getElementById("progress-fill"),$t=document.getElementById("progress-text"),ht=document.getElementById("score-summary"),U=document.getElementById("ai-identity-check");document.getElementById("ai-grade").addEventListener("click",async()=>{if(_.style.display==="none"){_.style.display="block",w("");const t=localStorage.getItem("ai-api-url"),e=localStorage.getItem("ai-api-key"),n=localStorage.getItem("ai-model")||"gpt-3.5-turbo";t&&(document.getElementById("api-url").value=t),e&&(document.getElementById("api-key").value=e),document.getElementById("ai-model").value=n;const r=localStorage.getItem("score-api-url");z&&(z.value=r||z.value||"http://localhost:4000"),St([]),A("同步后将显示本次提交的词汇成绩","info")}else _.style.display="none"});U.addEventListener("click",async()=>{const{apiUrl:t,apiKey:e,model:n}=xt();if(!t||!e){alert(`请先配置API地址和Key！

点击"🤖 AI工具箱"按钮进行配置。`);return}U.textContent="🔍 检测中...",U.disabled=!0;try{const r=await Oe(t,e,n);alert(`AI身份信息：

${r}`)}catch(r){alert(`AI身份检测失败：

${r.message}`)}finally{U.textContent="🔍 检测AI身份",U.disabled=!1}});document.getElementById("cancel-grade").addEventListener("click",()=>{_.style.display="none",q=!1});y&&y.addEventListener("click",async()=>{const{apiUrl:t,apiKey:e,model:n}=xt();if(!t||!e){_.style.display="block",S("请填写API地址和Key","warn");return}const r=y.dataset.originalText||y.textContent;y.dataset.originalText=r,D("判题准备中…",!0);try{await Ne(t,e,n)}finally{setTimeout(de,600)}});async function Ne(t,e,n="gpt-3.5-turbo"){if(console.log("[Main Grading] 开始AI判题流程"),console.log("[Main Grading] API URL:",t),console.log("[Main Grading] 模型:",n),console.log("[Main Grading] API Key 长度:",e?e.length:0),q){console.warn("[Main Grading] 判题已在进行中，跳过");return}q=!0,gt.style.display="block",nt.style.display="none",Dt();try{const r=Ht();console.log("[Main Grading] 收集的数据:",r);const s=I.filter(i=>r[i]&&r[i].trim());if(console.log("[Main Grading] 已填写的词汇:",s),console.log("[Main Grading] 已填写词汇数量:",s.length),s.length===0){console.warn("[Main Grading] 没有填写的词汇"),S("请先填写一些答案","warn"),q=!1,gt.style.display="none";return}$t.textContent=`开始判题... (共${s.length}个词)`,y&&D(`判题中 0/${s.length}`,!0);const l=50,a=[];for(let i=0;i<s.length;i+=l)a.push(s.slice(i,i+l));console.log("[Main Grading] 分批处理:",a.length,"个批次");let o=0;const d={};for(let i=0;i<a.length;i++){const c=a[i];console.log(`[Main Grading] 处理第${i+1}批:`,c),$t.textContent=`正在处理第${i+1}/${a.length}批 (${c.length}个词)...`;try{const u=await Re(c,r,t,e,n);console.log(`[Main Grading] 第${i+1}批结果:`,u),Object.assign(d,u),o+=c.length;const m=o/s.length*100;if(Be.style.width=m+"%",console.log(`[Main Grading] 进度: ${m}% (${o}/${s.length})`),y){const f=Math.round(m);D(`判题中 ${o}/${s.length} (${f}%)`,!0)}i<a.length-1&&(console.log("[Main Grading] 等待1秒避免频率限制"),await new Promise(f=>setTimeout(f,1e3)))}catch(u){console.error(`[Main Grading] 第${i+1}批处理失败:`,u),S(`第${i+1}批处理失败: ${u.message}`,"warn")}}console.log("[Main Grading] 所有批次处理完成，最终结果:",d),Ut(d,s.length),y&&D("判题完成 ✓",!0)}catch(r){console.error("[Main Grading] 判题过程错误:",r),S("判题过程中出现错误: "+r.message,"warn"),y&&D("判题失败",!0)}finally{q=!1,gt.style.display="none",console.log("[Main Grading] 判题流程结束")}}async function Re(t,e,n,r,s="gpt-3.5-turbo"){console.log("[Batch Grading] 开始处理批次:",t),console.log("[Batch Grading] 使用模型:",s);const l=Pe(t,e);console.log("[Batch Grading] 生成的提示词:",l);const a={model:s,messages:[{role:"user",content:l}],temperature:.1};console.log("[Batch Grading] 请求体:",JSON.stringify(a,null,2));const o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(a)});if(console.log("[Batch Grading] 响应状态:",o.status,o.statusText),!o.ok){const m=await o.text();throw console.error("[Batch Grading] API错误响应:",m),new Error(`API请求失败: ${o.status} ${o.statusText}: ${m}`)}const d=await o.json();console.log("[Batch Grading] API响应:",d);const i=d?.choices?.[0]?.message;if(!i)throw console.error("[Batch Grading] 响应格式异常:",d),new Error("API响应格式异常");const c=st(i);console.log("[Batch Grading] AI回复内容:",c);const u=Ge(c,t);return console.log("[Batch Grading] 解析结果:",u),u}function ke(t){const e=typeof t=="number"?t:parseFloat(t);if(!Number.isFinite(e))return null;const n=Math.min(Math.max(e,0),1);return Math.round(n*1e3)/1e3}function Pe(t,e){return`你是一名精通中英文术语的教师，需要判断学生给出的中文翻译与英文术语的语义相似度。请聚焦词义本身，不要贴合特定学科背景或冷僻知识。

请对每个词汇：
1. 给出最标准、最常用的中文翻译（可包含多个词，确保含义准确）。
2. 评估学生答案与标准答案在语义上的相似度，相似度用 0~1 的小数表示：0 代表完全错误，1 代表完全一致。允许保留三位小数。
   - 若学生答案涵盖了主要含义或提供了常见近义词，即使未列出全部释义，也应给予较高分（例如 ≥0.7）。
3. 如有需要，可给出简短说明（10~25个字），解释主要差异或匹配亮点。

在评估时请结合提供的原文语境理解术语的含义，以该语境为准判断学生翻译的准确度。

评分基准示例：
- 学生答案「极点」，标准答案「杆；极点；电极」→ 1.0 分（核心含义完全对应）
- 学生答案「烟」，标准答案「烟雾」→ 0.7 分（传达主要概念，细节略缺）
- 学生答案「平坦的」，标准答案「平原」→ 0.5 分（相关但偏向形容词，需要指出语义差异）

务必只输出 JSON，不要解释。JSON 格式如下：
{
  "英文词汇": {
    "标准答案": "标准中文翻译",
    "相似度": 0.000,
    "说明": "可选，若无则留空字符串"
  }
}

待评估的词汇与学生答案：
${t.map(r=>{const l=(N.get(r)||"（原文未提供语境）").replace(/\s+/g," ").trim(),a=e[r]&&e[r].trim()?e[r].trim():"(空白)";return`- 英文词汇: ${r}
  原文语境: ${l}
  学生翻译: ${a}`}).join(`
`)}`}function Ge(t,e){console.log("[Parse Response] 开始解析AI回复:",t),console.log("[Parse Response] 需要解析的词汇:",e);try{const n=t.match(/\{[\s\S]*\}/);if(console.log("[Parse Response] JSON匹配结果:",n?n[0]:"null"),!n)throw console.warn("[Parse Response] 未找到JSON格式，使用fallback解析"),new Error("无法解析AI回复格式");const r=JSON.parse(n[0]);console.log("[Parse Response] JSON解析成功:",r);const s={};return e.forEach(l=>{console.log(`[Parse Response] 处理词汇: ${l}`);const a=r[l]||r[l.trim()]||null;if(a&&typeof a=="object"){const o=a.相似度??a.similarity??a.score,d=ke(typeof o=="string"?parseFloat(o):o),i=(a.标准答案??a.正确答案??"").toString().trim(),c=(a.说明??a.解释??"").toString().trim();s[l]={similarity:typeof d=="number"?d:null,standardAnswer:i||null,explanation:c||null},console.log(`[Parse Response] ${l} 解析成功 - 相似度:`,s[l].similarity,"标准答案:",s[l].standardAnswer,"说明:",s[l].explanation)}else if(typeof a=="string"){const o=a==="正确";s[l]={similarity:o?1:0,standardAnswer:null,explanation:null},console.log(`[Parse Response] ${l} 使用旧格式字符串 - 相似度模拟:`,s[l].similarity)}else console.log(`[Parse Response] ${l} 未在解析结果中找到，使用fallback`),s[l]={similarity:null,standardAnswer:null,explanation:null}}),console.log("[Parse Response] 最终解析结果:",s),s}catch(n){console.error("[Parse Response] JSON解析失败:",n),console.log("[Parse Response] 使用fallback解析方法");const r={};return e.forEach(s=>{const l=s.toLowerCase(),a=t.toLowerCase();r[s]={similarity:a.includes(l)?.5:null,standardAnswer:null,explanation:null},console.log(`[Parse Response] ${s} fallback结果 - 相似度: ${r[s].similarity}`)}),console.log("[Parse Response] Fallback最终结果:",r),r}}function Ut(t,e,n={}){const{suppressToast:r=!1,skipHistoryRecord:s=!1,sessionId:l=null}=n||{};J=t||{},Xt(J);const a=()=>({total:0,strict:0,partial:0,other:0,similaritySum:0,similarityCount:0}),o={overall:a(),new:a(),review:a()},d=(p,g)=>{const h=o[p];h.total+=1,typeof g=="number"&&(h.similaritySum+=g,h.similarityCount+=1),g===null||g<ut?h.other+=1:g>=dt?h.strict+=1:h.partial+=1};Object.entries(t).forEach(([p,g])=>{const h=document.querySelector(`[data-term="${p}"]`)?.closest(".item");if(!h)return;h.classList.remove("correct","incorrect","partial");const $=typeof g.similarity=="number"?g.similarity:null,qt=(et.get(p)||0)>0?"review":"new";d("overall",$),d(qt,$);let Z="incorrect";$!==null&&($>=dt?Z="correct":$>=ut&&(Z="partial")),h.classList.add(Z);const lt=h.querySelector(".term");if(!lt)return;let k=lt.querySelector(".grade-indicator");k||(k=document.createElement("span"),k.className="grade-indicator",lt.appendChild(k)),k.className=`grade-indicator ${Z}`,k.textContent=$!==null?$.toFixed(2):"—",k.title="语义相似度 (0-1)";let E=h.querySelector(".grading-details");if(E||(E=document.createElement("div"),E.className="grading-details",h.appendChild(E)),E.innerHTML="",$!==null){const x=document.createElement("div"),B=document.createElement("strong");B.textContent="相似度:",x.appendChild(B),x.appendChild(document.createTextNode(" "+$.toFixed(2))),E.appendChild(x)}if(g.standardAnswer){const x=document.createElement("div"),B=document.createElement("strong");B.textContent="标准答案:",x.appendChild(B),x.appendChild(document.createTextNode(" "+g.standardAnswer)),E.appendChild(x)}if(g.explanation){const x=document.createElement("div"),B=document.createElement("strong");B.textContent="说明:",x.appendChild(B),x.appendChild(document.createTextNode(" "+g.explanation)),E.appendChild(x)}E.hasChildNodes()||E.remove()});const i=dt.toFixed(2),c=ut.toFixed(2),u=o.overall.similarityCount?o.overall.similaritySum/o.overall.similarityCount:null,m=u??0,f=Number.isFinite(Number(e))?Number(e):o.overall.total,R={total:f||o.overall.total,correct:o.overall.strict,partial:o.overall.partial,incorrect:o.overall.other+Math.max(0,(f||0)-o.overall.total),avg:u},M=(p,g)=>{if(!g.total)return`${p}：0 个`;const h=g.similarityCount?(g.similaritySum/g.similarityCount).toFixed(2):"—";return`${p}：${g.total} 个（平均 ${h} | 高匹配 ${g.strict} | 中匹配 ${g.partial}）`};if(ht.innerHTML=`
    <div>判题完成！</div>
    <div class="score-line">
      <span>平均相似度：<strong>${m.toFixed(2)}</strong></span>
      <span>高匹配(≥${i}): <strong>${o.overall.strict}</strong></span>
      <span>中等匹配(≥${c}): <strong>${o.overall.partial}</strong></span>
      <span>总词数: <strong>${e}</strong></span>
    </div>
    <div class="score-line">${M("新词",o.new)}</div>
    <div class="score-line">${M("复习词",o.review)}</div>
  `,nt.style.display="block",_.style.display="none",s){C=null;const p=Number(l);L=Number.isInteger(p)&&p>0?p:null}else{L=null;const p=ge(R);p&&fe(p)}r||S(`判题完成！平均相似度 ${m.toFixed(2)}`,"ok")}function Dt(){J={},C=null,L=null,document.querySelectorAll(".item").forEach(t=>{t.classList.remove("correct","incorrect","partial");const e=t.querySelector(".grade-indicator");e&&e.remove();const n=t.querySelector(".grading-details");n&&n.remove()})}async function Oe(t,e,n="gpt-3.5-turbo"){console.log("[AI Identity] 开始检测AI身份"),console.log("[AI Identity] API URL:",t),console.log("[AI Identity] 模型:",n),console.log("[AI Identity] API Key 长度:",e?e.length:0);const r={model:n,messages:[{role:"user",content:"你好，请详细介绍一下你自己，包括你的名称、版本、主要功能和特色。"}],temperature:.1,max_tokens:200};console.log("[AI Identity] 请求体:",JSON.stringify(r,null,2));const s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(r)});if(console.log("[AI Identity] 响应状态:",s.status,s.statusText),!s.ok){const d=await s.text();throw console.error("[AI Identity] API错误响应:",d),new Error(`${s.status} ${s.statusText}: ${d}`)}const l=await s.json();console.log("[AI Identity] API响应:",l);const a=l?.choices?.[0]?.message;if(!a)throw console.error("[AI Identity] 响应格式异常:",l),new Error("API响应格式异常");const o=st(a);if(!o)throw console.error("[AI Identity] 未获得文本回复:",a),new Error("AI未返回文本信息");return console.log("[AI Identity] AI回复:",o),o}async function _e(t){const e=Number(t);if(!Number.isInteger(e)||e<=0){A(`无法识别的历史记录编号：${t}`,"warn");return}const n=X();if(!n){A("请先配置服务器地址再加载历史记录。","warn");return}const r=`${n.replace(/\/$/,"")}/api/sessions/${e}`;A(`正在加载历史记录 #${e}…`,"info");try{const s=await fetch(r,{headers:{Accept:"application/json"}});if(!s.ok){const c=await s.text();throw new Error(`HTTP ${s.status} ${s.statusText}: ${c}`)}const l=await s.json(),a=l?.session||{},o=Array.isArray(l?.results)?l.results:[],d=typeof a.article=="string"?a.article:"";L=Number.isInteger(Number(a.id))&&Number(a.id)>0?Number(a.id):null,typeof O<"u"&&(O=d),H&&(H.value=d),vt(d||"",[]),it();const i={};if(o.forEach(c=>{if(!c||typeof c.term!="string")return;const u=c.term.trim();if(!u)return;const m=typeof c.similarity=="number"?c.similarity:Number(c.similarity),f=c.standard_answer||c.standardAnswer||null,R=c.explanation||null;i[u]={similarity:Number.isFinite(m)?m:null,standardAnswer:f,explanation:R},c.context&&N&&N.set(u,c.context)}),Object.keys(i).length?Ut(i,a.total_terms||o.length,{suppressToast:!0,skipHistoryRecord:!0,sessionId:a.id}):(Dt(),nt.style.display="none"),ht){const c=a.submitted_at?new Date(a.submitted_at):null,u=typeof a.avg_similarity=="number"?a.avg_similarity:Number(a.avg_similarity),m=[];c&&!Number.isNaN(c.getTime())&&m.push(`提交时间：${c.toLocaleString()}`),m.push(`总词数：${a.total_terms??o.length}`),Number.isFinite(u)&&m.push(`平均相似度：${u.toFixed(2)}`),m.push(`正确 / 部分正确 / 错误：${a.correct_terms??0} / ${a.partial_terms??0} / ${a.incorrect_terms??0}`),ht.insertAdjacentHTML("beforeend",`<div class="score-line history-note">${m.join(" ｜ ")}</div>`)}nt.style.display="block",_.style.display="none",A(`已加载历史记录 #${e}，如需重新练习可直接编辑文章。`,"ok"),document.body.classList.add("replay-mode")}catch(s){console.error("[History Replay] 加载历史记录失败:",s),A(`加载历史记录失败：${s.message}`,"warn"),S("加载历史记录失败："+s.message,"warn")}}const Ct=new URLSearchParams(window.location.search).get("session");Ct&&_e(Ct);
