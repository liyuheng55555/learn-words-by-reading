import{e as v,f as lt}from"./chunks/http.js";function Bt({listElement:t,filterInput:e,scoreCache:n,makeId:s}){function r(a){if(Array.isArray(a))for(const u of a){const i=document.getElementById(s(u));if(!i)continue;const l=i.closest(".item");if(!l)continue;const d=i.value&&i.value.trim().length>0;l.classList.toggle("filled",d)}}function o(){if(!t)return;t.querySelectorAll(".score-badge").forEach(u=>{const i=u.dataset.termScore,l=i&&n?.has(i)?n.get(i):null;typeof l=="number"?(u.textContent=l.toFixed(2),u.classList.add("score-known")):(u.textContent="—",u.classList.remove("score-known"))})}function c(a){if(!t||!Array.isArray(a))return;const u=e?.value?.trim().toLowerCase(),i=[];for(const l of a){if(u&&!l.toLowerCase().includes(u))continue;const d=s(l),g=n?.has(l)?n.get(l):null,m=typeof g=="number"?g.toFixed(2):"—";i.push(`
        <div class="item">
          <div class="term" data-term="${v(l)}">
            <span>${v(l)}</span>
            <span class="score-badge" data-term-score="${v(l)}">${m}</span>
            <span class="jump" data-term="${v(l)}">跳到文中</span>
          </div>
          <input aria-label="${v(l)} 中文意思" placeholder="中文意思…" id="${v(d)}" data-term="${v(l)}" />
        </div>
      `)}t.innerHTML=i.join(""),r(a),o()}return{buildList:c,updateFilledState:r,updateScoreBadges:o}}let w=[];const _=new Map,ct=new Map,M=new Map;let R="";const D=document.getElementById("list"),wt=document.getElementById("filter"),dt=document.getElementById("edit-mode-btn"),ut=document.getElementById("view-mode-btn"),It=document.getElementById("edit-section"),xt=document.getElementById("view-section"),P=document.getElementById("article-editor"),kt=document.getElementById("save-article-btn"),N=document.getElementById("editor-status"),ot=document.getElementById("article-content"),rt=document.getElementById("generator-words"),A=document.getElementById("generate-article-btn"),Z=document.getElementById("generator-status"),f=document.getElementById("start-grade"),y=document.getElementById("sync-server"),k=document.getElementById("sync-status"),Q=document.getElementById("server-scores"),F=document.getElementById("score-api-url"),At=document.getElementById("api-url"),bt=document.getElementById("api-key"),Et=document.getElementById("ai-model"),Nt=document.getElementById("practiced-count"),Rt=document.getElementById("total-count"),Pt=document.getElementById("mastery-threshold"),C=document.getElementById("auto-fill-words"),st=new Map,L=Bt({listElement:D,filterInput:wt,scoreCache:st,makeId:V});y&&!y.dataset.originalText&&(y.dataset.originalText=y.textContent);W([]);h("","info");vt({quiet:!0});const Gt=220,J=.85,tt=.6;let U={};function V(t){return"term-"+t.toLowerCase().replace(/[^a-z0-9]+/g,"-")}function St(t,e){const n=typeof t=="string"?t.trim():"";if(!n)return;const s=typeof e=="string"&&e.trim()?e.trim():n;_.set(s.toLowerCase(),n),_.set(n.toLowerCase(),n),ct.set(n,s)}function jt(t=[]){if(_.clear(),ct.clear(),!!Array.isArray(t))for(const e of t)!e||typeof e!="object"||St(e.original,e.used)}function gt(t){if(!t)return null;const e=t.trim().toLowerCase();return _.has(e)?_.get(e):w.find(s=>s.toLowerCase()===e)||null}function Ot(t){if(!t)return null;const e=t.trim();return ct.get(e)||e}function at(t){const e=Ot(t)||t,n="t-"+e.toLowerCase().replace(/[^a-z0-9]+/g,"-"),s=document.getElementById(n);if(s){s.scrollIntoView({behavior:"smooth",block:"center"}),pt(s);return}const r=document.querySelectorAll("#article-content strong"),o=e.toLowerCase();for(const c of r){const a=c.textContent.trim().toLowerCase();if(a===o||a.includes(o)){c.scrollIntoView({behavior:"smooth",block:"center"}),pt(c);return}}alert("在文章中未找到该词："+t)}function pt(t){t.style.outline="2px solid var(--accent-2)",t.style.boxShadow="0 0 0 4px rgba(137,220,235,.25)",setTimeout(()=>{t.style.outline="",t.style.boxShadow=""},1500)}function Ft(t){if(!t)return[];const e=t.split(/[\n,，、；;]+/),n=new Set,s=[];for(const r of e){const o=r.trim();o&&!n.has(o)&&(n.add(o),s.push(o))}return s}function _t(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function K(t){if(!t)return"";const{content:e,text:n,tool_calls:s}=t,r=a=>a?typeof a=="string"?a:typeof a=="number"||typeof a=="boolean"?String(a):typeof a=="object"?typeof a.text=="string"?a.text:Array.isArray(a.text)?a.text.map(r).join(""):a.type==="text"&&typeof a.value=="string"?a.value:a.type==="text"&&typeof a.data=="string"?a.data:(a.type==="tool_call"&&a.function?.arguments,""):"":"";let o=[];if(typeof e=="string"?o.push(e):Array.isArray(e)?o.push(e.map(r).join("")):e&&typeof e=="object"&&(typeof e.text=="string"?o.push(e.text):Array.isArray(e.text)&&o.push(e.text.map(r).join(""))),typeof n=="string"?o.push(n):Array.isArray(n)&&o.push(n.map(r).join("")),(!o.length||o.join("").trim()==="")&&Array.isArray(s))for(const a of s)a?.function?.result&&typeof a.function.result=="string"&&o.push(a.function.result);return o.join(`
`).trim()}function Vt(t){const e=_t(t.trim());return e?/\s/.test(t)?new RegExp(e.replace(/\s+/g,"\\s+"),"i"):new RegExp(`\\b${e}\\b`,"i"):null}function z(t,e,{trim:n=!0}={}){if(!t)return;const s=()=>{const r=n?t.value.trim():t.value;r?localStorage.setItem(e,r):localStorage.removeItem(e)};t.addEventListener("change",s),t.addEventListener("blur",s)}function Jt(t,e,n=[]){const s=t.replace(/\*\*/g,""),r=new Set,o=/\*\*(.*?)\*\*/g;let c;for(;(c=o.exec(t))!==null;){const i=c[1]?.trim().toLowerCase();i&&r.add(i)}const a=new Map;if(Array.isArray(n))for(const i of n){if(!i||typeof i!="object")continue;const l=typeof i.original=="string"?i.original.trim().toLowerCase():"",d=typeof i.used=="string"?i.used.trim().toLowerCase():"";l&&d&&a.set(l,d),l&&!d&&a.set(l,l)}const u=[];for(const i of e){const l=typeof i=="string"?i.trim().toLowerCase():"";if(!l||r.has(l))continue;const d=a.get(l);if(d&&r.has(d))continue;const g=Vt(i);g&&(g.test(s)||u.push(i))}return u}function p(t,e="info"){if(!Z)return;const n={info:"var(--muted)",ok:"var(--ok)",warn:"var(--warn)"};Z.textContent=t||"",Z.style.color=n[e]||n.info}z(At,"ai-api-url");z(bt,"ai-api-key");z(Et,"ai-model");z(F,"score-api-url");function j(t,e){f&&(typeof t=="string"&&(f.textContent=t),f.disabled=e)}function Ht(){f&&(f.disabled=!1,f.textContent=f.dataset.originalText||"📝 开始判题")}function h(t,e="info"){k&&(k.classList.remove("ok","warn"),e==="ok"&&k.classList.add("ok"),e==="warn"&&k.classList.add("warn"),e!=="ok"&&e!=="warn"&&k.classList.remove("ok","warn"),k.textContent=t||"")}function W(t){if(!Q)return;if(st.clear(),!t||!t.length){Q.innerHTML='<div class="empty">服务器暂无词汇记录。</div>',L.updateScoreBadges();return}const e=t.map(({term:n,score:s,submissions:r,last_submission:o})=>{const c=v(n),a=Number(s),u=Number.isFinite(a)?a.toFixed(2):"0.00",i=Number.isFinite(Number(r))?Number(r):0;typeof n=="string"&&st.set(n.trim(),Number.isFinite(a)?a:null);let l="-";if(o){const d=new Date(o);l=Number.isNaN(d.getTime())?v(o):d.toLocaleString()}return`<tr><td>${c}</td><td>${u}</td><td>${i}</td><td>${v(l)}</td></tr>`}).join("");Q.innerHTML=`
    <h5>服务器词表得分</h5>
    <table>
      <thead><tr><th>词汇</th><th>累计分数</th><th>提交次数</th><th>最后提交时间</th></tr></thead>
      <tbody>${e}</tbody>
    </table>
  `,L.updateScoreBadges()}function Y(){const t=F?.value?.trim();if(t)return t;const e=localStorage.getItem("score-api-url");return e||"http://localhost:4000"}function Ut(){const t=[];if(!U)return t;for(const[e,n]of Object.entries(U))if(n&&typeof n.similarity=="number"){const s=M.get(e)||"";t.push({term:e,similarity:n.similarity,context:s||null,standard_answer:n.standardAnswer?String(n.standardAnswer):null,explanation:n.explanation?String(n.explanation):null})}return t}function qt(){return typeof R=="string"&&R.trim()?R.trim():typeof P?.value=="string"?P.value.trim():""}function Dt(){const t=Number(Nt?.value??0),e=Number(Rt?.value??0),n=Number(Pt?.value??1),s=Number.isFinite(t)?Math.max(0,Math.min(50,Math.round(t))):0,r=Number.isFinite(e)?Math.max(0,Math.min(50,Math.round(e))):0,o=Number.isFinite(n)?n:1;return{practiced:s,total:r,masteryThreshold:o}}async function vt({quiet:t=!1}={}){try{const n=Y().replace(/\/$/,"")+"/api/word-scores",s=await lt(n);Array.isArray(s?.scores)?(W(s.scores),t||h(`已获取服务器记录（${s.scores.length} 个词）`,"ok")):t||h("服务器未返回有效数据","warn")}catch(e){t||h(`无法获取服务器分数：${e.message}`,"warn")}}async function Kt(){if(!C)return;const{practiced:t,total:e,masteryThreshold:n}=Dt();if(!e){p("请设置总词数（至少 1）","warn");return}if(t>e){p("练习过的词数不能超过总词数","warn");return}const s=Y(),r=`${s.replace(/\/$/,"")}/api/word-suggestions?practiced=${t}&total=${e}&threshold=${encodeURIComponent(n)}`;C.disabled=!0,C.textContent="获取中…",p("正在向服务器请求推荐词汇…","info");try{const o=await lt(r),c=Array.isArray(o?.practiced)?o.practiced.map(i=>i.term).filter(Boolean):[],a=Array.isArray(o?.fresh)?o.fresh.map(i=>i.term).filter(Boolean):[];if(!c.length&&!a.length){p("未获取到符合条件的词汇，请调整参数。","warn");return}const u=[];c.length&&u.push(c.join(", ")),a.length&&u.push(a.join(", ")),rt.value=u.join(`

`),p(`已填入 ${c.length} 个练习词与 ${a.length} 个新词`,"ok"),localStorage.setItem("score-api-url",s)}catch(o){console.error("[Auto Fill Words] 获取失败:",o),p(`获取推荐词汇失败：${o.message}`,"warn")}finally{C.disabled=!1,C.textContent="🎯 自动取词"}}function mt(){const t=At?.value?.trim(),e=bt?.value?.trim(),n=Et?.value?.trim(),s=localStorage.getItem("ai-api-url"),r=localStorage.getItem("ai-api-key"),o=localStorage.getItem("ai-model"),c=(t||s||"").trim(),a=(e||r||"").trim(),u=(n||o||"gpt-3.5-turbo").trim()||"gpt-3.5-turbo";return t!==void 0&&(t?localStorage.setItem("ai-api-url",t):localStorage.removeItem("ai-api-url")),e!==void 0&&(e?localStorage.setItem("ai-api-key",e):localStorage.removeItem("ai-api-key")),n!==void 0&&(n?localStorage.setItem("ai-model",n):localStorage.removeItem("ai-model")),{apiUrl:c,apiKey:a,model:u}}function zt(t){const e=[...t];for(let n=e.length-1;n>0;n--){const s=Math.floor(Math.random()*(n+1));[e[n],e[s]]=[e[s],e[n]]}return e}function Wt(t){return`请为英语学习者写一篇英文短文，使用 Markdown 段落格式（可自行分段，但不要添加标题、前言或代码块）。严格遵守下列规则：

**A. 标注与频次**

* 仅对目标词加粗，形式为 **word**；除目标词外不得使用粗体。
* 每个目标词至少出现一次；可按语境变化词形，并对变化后的词形加粗。
* **每句最多出现一个目标词**；禁止在同一句用并列（如 “X and Y” 或 “X, Y, and Z”）放入多个目标词。

**B. 语义分散与防“扎堆”**

* **同义、近义、反义、同词根或同一语义场的目标词，彼此之间至少间隔 ≥2 句**；不得出现在相邻句或同一句。
* 若两词常作并列形容或可互换使用，只在不同句中出现，且置于不同话题或功能（如一个作描述，另一个用于行动或结果）。

**C. 连贯性与结构（重点）**

* 先在内部拟定“三段式叙事”但**不输出大纲**：
  1）开端：交代时间、地点、人物与目标；
  2）发展：行动、阻碍与抉择；
  3）结尾：结果或反思，呼应目标。
* 全文保持**同一组人物/地点/目标**贯穿；不要无提示地更换场景或人物。
* **句际逻辑**清晰：每句与上一句构成时间顺序、因果、递进或转折关系。必要时在句首使用 then, later, because, however, therefore, eventually 等连接词（适量使用）。
* 禁止清单式、口号式或与主线无关的跳转；避免模板化重复句式。

**D. 语境暗示，禁止定义式写法**

* 禁止 “**X** is/means/refers to/also called/defined as …” 等定义句；禁止在目标词所在句用括号、破折号、同位语或 “i.e./such as/for example” 给出直白解释或同义替换。
* 不给出中文释义或直译提示词；通过动作、结果、感受、对话或情境**间接**表达含义。

**E. 篇幅与段落**

* 句子数应 ≥ 目标词数量，优先采用“一词一句”。

**F. 输出**

* **仅输出文章正文**，保留 Markdown 段落与粗体标记；不要添加任何额外说明、标题、列表或 JSON。

目标词汇（顺序随机）：

${t.map((n,s)=>`${s+1}. ${n}`).join(`
`)}`}function Yt(t,e){const n=e.map((s,r)=>`${r+1}. ${s}`).join(`
`);return`请阅读下方的英文文章，并根据提供的目标词汇列表，指出文章中每个词汇的实际写法。

输出一个 JSON 对象，格式如下：
{
  "pairs": [
    {"original": "目标词汇", "used": "文章中的实际写法（去掉**，若未出现则留空字符串）"}
  ]
}

要求：
- original 必须与提供的目标词汇完全一致；
- used 为文章中出现的具体形式（保留大小写/单复数等变化，但去掉任何 Markdown ** 标记）；
- 如果某个词未在文章中出现，将 used 设为空字符串。

英文文章：
"""
${t}
"""

目标词汇列表：
${n}`}function et(t){return typeof t!="string"?"":t.replace(/\*\*/g,"").trim()}function Xt(t,e){const n=(e||[]).map(i=>({original:i,used:i}));if(!t)return n;let s=t.trim();if(!s)return n;let r=null;const o=s.match(/```(?:json)?([\s\S]*?)```/i);if(o)r=o[1].trim();else{const i=s.match(/\{[\s\S]*\}/);i&&(r=i[0])}let c=[];if(r)try{const i=JSON.parse(r);c=(Array.isArray(i?.pairs)?i.pairs:Array.isArray(i)?i:[]).map(d=>{if(!d||typeof d!="object")return null;const g=typeof d.original=="string"?d.original.trim():"",m=et(d.used??"");return g?{original:g,used:m||""}:null}).filter(Boolean)}catch(i){console.warn("[Variant Mapping] JSON解析失败，尝试解析纯文本格式",i),c=[]}if(!c.length){const i=s.split(/\n+/).map(l=>l.trim()).filter(Boolean);for(const l of i){const d=l.match(/^(.+?)\s*(?:=>|->|：|:|=)\s*(.+)$/);if(!d)continue;const g=d[1].trim(),m=et(d[2]);g&&c.push({original:g,used:m})}}const a=new Map;for(const i of c){const l=typeof i.original=="string"?i.original.trim():"";if(!l)continue;const d=l.toLowerCase(),g=et(i.used||l);a.has(d)||a.set(d,{original:l,used:g||l})}const u=[];for(const i of e||[]){const l=i.trim().toLowerCase(),d=a.get(l),g=d?d.used:i;u.push({original:i,used:g})}return u}async function Zt(t,e,n,s,r){const o=Yt(s,r),c={model:n,messages:[{role:"system",content:"You are an assistant that extracts vocabulary mappings and responds with concise JSON."},{role:"user",content:o}],temperature:0,max_tokens:3e3};console.log("[Variant Mapping] 请求体:",JSON.stringify(c,null,2));const a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(c)});if(console.log("[Variant Mapping] 响应状态:",a.status,a.statusText),!a.ok){const d=await a.text();throw console.error("[Variant Mapping] API错误响应:",d),new Error(`词形映射请求失败: ${a.status} ${a.statusText}: ${d}`)}const u=await a.json();console.log("[Variant Mapping] API响应:",u);const i=u?.choices?.[0]?.message;if(!i)throw new Error("词形映射响应格式异常");const l=K(i);return console.log("[Variant Mapping] AI回复:",l),Xt(l,r)}async function Qt(){if(!A)return;const t=Ft(rt?.value||"");if(!t.length){p("请至少输入一个目标词汇","warn"),rt?.focus();return}const{apiUrl:e,apiKey:n,model:s}=mt();if(!e||!n){p("请先在右侧配置AI API地址与Key","warn");return}const r=A.dataset.originalText||A.textContent;try{A.disabled=!0,A.dataset.originalText=r,A.textContent="生成中…",p("正在请求AI生成文章…","info");const o=zt(t),c=Wt(o),a={model:s,messages:[{role:"system",content:"You are an expert science writer who produces fluent, engaging English articles in Markdown without extra commentary."},{role:"user",content:c}],temperature:.65,top_p:.9,max_tokens:Math.min(1200,Math.round(Gt*4.2))};console.log("[Article Generator] 请求体:",JSON.stringify(a,null,2));const u=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(a)});if(!u.ok){const $=await u.text();throw new Error(`API请求失败: ${u.status} ${u.statusText} | ${$}`)}const i=await u.json();console.log("[Article Generator] API响应:",i);const l=i?.choices?.[0]?.message;if(!l)throw new Error("AI未返回文章内容");const d=K(l);if(!d)throw new Error("AI未返回文章内容");P.value=d.trim();let g,m=!1;try{if(p("文章生成成功，正在分析词形映射…","info"),g=await Zt(e,n,s,d,t),!Array.isArray(g)||!g.length)throw new Error("未获得有效的词形映射")}catch($){console.error("[Article Generator] 词形映射失败:",$),g=t.map(E=>({original:E,used:E})),p("文章生成完成，但词形映射失败，已使用原始词汇。","warn"),I("词形映射失败，已使用原始词汇","warn"),m=!0}console.log("[Article Generator] 最终词形映射:",g),ft(d,g),X();const b=Jt(d,t,g);if(b.length){const $=`⚠️ 已生成文章，但缺少 ${b.length} 个词：${b.join("，")}`;p($,"warn"),I("生成完成，但存在缺失词汇，请手动补充。","warn")}else m||(p("AI文章生成完成，词汇与词形均已覆盖 ✓","ok"),I("文章生成成功并包含全部目标词汇！","ok"));await vt({quiet:!0})}catch(o){console.error("[Article Generator] 生成文章失败:",o),p(`生成失败：${o.message}`,"warn")}finally{A.disabled=!1,A.textContent=A.dataset.originalText||"✨ AI生成文章"}}function ft(t,e=[]){try{R=typeof t=="string"?t:"",jt(e);const n=te(t);ot.innerHTML=n,ee(t),ne(),L.buildList(w),N.textContent="文章保存成功！",N.style.color="var(--ok)"}catch(n){N.textContent="处理文章内容时出错: "+n.message,N.style.color="var(--warn)"}}function te(t){return t.split(`

`).map(s=>`<p>${s.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function ee(t){const e=/\*\*(.*?)\*\*/g,n=[],s=new Set;let r;for(;(r=e.exec(t))!==null;){const o=r[1]?.trim();if(!o)continue;const c=gt(o)||o;St(c,o),s.has(c)||(s.add(c),n.push(c))}w=n}function ne(){if(M.clear(),!ot)return;ot.querySelectorAll("p").forEach(e=>{const n=e.textContent?e.textContent.replace(/\s+/g," ").trim():"";if(!n)return;e.querySelectorAll("strong").forEach(r=>{const o=r.textContent?r.textContent.trim():"";if(!o)return;const c=gt(o)||o;if(!c||M.has(c))return;const a=oe(n,o)||n;M.set(c,a)})})}function oe(t,e){if(!t||!e)return"";const n=t.replace(/\s+/g," ").trim(),s=e.trim().toLowerCase(),r=n.match(/[^。！？!?\.]+[。！？!?\.]?/g)||[n];for(const o of r)if(o.toLowerCase().includes(s))return o.trim();return n}function re(){dt.classList.add("active"),ut.classList.remove("active"),It.style.display="block",xt.style.display="none"}function X(){dt.classList.remove("active"),ut.classList.add("active"),It.style.display="none",xt.style.display="block"}dt.addEventListener("click",re);ut.addEventListener("click",X);kt.addEventListener("click",()=>{const t=P.value;t.trim()?(ft(t),X()):(N.textContent="请输入文章内容",N.style.color="var(--warn)")});A&&A.addEventListener("click",Qt);C&&C.addEventListener("click",t=>{t.preventDefault(),Kt()});y&&y.addEventListener("click",async()=>{const t=Ut();if(!t.length){h("请先完成AI判题后再同步。","warn"),I("没有可同步的判题分数","warn");return}const e=Y(),n=e.replace(/\/$/,"")+"/api/word-scores",s=qt(),r=y.dataset.originalText||y.textContent;y.dataset.originalText=r,y.disabled=!0,y.textContent="同步中…",h("正在同步判题结果到服务器…","info");try{const o=await lt(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({results:t,article:s})}),c=Array.isArray(o?.scores)?o.scores:[];W(c);const a=o?.updated??t.length,u=o?.session_id,i=u?`（历史记录 #${u} 已生成）`:"";h(`同步成功，已更新 ${a} 个词汇${i}`,"ok"),I(u?`同步完成！历史记录 #${u}`:"服务器词表已更新 ✓","ok"),localStorage.setItem("score-api-url",e)}catch(o){console.error("[Sync Scores] 同步失败:",o),h(`同步失败：${o.message}`,"warn"),I("同步失败："+o.message,"warn")}finally{y.disabled=!1,y.textContent=y.dataset.originalText||"⬆️ 同步到服务器"}});function se(t){const e=document.getElementById(V(t));if(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus();const n=e.closest(".item");n&&(n.style.outline="2px solid var(--accent-2)",n.style.boxShadow="0 0 0 4px rgba(137,220,235,.25)",setTimeout(()=>{n.style.outline="",n.style.boxShadow=""},1500))}}L.buildList(w);D.addEventListener("click",t=>{const e=t.target;if(e.classList.contains("jump"))at(e.dataset.term);else if(e.classList.contains("term")||e.parentElement.classList.contains("term")){const n=e.dataset.term||e.parentElement.dataset.term;n&&at(n)}});wt.addEventListener("input",()=>L.buildList(w));D.addEventListener("focus",t=>{t.target.tagName==="INPUT"&&t.target.dataset.term&&at(t.target.dataset.term)},!0);document.getElementById("article-content").addEventListener("click",t=>{if(t.target.tagName==="STRONG"){const e=t.target.textContent.trim(),n=gt(e);n&&w.includes(n)&&se(n)}});const $t="geo_vocab_answers_v1";function Lt(){const t={};for(const e of w){const n=document.getElementById(V(e));t[e]=n&&n.value||""}return t}function ae(t){if(t){for(const e of w){const n=document.getElementById(V(e));n&&e in t&&(n.value=t[e]||"")}L.updateFilledState(w)}}function Tt(){try{const t=Lt();localStorage.setItem($t,JSON.stringify(t)),L.updateFilledState(w)}catch(t){console.warn("[Persist Answers] 保存失败:",t)}}let H=null;function ie(){H&&clearTimeout(H),H=setTimeout(()=>{H=null,Tt()},300)}try{const t=JSON.parse(localStorage.getItem($t)||"null");ae(t)}catch{}D.addEventListener("input",t=>{const e=t.target;e instanceof HTMLInputElement&&e.dataset.term&&(ie(),L.updateFilledState(w))});document.getElementById("clear").addEventListener("click",()=>{for(const t of w){const e=document.getElementById(V(t));e&&(e.value="")}Tt(),L.updateFilledState(w),I("已清空输入","warn")});function I(t,e){const n=document.createElement("div");n.textContent=t,n.style.position="fixed",n.style.right="18px",n.style.bottom="18px",n.style.background="rgba(10,15,30,.95)",n.style.border="1px solid rgba(122,162,247,.3)",n.style.color=e==="ok"?"var(--ok)":e==="warn"?"var(--warn)":"var(--text)",n.style.padding="10px 12px",n.style.borderRadius="10px",n.style.boxShadow="0 6px 18px var(--shadow)",document.body.appendChild(n),setTimeout(()=>n.remove(),2200)}let O=!1;const B=document.getElementById("ai-config"),q=document.getElementById("ai-results"),nt=document.getElementById("ai-progress"),le=document.getElementById("progress-fill"),yt=document.getElementById("progress-text"),it=document.getElementById("score-summary"),G=document.getElementById("ai-identity-check");document.getElementById("ai-grade").addEventListener("click",async()=>{if(B.style.display==="none"){B.style.display="block",p("");const t=localStorage.getItem("ai-api-url"),e=localStorage.getItem("ai-api-key"),n=localStorage.getItem("ai-model")||"gpt-3.5-turbo";t&&(document.getElementById("api-url").value=t),e&&(document.getElementById("api-key").value=e),document.getElementById("ai-model").value=n;const s=localStorage.getItem("score-api-url");F&&(F.value=s||F.value||"http://localhost:4000"),W([]),h("同步后将显示本次提交的词汇成绩","info")}else B.style.display="none"});G.addEventListener("click",async()=>{const{apiUrl:t,apiKey:e,model:n}=mt();if(!t||!e){alert(`请先配置API地址和Key！

点击"🤖 AI工具箱"按钮进行配置。`);return}G.textContent="🔍 检测中...",G.disabled=!0;try{const s=await fe(t,e,n);alert(`AI身份信息：

${s}`)}catch(s){alert(`AI身份检测失败：

${s.message}`)}finally{G.textContent="🔍 检测AI身份",G.disabled=!1}});document.getElementById("cancel-grade").addEventListener("click",()=>{B.style.display="none",O=!1});f&&f.addEventListener("click",async()=>{const{apiUrl:t,apiKey:e,model:n}=mt();if(!t||!e){B.style.display="block",I("请填写API地址和Key","warn");return}const s=f.dataset.originalText||f.textContent;f.dataset.originalText=s,j("判题准备中…",!0);try{await ce(t,e,n)}finally{setTimeout(Ht,600)}});async function ce(t,e,n="gpt-3.5-turbo"){if(console.log("[Main Grading] 开始AI判题流程"),console.log("[Main Grading] API URL:",t),console.log("[Main Grading] 模型:",n),console.log("[Main Grading] API Key 长度:",e?e.length:0),O){console.warn("[Main Grading] 判题已在进行中，跳过");return}O=!0,nt.style.display="block",q.style.display="none",Mt();try{const s=Lt();console.log("[Main Grading] 收集的数据:",s);const r=w.filter(i=>s[i]&&s[i].trim());if(console.log("[Main Grading] 已填写的词汇:",r),console.log("[Main Grading] 已填写词汇数量:",r.length),r.length===0){console.warn("[Main Grading] 没有填写的词汇"),I("请先填写一些答案","warn"),O=!1,nt.style.display="none";return}yt.textContent=`开始判题... (共${r.length}个词)`,f&&j(`判题中 0/${r.length}`,!0);const o=50,c=[];for(let i=0;i<r.length;i+=o)c.push(r.slice(i,i+o));console.log("[Main Grading] 分批处理:",c.length,"个批次");let a=0;const u={};for(let i=0;i<c.length;i++){const l=c[i];console.log(`[Main Grading] 处理第${i+1}批:`,l),yt.textContent=`正在处理第${i+1}/${c.length}批 (${l.length}个词)...`;try{const d=await de(l,s,t,e,n);console.log(`[Main Grading] 第${i+1}批结果:`,d),Object.assign(u,d),a+=l.length;const g=a/r.length*100;if(le.style.width=g+"%",console.log(`[Main Grading] 进度: ${g}% (${a}/${r.length})`),f){const m=Math.round(g);j(`判题中 ${a}/${r.length} (${m}%)`,!0)}i<c.length-1&&(console.log("[Main Grading] 等待1秒避免频率限制"),await new Promise(m=>setTimeout(m,1e3)))}catch(d){console.error(`[Main Grading] 第${i+1}批处理失败:`,d),I(`第${i+1}批处理失败: ${d.message}`,"warn")}}console.log("[Main Grading] 所有批次处理完成，最终结果:",u),Ct(u,r.length),f&&j("判题完成 ✓",!0)}catch(s){console.error("[Main Grading] 判题过程错误:",s),I("判题过程中出现错误: "+s.message,"warn"),f&&j("判题失败",!0)}finally{O=!1,nt.style.display="none",console.log("[Main Grading] 判题流程结束")}}async function de(t,e,n,s,r="gpt-3.5-turbo"){console.log("[Batch Grading] 开始处理批次:",t),console.log("[Batch Grading] 使用模型:",r);const o=ge(t,e);console.log("[Batch Grading] 生成的提示词:",o);const c={model:r,messages:[{role:"user",content:o}],temperature:.1};console.log("[Batch Grading] 请求体:",JSON.stringify(c,null,2));const a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(c)});if(console.log("[Batch Grading] 响应状态:",a.status,a.statusText),!a.ok){const g=await a.text();throw console.error("[Batch Grading] API错误响应:",g),new Error(`API请求失败: ${a.status} ${a.statusText}: ${g}`)}const u=await a.json();console.log("[Batch Grading] API响应:",u);const i=u?.choices?.[0]?.message;if(!i)throw console.error("[Batch Grading] 响应格式异常:",u),new Error("API响应格式异常");const l=K(i);console.log("[Batch Grading] AI回复内容:",l);const d=me(l,t);return console.log("[Batch Grading] 解析结果:",d),d}function ue(t){const e=typeof t=="number"?t:parseFloat(t);if(!Number.isFinite(e))return null;const n=Math.min(Math.max(e,0),1);return Math.round(n*1e3)/1e3}function ge(t,e){return`你是一名精通中英文术语的教师，需要判断学生给出的中文翻译与英文术语的语义相似度。请聚焦词义本身，不要贴合特定学科背景或冷僻知识。

请对每个词汇：
1. 给出最标准、最常用的中文翻译（可包含多个词，确保含义准确）。
2. 评估学生答案与标准答案在语义上的相似度，相似度用 0~1 的小数表示：0 代表完全错误，1 代表完全一致。允许保留三位小数。
   - 若学生答案涵盖了主要含义或提供了常见近义词，即使未列出全部释义，也应给予较高分（例如 ≥0.7）。
3. 如有需要，可给出简短说明（10~25个字），解释主要差异或匹配亮点。

在评估时请结合提供的原文语境理解术语的含义，以该语境为准判断学生翻译的准确度。

评分基准示例：
- 学生答案「极点」，标准答案「杆；极点；电极」→ 1.0 分（核心含义完全对应）
- 学生答案「烟」，标准答案「烟雾」→ 0.7 分（传达主要概念，细节略缺）
- 学生答案「平坦的」，标准答案「平原」→ 0.5 分（相关但偏向形容词，需要指出语义差异）

务必只输出 JSON，不要解释。JSON 格式如下：
{
  "英文词汇": {
    "标准答案": "标准中文翻译",
    "相似度": 0.000,
    "说明": "可选，若无则留空字符串"
  }
}

待评估的词汇与学生答案：
${t.map(s=>{const o=(M.get(s)||"（原文未提供语境）").replace(/\s+/g," ").trim(),c=e[s]&&e[s].trim()?e[s].trim():"(空白)";return`- 英文词汇: ${s}
  原文语境: ${o}
  学生翻译: ${c}`}).join(`
`)}`}function me(t,e){console.log("[Parse Response] 开始解析AI回复:",t),console.log("[Parse Response] 需要解析的词汇:",e);try{const n=t.match(/\{[\s\S]*\}/);if(console.log("[Parse Response] JSON匹配结果:",n?n[0]:"null"),!n)throw console.warn("[Parse Response] 未找到JSON格式，使用fallback解析"),new Error("无法解析AI回复格式");const s=JSON.parse(n[0]);console.log("[Parse Response] JSON解析成功:",s);const r={};return e.forEach(o=>{console.log(`[Parse Response] 处理词汇: ${o}`);const c=s[o]||s[o.trim()]||null;if(c&&typeof c=="object"){const a=c.相似度??c.similarity??c.score,u=ue(typeof a=="string"?parseFloat(a):a),i=(c.标准答案??c.正确答案??"").toString().trim(),l=(c.说明??c.解释??"").toString().trim();r[o]={similarity:typeof u=="number"?u:null,standardAnswer:i||null,explanation:l||null},console.log(`[Parse Response] ${o} 解析成功 - 相似度:`,r[o].similarity,"标准答案:",r[o].standardAnswer,"说明:",r[o].explanation)}else if(typeof c=="string"){const a=c==="正确";r[o]={similarity:a?1:0,standardAnswer:null,explanation:null},console.log(`[Parse Response] ${o} 使用旧格式字符串 - 相似度模拟:`,r[o].similarity)}else console.log(`[Parse Response] ${o} 未在解析结果中找到，使用fallback`),r[o]={similarity:null,standardAnswer:null,explanation:null}}),console.log("[Parse Response] 最终解析结果:",r),r}catch(n){console.error("[Parse Response] JSON解析失败:",n),console.log("[Parse Response] 使用fallback解析方法");const s={};return e.forEach(r=>{const o=r.toLowerCase(),c=t.toLowerCase();s[r]={similarity:c.includes(o)?.5:null,standardAnswer:null,explanation:null},console.log(`[Parse Response] ${r} fallback结果 - 相似度: ${s[r].similarity}`)}),console.log("[Parse Response] Fallback最终结果:",s),s}}function Ct(t,e,n={}){const{suppressToast:s=!1}=n||{};U=t||{};const r=Object.values(t).map(l=>typeof l.similarity=="number"?l.similarity:null).filter(l=>l!==null),o=r.length?Math.round(r.reduce((l,d)=>l+d,0)/r.length*100)/100:0,c=r.filter(l=>l>=J).length,a=r.filter(l=>l<J&&l>=tt).length,u=J.toFixed(2),i=tt.toFixed(2);it.innerHTML=`
    <div>判题完成！</div>
    <div class="score-line">
      <span>平均相似度：<strong>${o.toFixed(2)}</strong></span>
      <span>高匹配(≥${u}): <strong>${c}</strong></span>
      <span>中等匹配(≥${i}): <strong>${a}</strong></span>
      <span>总词数: <strong>${e}</strong></span>
    </div>
  `,Object.entries(t).forEach(([l,d])=>{const g=document.querySelector(`[data-term="${l}"]`)?.closest(".item");if(!g)return;g.classList.remove("correct","incorrect","partial");const m=typeof d.similarity=="number"?d.similarity:null;let b="incorrect";m!==null&&(m>=J?b="correct":m>=tt&&(b="partial")),g.classList.add(b);const $=g.querySelector(".term");if(!$)return;let E=$.querySelector(".grade-indicator");E||(E=document.createElement("span"),E.className="grade-indicator",$.appendChild(E)),E.className=`grade-indicator ${b}`,E.textContent=m!==null?m.toFixed(2):"—",E.title="语义相似度 (0-1)";let S=g.querySelector(".grading-details");if(S||(S=document.createElement("div"),S.className="grading-details",g.appendChild(S)),S.innerHTML="",m!==null){const x=document.createElement("div"),T=document.createElement("strong");T.textContent="相似度:",x.appendChild(T),x.appendChild(document.createTextNode(" "+m.toFixed(2))),S.appendChild(x)}if(d.standardAnswer){const x=document.createElement("div"),T=document.createElement("strong");T.textContent="标准答案:",x.appendChild(T),x.appendChild(document.createTextNode(" "+d.standardAnswer)),S.appendChild(x)}if(d.explanation){const x=document.createElement("div"),T=document.createElement("strong");T.textContent="说明:",x.appendChild(T),x.appendChild(document.createTextNode(" "+d.explanation)),S.appendChild(x)}S.hasChildNodes()||S.remove()}),q.style.display="block",B.style.display="none",s||I(`判题完成！平均相似度 ${o.toFixed(2)}`,"ok")}function Mt(){U={},document.querySelectorAll(".item").forEach(t=>{t.classList.remove("correct","incorrect","partial");const e=t.querySelector(".grade-indicator");e&&e.remove();const n=t.querySelector(".grading-details");n&&n.remove()})}async function fe(t,e,n="gpt-3.5-turbo"){console.log("[AI Identity] 开始检测AI身份"),console.log("[AI Identity] API URL:",t),console.log("[AI Identity] 模型:",n),console.log("[AI Identity] API Key 长度:",e?e.length:0);const s={model:n,messages:[{role:"user",content:"你好，请详细介绍一下你自己，包括你的名称、版本、主要功能和特色。"}],temperature:.1,max_tokens:200};console.log("[AI Identity] 请求体:",JSON.stringify(s,null,2));const r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(s)});if(console.log("[AI Identity] 响应状态:",r.status,r.statusText),!r.ok){const u=await r.text();throw console.error("[AI Identity] API错误响应:",u),new Error(`${r.status} ${r.statusText}: ${u}`)}const o=await r.json();console.log("[AI Identity] API响应:",o);const c=o?.choices?.[0]?.message;if(!c)throw console.error("[AI Identity] 响应格式异常:",o),new Error("API响应格式异常");const a=K(c);if(!a)throw console.error("[AI Identity] 未获得文本回复:",c),new Error("AI未返回文本信息");return console.log("[AI Identity] AI回复:",a),a}async function pe(t){const e=Number(t);if(!Number.isInteger(e)||e<=0){h(`无法识别的历史记录编号：${t}`,"warn");return}const n=Y();if(!n){h("请先配置服务器地址再加载历史记录。","warn");return}const s=`${n.replace(/\/$/,"")}/api/sessions/${e}`;h(`正在加载历史记录 #${e}…`,"info");try{const r=await fetch(s,{headers:{Accept:"application/json"}});if(!r.ok){const l=await r.text();throw new Error(`HTTP ${r.status} ${r.statusText}: ${l}`)}const o=await r.json(),c=o?.session||{},a=Array.isArray(o?.results)?o.results:[],u=typeof c.article=="string"?c.article:"";typeof R<"u"&&(R=u),P&&(P.value=u),ft(u||"",[]),X();const i={};if(a.forEach(l=>{if(!l||typeof l.term!="string")return;const d=l.term.trim();if(!d)return;const g=typeof l.similarity=="number"?l.similarity:Number(l.similarity),m=l.standard_answer||l.standardAnswer||null,b=l.explanation||null;i[d]={similarity:Number.isFinite(g)?g:null,standardAnswer:m,explanation:b},l.context&&M&&M.set(d,l.context)}),Object.keys(i).length?Ct(i,c.total_terms||a.length,{suppressToast:!0}):(Mt(),q.style.display="none"),it){const l=c.submitted_at?new Date(c.submitted_at):null,d=typeof c.avg_similarity=="number"?c.avg_similarity:Number(c.avg_similarity),g=[];l&&!Number.isNaN(l.getTime())&&g.push(`提交时间：${l.toLocaleString()}`),g.push(`总词数：${c.total_terms??a.length}`),Number.isFinite(d)&&g.push(`平均相似度：${d.toFixed(2)}`),g.push(`正确 / 部分正确 / 错误：${c.correct_terms??0} / ${c.partial_terms??0} / ${c.incorrect_terms??0}`),it.insertAdjacentHTML("beforeend",`<div class="score-line history-note">${g.join(" ｜ ")}</div>`)}q.style.display="block",B.style.display="none",h(`已加载历史记录 #${e}，如需重新练习可直接编辑文章。`,"ok"),document.body.classList.add("replay-mode")}catch(r){console.error("[History Replay] 加载历史记录失败:",r),h(`加载历史记录失败：${r.message}`,"warn"),I("加载历史记录失败："+r.message,"warn")}}const ht=new URLSearchParams(window.location.search).get("session");ht&&pe(ht);
