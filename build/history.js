const v=document.getElementById("history-status"),g=document.getElementById("history-session-list"),P=document.getElementById("history-refresh"),h=document.getElementById("history-score-api"),H=document.getElementById("history-detail-empty"),R=document.getElementById("history-detail-content"),Q=document.getElementById("history-detail-title"),X=document.getElementById("history-detail-meta"),j=document.getElementById("history-article"),M=document.getElementById("history-results-body"),O=document.getElementById("history-open-session"),u=document.getElementById("history-copy-low"),A=document.getElementById("history-results-head"),$=document.getElementById("history-chart"),S=document.getElementById("history-chart-empty"),C=new Map;let m=[],D=[],L="term",x=!0,T=[];function f(e,t="info"){v&&(v.textContent=e||"",v.classList.remove("ok","warn"),t==="ok"&&v.classList.add("ok"),t==="warn"&&v.classList.add("warn"))}function I(){const e=h?.value?.trim();if(e)return localStorage.setItem("score-api-url",e),e;const t=localStorage.getItem("score-api-url");if(t)return h&&(h.value=t),t;const s="http://localhost:4000";return h&&(h.value=s),s}function q(e){if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}function k(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Z(e){return Number.isFinite(e)?e>=.85?"correct":e>=.6?"partial":"incorrect":"unknown"}function tt(e){if(!g)return;if(!Array.isArray(e)||!e.length){g.innerHTML='<li class="history-session-item empty">暂无历史记录，请先同步一次判题结果。</li>';return}const t=e.map(s=>{const r=q(s.submitted_at),n=Number(s.incorrect_terms)||0,o=Number(s.partial_terms)||0,i=Number(s.total_terms)||0,c=Number(s.avg_similarity),d=Number.isFinite(c)?c.toFixed(2):"—",a=n>0?"warn":"ok";return`
      <li class="history-session-item" data-id="${s.id}">
        <button type="button" class="history-session-button">
          <div class="history-session-row">
            <span class="history-session-id">#${s.id}</span>
            <span class="history-session-date">${k(r)}</span>
          </div>
          <div class="history-session-row small ${a}">
            <span>词数：${i}</span>
            <span>错误：${n}</span>
            <span>部分正确：${o}</span>
            <span>平均：${d}</span>
          </div>
        </button>
      </li>
    `}).join("");g.innerHTML=t}async function V({autoSelect:e=!1}={}){try{f("正在载入历史记录…","info");const s=`${I().replace(/\/$/,"")}/api/sessions?limit=100`,r=await fetch(s,{headers:{Accept:"application/json"}});if(!r.ok){const i=await r.text();throw new Error(`HTTP ${r.status} ${r.statusText}: ${i}`)}const n=await r.json(),o=Array.isArray(n.sessions)?n.sessions:[];tt(o),f(`已载入 ${o.length} 条历史记录`,"ok"),e&&o.length&&J(Number(o[0].id))}catch(t){console.error("[History] 获取历史记录失败:",t),f(`加载失败：${t.message}`,"warn"),g.innerHTML='<li class="history-session-item empty warn">无法加载历史记录。</li>'}}async function K(e=7){try{const s=`${I().replace(/\/$/,"")}/api/stats/daily?days=${encodeURIComponent(e)}`,r=await fetch(s,{headers:{Accept:"application/json"}});if(!r.ok){const i=await r.text();throw new Error(`HTTP ${r.status} ${r.statusText}: ${i}`)}const n=await r.json(),o=Array.isArray(n.stats)?n.stats:[];T=nt(o,e),S&&S.classList.toggle("hidden",T.some(i=>i.practiced||i.below_zero||i.above_two)),G(T)}catch(t){console.error("[History] 获取每日统计失败:",t),S&&(S.classList.remove("hidden"),S.textContent=`无法加载趋势数据：${t.message}`)}}function et(e=""){return typeof e!="string"||!e.trim()?"<p>（无文章内容记录）</p>":e.split(/\n\n+/).map(r=>`<p>${r.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}</p>`).join(`
`)}function st(e){const t=Array.isArray(e)?[...e]:[],s=x?1:-1;return t.sort((r,n)=>{switch(L){case"similarity":{const o=Number(r?.similarity),i=Number(n?.similarity),c=Number.isFinite(o),d=Number.isFinite(i);return!c&&!d?0:c?d?o===i?(r.term||"").localeCompare(n.term||"")*s:(o-i)*s:-1*s:1*s}case"standard":{const o=(r?.standard_answer||r?.standardAnswer||"").toString(),i=(n?.standard_answer||n?.standardAnswer||"").toString(),c=o.localeCompare(i,"zh",{sensitivity:"base"});return c===0?(r.term||"").localeCompare(n.term||"")*s:c*s}case"explanation":{const o=(r?.explanation||"").toString(),i=(n?.explanation||"").toString(),c=o.localeCompare(i,"zh",{sensitivity:"base"});return c===0?(r.term||"").localeCompare(n.term||"")*s:c*s}case"term":default:return(r?.term||"").localeCompare(n?.term||"","en",{sensitivity:"base"})*s}}),t}function z(){if(!A)return;A.querySelectorAll("th[data-sort]").forEach(t=>{const s=t.dataset.sort;s&&(t.classList.add("sortable"),s===L?(t.classList.add("active"),t.dataset.indicator=x?"↑":"↓"):(t.classList.remove("active"),t.dataset.indicator=""))})}function Y(){if(!M)return;const e=st(D);if(!e.length){M.innerHTML='<tr><td colspan="4" class="empty">未记录判题结果。</td></tr>',m=[],u&&(u.disabled=!0,u.textContent="复制 ≤0.5 词"),z();return}const t=e.map(s=>{const r=k(s.term),n=typeof s.similarity=="number"?s.similarity:Number(s.similarity),o=Number.isFinite(n)?n.toFixed(2):"—",i=Z(Number.isFinite(n)?n:NaN),c=k(s.standard_answer||s.standardAnswer||""),d=k(s.explanation||"");return`
      <tr class="history-result-${i}">
        <td>${r||"—"}</td>
        <td>${o}</td>
        <td>${c||"—"}</td>
        <td>${d||"—"}</td>
      </tr>
    `}).join("");M.innerHTML=t,m=e.filter(s=>{if(!s||typeof s.term!="string")return!1;const r=typeof s.similarity=="number"?s.similarity:Number(s.similarity);return Number.isFinite(r)&&r<=.5}).map(s=>s.term.trim()).filter(Boolean),u&&(m.length?(u.disabled=!1,u.textContent=`复制 ≤0.5 词 (${m.length})`):(u.disabled=!0,u.textContent="暂无低分词")),z()}function rt(e){if(!e)return null;const t=window.devicePixelRatio||1,s=e.getBoundingClientRect();e.width=s.width*t,e.height=s.height*t;const r=e.getContext("2d");return r&&r.scale(t,t),r}function G(e){if(!$)return;const t=rt($);if(!t)return;if(!e||!e.length){t.clearRect(0,0,$.width,$.height),S&&S.classList.remove("hidden");return}const s=$.getBoundingClientRect().width,r=$.getBoundingClientRect().height;t.clearRect(0,0,s,r);const n=e.map(l=>l.day),o=e.map(l=>Number(l.practiced)||0),i=e.map(l=>Number(l.below_zero)||0),c=e.map(l=>Number(l.above_two)||0),d=Math.max(5,...o,...i,...c),a={top:16,right:24,bottom:32,left:40},b=s-a.left-a.right,p=r-a.top-a.bottom;t.strokeStyle="rgba(147, 161, 161, 0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(a.left,a.top),t.lineTo(a.left,a.top+p),t.lineTo(a.left+b,a.top+p),t.stroke();const F=Math.min(4,d);t.fillStyle="var(--muted)",t.font="12px sans-serif";for(let l=0;l<=F;l++){const w=Math.round(d/F*l),y=a.top+p-p*(w/d);t.fillText(String(w),6,y+4),t.strokeStyle="rgba(147, 161, 161, 0.15)",t.beginPath(),t.moveTo(a.left,y),t.lineTo(a.left+b,y),t.stroke()}n.forEach((l,w)=>{const y=a.left+b/Math.max(1,n.length-1)*w,E=a.top+p+16;t.fillStyle="var(--muted)",t.fillText(l.slice(5),y-18,E)});function B(l,w){t.strokeStyle=w,t.lineWidth=2,t.beginPath(),l.forEach((y,E)=>{const N=a.left+b/Math.max(1,l.length-1)*E,_=a.top+p-p*(y/d);E===0?t.moveTo(N,_):t.lineTo(N,_)}),t.stroke(),l.forEach((y,E)=>{const N=a.left+b/Math.max(1,l.length-1)*E,_=a.top+p-p*(y/d);t.fillStyle=w,t.beginPath(),t.arc(N,_,3,0,Math.PI*2),t.fill()})}B(o,"#268bd2"),B(i,"#dc322f"),B(c,"#859900")}function nt(e,t=7){const s=new Date,r=[];for(let n=t-1;n>=0;n--){const o=new Date(s);o.setDate(s.getDate()-n);const i=o.toISOString().slice(0,10),c=e.find(d=>d.day===i);c?r.push(c):r.push({day:i,practiced:0,below_zero:0,above_two:0})}return r}function U(e){if(!R||!H)return;if(!e||!e.session){m=[],u&&(u.disabled=!0,u.textContent="复制 ≤0.5 词"),R.classList.add("hidden"),H.classList.remove("hidden");return}H.classList.add("hidden"),R.classList.remove("hidden");const{session:t,results:s}=e,r=q(t.submitted_at),n=Number(t.total_terms)||(Array.isArray(s)?s.length:0),o=Number(t.avg_similarity),i=Number.isFinite(o)?o.toFixed(2):"—",c=Number(t.correct_terms)||0,d=Number(t.partial_terms)||0,a=Number(t.incorrect_terms)||0;if(Q.textContent=`历史记录 #${t.id}`,X.textContent=`提交时间：${r} ｜ 总词数：${n} ｜ 平均相似度：${i} ｜ 正确/部分/错误：${c}/${d}/${a}`,O&&(O.href=`geo_vocab_fill_in_webpage_english→chinese.html?session=${t.id}`),j){const b=et(t.article||"");j.innerHTML=b}L="term",x=!0,D=Array.isArray(s)?[...s]:[],Y()}async function J(e){if(!Number.isInteger(e)||e<=0)return;Array.from(g?.querySelectorAll(".history-session-item.active")||[]).forEach(s=>{s.classList.remove("active")});const t=g?.querySelector(`.history-session-item[data-id="${e}"]`);if(t&&t.classList.add("active"),C.has(e)){U(C.get(e));return}try{f(`正在加载记录 #${e}…`,"info");const r=`${I().replace(/\/$/,"")}/api/sessions/${e}`,n=await fetch(r,{headers:{Accept:"application/json"}});if(!n.ok){const i=await n.text();throw new Error(`HTTP ${n.status} ${n.statusText}: ${i}`)}const o=await n.json();C.set(e,o),U(o),f(`已加载记录 #${e}`,"ok")}catch(s){console.error("[History] 加载详情失败:",s),f(`加载记录 #${e} 失败：${s.message}`,"warn")}}h&&h.addEventListener("change",()=>{const e=h.value.trim();e&&localStorage.setItem("score-api-url",e),K(7)});P&&P.addEventListener("click",()=>{C.clear(),V({autoSelect:!1})});g&&g.addEventListener("click",e=>{const t=e.target.closest(".history-session-item");if(!t)return;const s=Number(t.dataset.id);Number.isInteger(s)&&J(s)});A&&A.addEventListener("click",e=>{const t=e.target.closest("th[data-sort]");if(!t)return;const s=t.dataset.sort;s&&D.length&&(L===s?x=!x:(L=s,x=!0),Y())});window.addEventListener("resize",()=>{T.length&&G(T)});function W(e){const t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="fixed",t.style.top="-9999px",document.body.appendChild(t),t.select();let s=!1;try{s=document.execCommand("copy")}catch{s=!1}return document.body.removeChild(t),s}async function ot(){if(!Array.isArray(m)||!m.length){f("当前记录没有相似度 ≤0.5 的词汇","warn");return}const e=m.join(", ");try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(e);else if(!W(e))throw new Error("无法访问剪贴板");f(`已复制 ${m.length} 个词汇到剪贴板`,"ok")}catch(t){W(e)?f(`已复制 ${m.length} 个词汇到剪贴板`,"ok"):f(`复制失败：${t.message}`,"warn")}}u&&u.addEventListener("click",ot);I();K(7);V({autoSelect:!0});
